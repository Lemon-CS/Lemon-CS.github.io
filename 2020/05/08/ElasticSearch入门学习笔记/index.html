<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch入门学习笔记 | Lemon-CS</title><meta name="keywords" content="Elasticsearch,中间件"><meta name="author" content="空白格"><meta name="copyright" content="空白格"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ElasticSearch学习笔记1-简介1.1-什么是ElasticSearch？Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜索"><meta property="og:type" content="article"><meta property="og:title" content="ElasticSearch入门学习笔记"><meta property="og:url" content="https://lemon-cs.github.io/2020/05/08/ElasticSearch%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><meta property="og:site_name" content="Lemon-CS"><meta property="og:description" content="ElasticSearch学习笔记1-简介1.1-什么是ElasticSearch？Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜索"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s3.bmp.ovh/imgs/2022/01/e846e507b0d2ee95.jpeg"><meta property="article:published_time" content="2020-05-08T09:20:10.000Z"><meta property="article:modified_time" content="2022-01-24T17:15:51.882Z"><meta property="article:author" content="空白格"><meta property="article:tag" content="Elasticsearch"><meta property="article:tag" content="中间件"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2022/01/e846e507b0d2ee95.jpeg"><link rel="shortcut icon" href="https://gitee.com/lemon-cs/images/raw/master/Blog.png"><link rel="canonical" href="https://lemon-cs.github.io/2020/05/08/ElasticSearch%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: 空白格",link:"链接: ",source:"来源: Lemon-CS",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ElasticSearch入门学习笔记",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-01-25 01:15:51"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const i=saveToLocal.get("aside-status");void 0!==i&&("hide"===i?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const d=saveToLocal.get("global-font-size");void 0!==d&&document.documentElement.style.setProperty("--global-font-size",d+"px");const r=()=>{GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")};r(),document.addEventListener("pjax:complete",r)})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/constown/HexoCustomFile@0.0.4/dist/css/custom.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./images/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">66</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://s3.bmp.ovh/imgs/2022/01/e846e507b0d2ee95.jpeg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lemon-CS</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch入门学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-08T09:20:10.000Z" title="发表于 2020-05-08 17:20:10">2020-05-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-24T17:15:51.882Z" title="更新于 2022-01-25 01:15:51">2022-01-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">30.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>133分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="ElasticSearch入门学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ElasticSearch学习笔记"><a href="#ElasticSearch学习笔记" class="headerlink" title="ElasticSearch学习笔记"></a>ElasticSearch学习笔记</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1-简介"></a>1-简介</h2><h3 id="1-1-什么是ElasticSearch？"><a href="#1-1-什么是ElasticSearch？" class="headerlink" title="1.1-什么是ElasticSearch？"></a>1.1-什么是ElasticSearch？</h3><p>Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。官方客户端在Java、.NET（C#）、PHP、Python、Apache Groovy、Ruby和许多其他语言中都是可用的。根据DB-Engines的排名显示，Elasticsearch是最受欢迎的企业搜索引擎，其次是Apache Solr，也是基于Lucene。</p><h3 id="1-2-什么是Lucene？"><a href="#1-2-什么是Lucene？" class="headerlink" title="1.2-什么是Lucene？"></a>1.2-什么是Lucene？</h3><p>Lucene 采用了基于倒排表的设计原理，可以非常高效地实现文本查找，在底层采用了分段的存储模式，使它在读写时几乎完全避免了锁的出现，大大提升了读写性能。</p><p>Lucene 可以说是当下最先进、高性能、全功能的搜索引擎库——无论是开源还是私有，但它也仅仅只是一个库。为了充分发挥其功能，你需要使用 Java 并将 Lucene 直接集成到应用程序中。 更糟糕的是，您可能需要获得信息检索学位才能了解其工作原理，因为Lucene 非常复杂。</p><p>为了解决Lucene使用时的繁复性，于是Elasticsearch便应运而生。它使用 Java 编写，内部采用 Lucene 做索引与搜索，但是它的目标是使全文检索变得更简单，简单来说，就是对Lucene 做了一层封装，它提供了一套简单一致的 RESTful API 来帮助我们实现存储和检索。</p><p>当然，Elasticsearch 不仅仅是 Lucene，并且也不仅仅只是一个全文搜索引擎。 它可以被下面这样准确地形容：</p><ul><li>一个分布式的实时文档存储，每个字段可以被索引与搜索；</li><li>一个分布式实时分析搜索引擎；</li><li>能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据。</li></ul><p>由于Elasticsearch的功能强大和使用简单，维基百科、卫报、Stack Overflow、GitHub等都纷纷采用它来做搜索。现在，Elasticsearch已成为全文搜索领域的主流软件之一。</p><h3 id="1-3-ES是如何产生的？"><a href="#1-3-ES是如何产生的？" class="headerlink" title="1.3-ES是如何产生的？"></a>1.3-ES是如何产生的？</h3><h4 id="1-大规模数据如何检索？"><a href="#1-大规模数据如何检索？" class="headerlink" title="1. 大规模数据如何检索？"></a>1. 大规模数据如何检索？</h4><p>如：当系统数据量上了10亿、100亿条的时候，我们在做系统架构的时候通常会从以下角度去考虑问题：</p><ul><li>用什么数据库好？(mysql、sybase、oracle、达梦、神通、mongodb、hbase…)</li><li>如何解决单点故障；(lvs、F5、A10、Zookeep、MQ)</li><li>如何保证数据安全性；(热备、冷备、异地多活)</li><li>如何解决检索难题；(数据库代理中间件：mysql-proxy、Cobar、MaxScale等;)</li><li>如何解决统计分析问题；(离线、近实时)</li></ul><h4 id="2-传统数据库的应对解决方案"><a href="#2-传统数据库的应对解决方案" class="headerlink" title="2. 传统数据库的应对解决方案"></a>2. 传统数据库的应对解决方案</h4><p>对于关系型数据，我们通常采用以下或类似架构去解决查询瓶颈和写入瓶颈：<br><strong>解决要点：</strong></p><ul><li>通过主从备份解决数据安全性问题；</li><li>通过数据库代理中间件心跳监测，解决单点故障问题；</li><li>通过代理中间件将查询语句分发到各个slave节点进行查询，并汇总结果 。</li></ul><h4 id="3-非关系型数据库的解决方案"><a href="#3-非关系型数据库的解决方案" class="headerlink" title="3. 非关系型数据库的解决方案"></a>3. 非关系型数据库的解决方案</h4><p>对于Nosql数据库，以mongodb为例，其它原理类似：<br><strong>解决要点：</strong></p><ul><li>通过副本备份保证数据安全性；</li><li>通过节点竞选机制解决单点问题；</li><li>先从配置库检索分片信息，然后将请求分发到各个节点，最后由路由节点合并汇总结果 。</li></ul><h4 id="4-完全把数据放入内存怎么样？"><a href="#4-完全把数据放入内存怎么样？" class="headerlink" title="4. 完全把数据放入内存怎么样？"></a>4. 完全把数据放入内存怎么样？</h4><p>我们知道，完全把数据放在内存中是不可靠的，实际上也不太现实，当我们的数据达到PB级别时，按照每个节点96G内存计算，在内存完全装满的数据情况下，我们需要的机器是：1PB=1024T=1048576G<br>节点数=1048576/96=10922个<br>实际上，考虑到数据备份，节点数往往在2.5万台左右。成本巨大决定了其不现实！</p><p>从前面讨论我们了解到，把数据放在内存也好，不放在内存也好，都不能完完全全解决问题。<br>全部放在内存速度问题是解决了，但成本问题上来了。<br>为解决以上问题，从源头着手分析，通常会从以下方式来寻找方法：</p><ol><li>存储数据时按有序存储；</li><li>将数据和索引分离；</li><li>压缩数据；</li></ol><p>这就引出了Elasticsearch。</p><h3 id="1-4-什么是全文检索？"><a href="#1-4-什么是全文检索？" class="headerlink" title="1.4-什么是全文检索？"></a>1.4-什么是全文检索？</h3><p>全文检索是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p><p>全文检索的方法主要分为按字检索和按词检索两种。按字检索是指对于文章中的每一个字都建立索引，检索时将词分解为字的组合。对于各种不同的语言而言，字有不同的含义，比如英文中字与词实际上是合一的，而中文中字与词有很大分别。按词检索指对文章中的词，即语义单位建立索引，检索时按词检索，并且可以处理同义项等。英文等西方文字由于按照空白切分词，因此实现上与按字处理类似，添加同义处理也很容易。中文等东方文字则需要切分字词，以达到按词索引的目的，关于这方面的问题，是当前全文检索技术尤其是中文全文检索技术中的难点，在此不做详述。</p><h3 id="1-5-正排索引和倒排索引"><a href="#1-5-正排索引和倒排索引" class="headerlink" title="1.5-正排索引和倒排索引"></a>1.5-正排索引和倒排索引</h3><h4 id="1-正排索引"><a href="#1-正排索引" class="headerlink" title="1. 正排索引"></a>1. 正排索引</h4><p><strong>正排索引也称为”前向索引”，它是创建倒排索引的基础。</strong><br>这种组织方法在建立索引的时候结构比较简单，建立比较方便且易于维护;因为索引是基于文档建立的，若是有新的文档加入，直接为该文档建立一个新的索引块，挂接在原来索引文件的后面。若是有文档删除，则直接找到该文档号文档对应的索引信息，将其直接删除。<br>他适合根据文档ID来查询对应的内容。但是在查询一个keyword在哪些文档里包含的时候需对所有的文档进行扫描以确保没有遗漏，这样就使得检索时间大大延长，检索效率低下。<br>比如有几个文档及里面的内容，他正排索引构建的结果如下图：</p><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95.png"></p><p><strong>优点：</strong>工作原理非常的简单。<br><strong>缺点：</strong>检索效率太低，只能在一起简单的场景下使用。</p><h4 id="2-倒排索引"><a href="#2-倒排索引" class="headerlink" title="2. 倒排索引"></a>2. 倒排索引</h4><p>倒排索引（英文：Inverted Index），是一种索引方法，常被用于全文检索系统中的一种单词文档映射结构。现代搜索引擎绝大多数的索引都是基于倒排索引来进行构建的，这源于在实际应用当中，用户在使用搜索引擎查找信息时往往只输入信息中的某个属性关键字，如一些用户不记得歌名，会输入歌词来查找歌名；输入某个节目内容片段来查找该节目等等。</p><p><strong>面对海量的信息数据，为满足用户需求，顺应信息时代快速获取信息的趋势，聪明的开发者们在进行搜索引擎开发时对这些信息数据进行逆向运算，研发了“关键词——文档”形式的一种映射结构，实现了通过物品属性信息对物品进行映射时，可以帮助用户快速定位到目标信息，从而极大降低了信息获取难度。</strong>倒排索引又叫反向索引，它是一种逆向思维运算，是现代信息检索领域里面最有效的一种索引结构。</p><p>在搜索引擎中每个文件都对应一个文件ID，文件内容被表示为一系列关键词的集合（文档要除去一些无用的词，比如’的’这些，剩下的词就是关键词，每个关键词都有自己的ID）。例如“文档1”经过分词，提取了3个关键词，每个关键词都会记录它所在在文档中的出现频率及出现位置。</p><p>那么上面的文档及内容构建的倒排索引结果会如下图（注：这个图里没有记录展示该词在出现在哪个文档的具体位置）：</p><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95.png"></p><ul><li><h5 id="如何来查询呢？"><a href="#如何来查询呢？" class="headerlink" title="如何来查询呢？"></a>如何来查询呢？</h5><p>比如我们要查询‘搜索引擎’这个关键词在哪些文档中出现过。首先我们通过倒排索引可以查询到该关键词出现的文档位置是在1和3中;然后再通过正排索引查询到文档1和3的内容并返回结果。</p></li><li><h5 id="倒排索引组成"><a href="#倒排索引组成" class="headerlink" title="倒排索引组成"></a>倒排索引组成</h5><p>倒排索引主要由<strong>单词词典</strong>（Term Dictionary）和<strong>倒排列表</strong>（Posting List）及<strong>倒排文件</strong>(Inverted File)组成。<br>他们三者的关系如下图：</p><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%BB%84%E6%88%90.png"></p><p><strong>单词词典（Term Dictionary）：</strong>搜索引擎的通常索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。<br><strong>倒排列表(PostingList)：</strong>倒排列表记载了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息及频率（作关联性算分），每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。<br><strong>倒排文件(Inverted File)：</strong>所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，倒排文件是存储倒排索引的物理文件。</p><p><strong>以查找搜索引擎查找为例：</strong></p><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%BB%84%E6%88%90.png"></p></li><li><h5 id="单词词典查询定位问题"><a href="#单词词典查询定位问题" class="headerlink" title="单词词典查询定位问题"></a>单词词典查询定位问题</h5><p>对于一些规模很大的文档集合来讲，他里面可能包括了上百万的关键单词(term)，能否快速定位到具体单词(term)，这会直接影响到响应速度。</p><blockquote><p>假设我们有很多个 term，比如：</p><p>Carla,Sara,Elin,Ada,Patty,Kate,Selena</p></blockquote><p>如果按照这样的顺序排列，找出某个特定的 term 一定很慢，因为 term 没有排序，需要全部过滤一遍才能找出特定的 term。</p><blockquote><p>排序之后就变成了：</p><p>Ada,Carla,Elin,Kate,Patty,Sara,Selena</p></blockquote><p>这样我们可以用二分查找的方式，比全遍历更快地找出目标的 term。这个就是 term dictionary。有了 term dictionary 之后，可以用 logN 次磁盘查找得到目标。但是磁盘的随机读操作仍然是非常昂贵的（一次 random access 大概需要 10ms 的时间）。所以尽量少的读磁盘，有必要把一些数据缓存到内存里。但是整个 term dictionary 本身又太大了，无法完整地放到内存里。于是就有了 term index。term index 有点像一本字典的大的章节表。</p><p>目前常用的方式是通过<strong>hash加链表结构和树型结构</strong>（b树或者b+）。</p><ul><li><p><strong>hash加链表:</strong></p><p><img src="https://gitee.com/lemon-cs/images/raw/master/9676606-f5a8e88e4ef1ea02.png"></p><p>这是很常用的一种数据结构。这种方式就可以快速计算单词的hash值从而定位到他所有在的hash表中，如果该表是又是一个链表结构（两个单词的hash值可能会一样），那么就需要遍历这个链表然后再对比返回结果。这种方式最大的缺点就是如果有范围查询的时候就很难做到。</p></li><li><h4 id="树型结构："><a href="#树型结构：" class="headerlink" title="树型结构："></a>树型结构：</h4><p>B树（或者B+树）是另外一种高效查找结构，下图是一个 B树结构示意图。B树与哈希方式查找同，需要字典项能够按照大小排序（数字或者字符序），而哈希方式则无须数据满足此项要求。</p><p>B树形成了层级查找结构，中间节点用于指出一定顺序范围的词典项目存储在哪个子树中，起到根据词典项比较大小进行导航的作用，最底层的叶子节点存储单词的地址信息，根据这个地址就可以提取出单词字符串。</p></li></ul></li></ul><h3 id="1-5-ElasticSearch的基本概念"><a href="#1-5-ElasticSearch的基本概念" class="headerlink" title="1.5-ElasticSearch的基本概念"></a>1.5-ElasticSearch的基本概念</h3><h4 id="1-ElaticSearch-和-DB-的关系"><a href="#1-ElaticSearch-和-DB-的关系" class="headerlink" title="1. ElaticSearch 和 DB 的关系"></a>1. ElaticSearch 和 DB 的关系</h4><p>在 Elasticsearch 中，文档归属于一种类型 type，而这些类型存在于索引 index 中，我们可以列一些简单的不同点，来类比传统关系型数据库：</p><ul><li>Relational DB -&gt; Databases -&gt; Tables -&gt; Rows -&gt; Columns</li><li>Elasticsearch -&gt; Indices -&gt; Types -&gt; Documents -&gt; Fields</li></ul><p>Elasticsearch 集群可以包含多个索引 indices，每一个索引可以包含多个类型 types，每一个类型包含多个文档 documents，然后每个文档包含多个字段 Fields。而在 DB 中可以有多个数据库 Databases，每个库中可以有多张表 Tables，没个表中又包含多行Rows，每行包含多列Columns。</p><p><strong>ES和数据库关系对比:</strong></p><p><img src="https://gitee.com/lemon-cs/images/raw/master/6591571-38375e41a3b2918d.png"></p><h4 id="2-索引"><a href="#2-索引" class="headerlink" title="2. 索引"></a>2. 索引</h4><p><strong>索引基本概念（indices）：</strong></p><p>索引是含义相同属性的文档集合，是 ElasticSearch 的一个逻辑存储，可以理解为关系型数据库中的数据库，ElasticSearch 可以把索引数据存放到一台服务器上，也可以 sharding 后存到多台服务器上，每个索引有一个或多个分片，每个分片可以有多个副本。</p><p><strong>索引类型（index_type）：</strong></p><p>索引可以定义一个或多个类型，文档必须属于一个类型。在 ElasticSearch 中，一个索引对象可以存储多个不同用途的对象，通过索引类型可以区分单个索引中的不同对象，可以理解为关系型数据库中的表。每个索引类型可以有不同的结构，但是不同的索引类型不能为相同的属性设置不同的类型。</p><h4 id="3-文档"><a href="#3-文档" class="headerlink" title="3. 文档"></a>3. 文档</h4><p><strong>文档（document）：</strong></p><p>文档是可以被索引的基本数据单位。存储在 ElasticSearch 中的主要实体叫文档 document，可以理解为关系型数据库中表的一行记录。每个文档由多个字段构成，ElasticSearch 是一个非结构化的数据库，每个文档可以有不同的字段，并且有一个唯一的标识符。</p><h4 id="4-映射"><a href="#4-映射" class="headerlink" title="4. 映射"></a>4. 映射</h4><p><strong>映射（mapping）:</strong></p><p>ElasticSearch 的 Mapping 非常类似于静态语言中的数据类型：声明一个变量为 int 类型的变量，以后这个变量都只能存储 int 类型的数据。同样的，一个 number 类型的 mapping 字段只能存储 number 类型的数据。</p><p>同语言的数据类型相比，Mapping 还有一些其他的含义，Mapping 不仅告诉 ElasticSearch 一个 Field 中是什么类型的值， 它还告诉 ElasticSearch 如何索引数据以及数据是否能被搜索到。</p><p>ElaticSearch 默认是动态创建索引和索引类型的 Mapping 的。这就相当于无需定义 Solr 中的 Schema，无需指定各个字段的索引规则就可以索引文件，很方便。但有时方便就代表着不灵活。比如，ElasticSearch 默认一个字段是要做分词的，但我们有时要搜索匹配整个字段却不行。如有统计工作要记录每个城市出现的次数。对于 name 字段，若记录 new york 文本，ElasticSearch 可能会把它拆分成 new 和 york 这两个词，分别计算这个两个单词的次数，而不是我们期望的 new york。</p><h4 id="5-Near-Realtime-NRT-几乎实时"><a href="#5-Near-Realtime-NRT-几乎实时" class="headerlink" title="5. Near Realtime(NRT) 几乎实时"></a>5. Near Realtime(NRT) 几乎实时</h4><p>Elasticsearch是一个几乎实时的搜索平台。意思是，从索引一个文档到这个文档可被搜索只需要一点点的延迟，这个时间一般为毫秒级。</p><h4 id="6-Cluster-集群"><a href="#6-Cluster-集群" class="headerlink" title="6. Cluster 集群"></a>6. Cluster 集群</h4><p>群集是一个或多个节点（服务器）的集合， 这些节点共同保存整个数据，并在所有节点上提供联合索引和搜索功能。一个集群由一个唯一集群ID确定，并指定一个集群名（默认为“elasticsearch”）。该集群名非常重要，因为节点可以通过这个集群名加入群集，一个节点只能是群集的一部分。</p><p>确保在不同的环境中不要使用相同的群集名称，否则可能会导致连接错误的群集节点。例如，你可以使用logging-dev、logging-stage、logging-prod分别为开发、阶段产品、生产集群。</p><h4 id="7-Node节点"><a href="#7-Node节点" class="headerlink" title="7. Node节点"></a>7. Node节点</h4><p>节点是单个服务器实例，它是群集的一部分，可以存储数据，并参与群集的索引和搜索功能。就像一个集群，节点的名称默认为一个随机的通用唯一标识符（UUID），确定在启动时分配给该节点。如果不希望默认，可以定义任何节点名。这个名字对管理很重要，目的是要确定你的网络服务器对应于你的ElasticSearch群集节点。</p><p>我们可以通过群集名配置节点以连接特定的群集。默认情况下，每个节点设置加入名为“elasticSearch”的集群。这意味着如果你启动多个节点在网络上，假设他们能发现彼此都会自动形成和加入一个名为“elasticsearch”的集群。</p><p>在单个群集中，您可以拥有尽可能多的节点。此外，如果“elasticsearch”在同一个网络中，没有其他节点正在运行，从单个节点的默认情况下会形成一个新的单节点名为”elasticsearch”的集群。</p><h4 id="8-Shards-amp-Replicas分片与副本"><a href="#8-Shards-amp-Replicas分片与副本" class="headerlink" title="8. Shards &amp; Replicas分片与副本"></a>8. Shards &amp; Replicas分片与副本</h4><p>索引可以存储大量的数据，这些数据可能超过单个节点的硬件限制。例如，十亿个文件占用磁盘空间1TB的单指标可能不适合对单个节点的磁盘或可能太慢服务仅从单个节点的搜索请求。</p><p>为了解决这一问题，Elasticsearch提供细分你的指标分成多个块称为分片的能力。当你创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立的“指数”，可以托管在集群中的任何节点。</p><p>Shards分片的重要性主要体现在以下两个特征：</p><ul><li>分片允许您水平拆分或缩放内容的大小</li><li>分片允许你分配和并行操作的碎片（可能在多个节点上）从而提高性能/吞吐量<br>这个机制中的碎片是分布式的以及其文件汇总到搜索请求是完全由ElasticSearch管理，对用户来说是透明的。</li></ul><p>在同一个集群网络或云环境上，故障是任何时候都会出现的，拥有一个故障转移机制以防分片和结点因为某些原因离线或消失是非常有用的，并且被强烈推荐。为此，Elasticsearch允许你创建一个或多个拷贝，你的索引分片进入所谓的副本或称作复制品的分片，简称Replicas。</p><p><code>Replicas</code>的重要性主要体现在以下两个特征：</p><ul><li>副本为分片或节点失败提供了高可用性。为此，需要注意的是，一个副本的分片不会分配在同一个节点作为原始的或主分片，副本是从主分片那里复制过来的。</li><li>副本允许用户扩展你的搜索量或吞吐量，因为搜索可以在所有副本上并行执行。</li></ul><h2 id="2-ElasticSearch的安装和使用"><a href="#2-ElasticSearch的安装和使用" class="headerlink" title="2-ElasticSearch的安装和使用"></a>2-ElasticSearch的安装和使用</h2><h3 id="2-1-ElasticSearch的安装"><a href="#2-1-ElasticSearch的安装" class="headerlink" title="2.1-ElasticSearch的安装"></a>2.1-ElasticSearch的安装</h3><h4 id="1-Linux下安装ES"><a href="#1-Linux下安装ES" class="headerlink" title="1. Linux下安装ES"></a>1. Linux下安装ES</h4><p>Linux服务器是CentOS 7.x</p><ul><li><p>Elasticsearch下载地址：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">https</span>:<span class="string">//artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.1.1-linux-x86_64.tar.gz</span></span><br></pre></td></tr></table></figure></li><li><p>解压elasticsearch-7.1.1-linux-x86_64.tar.gz到/usr/local/目录：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">tar</span> <span class="string">-avxf elasticsearch-7.1.1-linux-x86_64.tar.gz -C /usr/local/</span></span><br></pre></td></tr></table></figure></li><li><p>进入解压后的elasticsearch目录</p><ul><li><p>新建data目录：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">mkdir</span> <span class="string">data</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/lemon-cs/images/raw/master/20190621153805949.png"></p></li><li><p>修改config/elasticsearch.yml：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">vim</span> <span class="string">config/elasticsearch.yml</span></span><br></pre></td></tr></table></figure></li><li><p>取消下列项注释并修改：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">cluster.name</span>: <span class="string">my-application #集群名称</span></span><br><span class="line"><span class="meta">node.name</span>: <span class="string">node-1 #节点名称</span></span><br><span class="line"><span class="comment">#数据和日志的存储目录</span></span><br><span class="line"><span class="meta">path.data</span>: <span class="string">/usr/local/elasticsearch-7.1.1/data</span></span><br><span class="line"><span class="meta">path.logs</span>: <span class="string">/usr/local/elasticsearch-7.1.1/logs</span></span><br><span class="line"><span class="comment">#设置绑定的ip，设置为0.0.0.0以后就可以让任何计算机节点访问到了</span></span><br><span class="line"><span class="meta">network.host</span>: <span class="string">0.0.0.0</span></span><br><span class="line"><span class="meta">http.port</span>: <span class="string">9200 #端口</span></span><br><span class="line"><span class="comment">#设置在集群中的所有节点名称，这个节点名称就是之前所修改的，当然你也可以采用默认的也行，目前是单机，放入一个节点即可</span></span><br><span class="line"><span class="meta">cluster.initial_master_nodes</span>: <span class="string">[&quot;node-1&quot;]</span></span><br></pre></td></tr></table></figure><p>修改完毕后，:wq 保存退出vim</p></li></ul></li><li><p>准备启动es<br>进入/bin目录执行命令：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">./elasticsearch</span></span><br></pre></td></tr></table></figure><p>我这里出现如下错误：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Java</span> <span class="string">HotSpot(TM) 64-Bit Server VM warning: INFO: os::commit_memory(0x00000000c5330000, 986513408, 0) failed; error=&#x27;Cannot allocate memory&#x27; (errno=12)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (mmap) failed to map 986513408 bytes for committing reserved memory.</span></span><br><span class="line"><span class="comment"># An error report file with more information is saved as:</span></span><br><span class="line"><span class="comment"># logs/hs_err_pid22863.log</span></span><br><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">bin]# </span></span><br></pre></td></tr></table></figure><p>看来是我这1G的内存太小了啊，elasticsearch使用java的jvm默认是使用1G的内存的，这里我们修改一下内存，直接把内存改到200m。</p><p>cd 到es目录修改 ./config/jvm.options：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">vim</span> <span class="string">./config/jvm.options </span></span><br></pre></td></tr></table></figure><p>修改该内容：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">-Xms200m</span></span><br><span class="line"><span class="attr">-Xmx200m</span></span><br></pre></td></tr></table></figure><p>:wq 保存并退出vim，再次启动es</p><p>再次启动出现如下错误：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[2019-06-21T16</span>:<span class="string">20:03,039][WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [node-1] uncaught exception in thread [main]</span></span><br><span class="line"><span class="meta">org.elasticsearch.bootstrap.StartupException</span>: <span class="string">java.lang.RuntimeException: can not run elasticsearch as root</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:163) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:150) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124) ~[elasticsearch-cli-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.cli.Command.main(Command.java:90) ~[elasticsearch-cli-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:115) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">Caused</span> <span class="string">by: java.lang.RuntimeException: can not run elasticsearch as root</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:102) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:169) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:325) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="attr">at</span> <span class="string">org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) ~[elasticsearch-7.1.1.jar:7.1.1]</span></span><br><span class="line">    <span class="meta">...</span> <span class="string">6 more</span></span><br><span class="line">    <span class="meta">[root@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]# </span></span><br></pre></td></tr></table></figure><p>这是不能使用root用户操作，添加一个其他的用户再试试：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]# adduser es</span></span><br><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]# passwd es</span></span><br><span class="line"><span class="attr">Changing</span> <span class="string">password for user es.</span></span><br><span class="line"><span class="attr">New</span> <span class="string">password: </span></span><br><span class="line"><span class="attr">Retype</span> <span class="string">new password: </span></span><br><span class="line"><span class="attr">passwd</span>: <span class="string">all authentication tokens updated successfully.</span></span><br></pre></td></tr></table></figure><p>改一下es目录所属用户：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]# chown es /usr/local/elasticsearch-7.1.1/ -R</span></span><br></pre></td></tr></table></figure><p>vim 编辑 /etc/security/limits.conf，在末尾加上：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">es</span> <span class="string">soft nofile 65536</span></span><br><span class="line"><span class="attr">es</span> <span class="string">hard nofile 65536</span></span><br><span class="line"><span class="attr">es</span> <span class="string">soft nproc 4096</span></span><br><span class="line"><span class="attr">es</span> <span class="string">hard nproc 4096</span></span><br></pre></td></tr></table></figure><p>vim 编辑 vim /etc/security/limits.d/20-nproc.conf，将* 改为用户名（es）：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Default limit for number of user&#x27;s processes to prevent</span></span><br><span class="line"><span class="comment"># accidental fork bombs.</span></span><br><span class="line"><span class="comment"># See rhbz #432903 for reasoning.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">es</span>          <span class="string">soft    nproc     4096</span></span><br><span class="line"><span class="attr">root</span>       <span class="string">soft    nproc     unlimited</span></span><br></pre></td></tr></table></figure><p>vim 编辑 /etc/sysctl.conf，在末尾加上：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">vm.max_map_count</span> = <span class="string">655360</span></span><br></pre></td></tr></table></figure><p>执行：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">~]# sysctl -p</span></span><br><span class="line"><span class="meta">kernel.printk</span> = <span class="string">5</span></span><br><span class="line"><span class="meta">vm.max_map_count</span> = <span class="string">655360</span></span><br><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">~]# </span></span><br></pre></td></tr></table></figure><p>登录刚才新建的es用户，并启动elasticsearch，OK</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[root@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]# su es</span></span><br><span class="line"><span class="meta">[es@VM_0_2_centos</span> <span class="string">elasticsearch-7.1.1]$ ./bin/elasticsearch</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-Docker下安装ES"><a href="#2-Docker下安装ES" class="headerlink" title="2. Docker下安装ES"></a>2. Docker下安装ES</h4><ul><li><p>搜索ES镜像</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">search elasticsearch</span></span><br></pre></td></tr></table></figure></li><li><p>docker安装es</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">pull elasticsearch:7.2.0</span></span><br></pre></td></tr></table></figure></li><li><p><strong>启动es</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">run --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -d elasticsearch:7.2.0</span></span><br></pre></td></tr></table></figure></li><li><p><strong>修改配置，解决跨域访问问题</strong></p><blockquote><p>首先进入到容器中，然后进入到指定目录修改elasticsearch.yml文件。</p></blockquote><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> <span class="string">docker exec -it elasticsearch /bin/bash</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">cd /usr/share/elasticsearch/config/</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">vi elasticsearch.yml</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 追加一下内容,解决跨域问题</span></span><br><span class="line"><span class="meta">http.cors.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="meta">http.cors.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><p>:wq保存</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> <span class="string">vi jvm.options </span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">-Xms200m</span></span><br><span class="line"><span class="attr">-Xmx200m</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">exit</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">docker restart elasticsearch</span></span><br></pre></td></tr></table></figure></li><li><p><strong>安装ik分词器</strong></p><blockquote><p>es自带的分词器对中文分词不是很友好，所以我们下载开源的IK分词器来解决这个问题。首先进入到plugins目录中下载分词器，下载完成后然后解压，再重启es即可。具体步骤如下:<br>注意：elasticsearch的版本和ik分词器的版本需要保持一致，不然在重启的时候会失败。可以在这查看所有版本，选择合适自己版本</p></blockquote><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> <span class="string">cd /usr/share/elasticsearch/plugins/</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.2.0/elasticsearch-analysis-ik-7.2.0.zip</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">exit</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">docker restart elasticsearch 然后可以在kibana界面的dev tools中验证是否安装成功；</span></span><br></pre></td></tr></table></figure></li><li><p><strong>验证</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">test/_analyze</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;,</span></span><br><span class="line">  <span class="meta">&quot;text&quot;</span>: <span class="string">&quot;你好我是东邪Jiafly&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>不添加”analyzer”: “ik_max_word”,则是每个字分词，可以在下面kibana安装完成以后尝试一下。</p></blockquote></li><li><p><strong>docker安装kibana</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">pull kibana:7.2.0</span></span><br></pre></td></tr></table></figure></li><li><p><strong>启动kibana</strong></p><p>安装完成以后需要启动kibana容器，使用–link连接到elasticsearch容器，命令如下:</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> <span class="string">docker run --name kibana --link=elasticsearch:test  -p 5601:5601 -d kibana:7.2.0</span></span><br><span class="line"><span class="meta">-&gt;</span> <span class="string">docker start kibana</span></span><br></pre></td></tr></table></figure><p>启动以后可以打开浏览器输入<code>http://localhost:5601</code>就可以打开kibana的界面了。</p></li><li><p>安装elasticsearch head插件监控管理（不推荐）</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">pull mobz/elasticsearch-head:5</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">run -d -p 9100:9100 docker.io/mobz/elasticsearch-head:5</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-2-ElasticSearch的使用"><a href="#2-2-ElasticSearch的使用" class="headerlink" title="2.2-ElasticSearch的使用"></a>2.2-ElasticSearch的使用</h3><h4 id="1-ELasticSearch常用命令"><a href="#1-ELasticSearch常用命令" class="headerlink" title="1. ELasticSearch常用命令"></a>1. ELasticSearch常用命令</h4><h5 id="1-集群信息"><a href="#1-集群信息" class="headerlink" title="(1) 集群信息"></a>(1) 集群信息</h5><ul><li>查看欢迎信息</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># url</span></span><br><span class="line"><span class="attr">http</span>:<span class="string">//112.xx.xx.xx:9200/</span></span><br></pre></td></tr></table></figure><ul><li>查看集群是否健康</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看集群健康状态</span></span><br><span class="line"><span class="comment"># url</span></span><br><span class="line"><span class="attr">http</span>:<span class="string">//112.xx.xx.xx:9200/_cluster/health</span></span><br><span class="line"><span class="comment"># Kibana</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cluster/health</span></span><br></pre></td></tr></table></figure><ul><li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/cluster-get-settings.html">查看集群配置</a></li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># url</span></span><br><span class="line"><span class="attr">http</span>:<span class="string">//112.xx.xx.xx:9200/_cluster/settings?include_defaults</span></span><br><span class="line"><span class="comment"># Kibana</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cluster/settings?include_defaults</span></span><br></pre></td></tr></table></figure><ul><li>查看节点列表</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看节点列表</span></span><br><span class="line"><span class="comment"># url</span></span><br><span class="line"><span class="attr">http</span>:<span class="string">//112.xx.xx.xx:9200/_cat/nodes?v</span></span><br><span class="line"><span class="comment"># Kibana</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/nodes?v</span></span><br></pre></td></tr></table></figure><h5 id="2-索引-1"><a href="#2-索引-1" class="headerlink" title="(2) 索引"></a>(2) 索引</h5><p><strong>查看索引：</strong></p><ul><li>查看所有索引</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/indices</span></span><br></pre></td></tr></table></figure><ul><li>查看某个索引的状态</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看某个索引的状态</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/indices/my_index</span></span><br></pre></td></tr></table></figure><ul><li>查看某个索引的 mapping</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看某个索引的 mapping</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/my_index/_mapping</span></span><br></pre></td></tr></table></figure><ul><li>查看某个索引的 settings</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看某个索引的 settings</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/my_index/_settings</span></span><br></pre></td></tr></table></figure><ul><li>如果 index 的状态为 yellow，可能是因为副本分片未分配出去</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 shard 未分配（unassigned）出去的原因</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/shards?v&amp;h=index,shard,prirep,state,unassigned.reason</span></span><br></pre></td></tr></table></figure><p><strong>创建索引：</strong></p><ul><li><p>用明确的 mapping 创建索引</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PUT</span> <span class="string">/my_index</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;mappings&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;dynamic&quot;</span>: <span class="string">false,</span></span><br><span class="line">    <span class="meta">&quot;properties&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;age&quot;</span>:    <span class="string">&#123; &quot;type&quot;: &quot;integer&quot; &#125;,  </span></span><br><span class="line">      <span class="meta">&quot;email&quot;</span>:  <span class="string">&#123; &quot;type&quot;: &quot;keyword&quot;  &#125;, </span></span><br><span class="line">      <span class="meta">&quot;name&quot;</span>:   <span class="string">&#123; &quot;type&quot;: &quot;text&quot;  &#125;     </span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>删除索引：</strong></p><ul><li>删除 my_index 索引</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">DELETE</span> <span class="string">/my_index</span></span><br></pre></td></tr></table></figure><p><strong>重建索引：</strong></p><ul><li>重建 my_index 到 my_index_new</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/_reindex</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;source&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;index&quot;</span>: <span class="string">&quot;my_index&quot;,    # 原有索引</span></span><br><span class="line">    <span class="meta">&quot;size&quot;</span>: <span class="string">5000            # 一个批次处理的数据量</span></span><br><span class="line">  <span class="attr">&#125;,</span></span><br><span class="line">  <span class="meta">&quot;dest&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;index&quot;</span>: <span class="string">&quot;my_index_new&quot; # 新索引</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>查看重建索引的进度</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">GET</span> <span class="string">/_tasks?detailed=true&amp;actions=*reindex</span></span><br></pre></td></tr></table></figure><p><strong>索引模板：</strong></p><ul><li>查看有哪些模板</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">GET</span> <span class="string">_cat/templates</span></span><br></pre></td></tr></table></figure><ul><li>查看一个具体的模板</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">GET</span> <span class="string">_template/my_index_tpl</span></span><br></pre></td></tr></table></figure><ul><li>创建模板</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PUT</span> <span class="string">/_template/my_index_tpl</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;order&quot;</span>: <span class="string">0,</span></span><br><span class="line">  <span class="meta">&quot;index_patterns&quot;</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">&quot;my_index_*&quot;</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">&quot;settings&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;index&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;number_of_shards&quot;</span>: <span class="string">12,</span></span><br><span class="line">      <span class="meta">&quot;number_of_replicas&quot;</span>: <span class="string">1</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;,</span></span><br><span class="line">  <span class="meta">&quot;mappings&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;_source&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;enabled&quot;</span>: <span class="string">false</span></span><br><span class="line">    <span class="attr">&#125;,</span></span><br><span class="line">    <span class="meta">&quot;dynamic&quot;</span>: <span class="string">false,</span></span><br><span class="line">    <span class="meta">&quot;properties&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;name_en&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;,</span></span><br><span class="line">        <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;text&quot;,</span></span><br><span class="line">        <span class="meta">&quot;fields&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">          <span class="meta">&quot;keyword&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">            <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">      <span class="attr">&#125;,</span></span><br><span class="line">      <span class="meta">&quot;name_cn&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;,</span></span><br><span class="line">        <span class="meta">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;,</span></span><br><span class="line">        <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="attr">&#125;,</span></span><br><span class="line">      <span class="meta">&quot;country&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="attr">&#125;,</span></span><br><span class="line">      <span class="meta">&quot;full_field&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;index&quot;</span>: <span class="string">false,</span></span><br><span class="line">        <span class="meta">&quot;store&quot;</span>: <span class="string">true,</span></span><br><span class="line">        <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;,</span></span><br><span class="line">  <span class="meta">&quot;aliases&quot;</span>: <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>更多索引模板知识查看： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.4/indices-templates.html">Put index template API</a></li></ul><h5 id="3-索引别名"><a href="#3-索引别名" class="headerlink" title="(3) 索引别名"></a>(3) 索引别名</h5><ul><li>查看有哪些别名</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">GET</span> <span class="string">_cat/aliases</span></span><br></pre></td></tr></table></figure><ul><li>添加别名</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 多对一</span></span><br><span class="line"><span class="attr">POST</span> <span class="string">/_aliases</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;actions&quot;</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;add&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;indices&quot;</span>: <span class="string">[</span></span><br><span class="line">          <span class="attr">&quot;my_index_1&quot;,</span></span><br><span class="line">          <span class="attr">&quot;my_index_2&quot;</span></span><br><span class="line">        <span class="attr">],</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">]</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 支持通配符（*）</span></span><br><span class="line"><span class="attr">POST</span> <span class="string">/_aliases</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;actions&quot;</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;add&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;indices&quot;</span>: <span class="string">[</span></span><br><span class="line">          <span class="attr">&quot;my_index_*&quot;</span></span><br><span class="line">        <span class="attr">],</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">]</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>移除别名</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/_aliases</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;actions&quot;</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;remove&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;index&quot;</span>: <span class="string">&quot;my_index_1&quot;,</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;,</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;remove&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;index&quot;</span>: <span class="string">&quot;my_index_2&quot;,</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">]</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>替换（移除和添加组合使用）</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/_aliases</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;actions&quot;</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;remove&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;indices&quot;</span>: <span class="string">[</span></span><br><span class="line">          <span class="attr">&quot;my_index_1_20201011&quot;,</span></span><br><span class="line">          <span class="attr">&quot;my_index_2_20201011&quot;</span></span><br><span class="line">        <span class="attr">],</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;,</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;add&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;indices&quot;</span>: <span class="string">[</span></span><br><span class="line">          <span class="attr">&quot;my_index_1_20201022&quot;,</span></span><br><span class="line">          <span class="attr">&quot;my_index_2_20201022&quot;</span></span><br><span class="line">        <span class="attr">],</span></span><br><span class="line">        <span class="meta">&quot;alias&quot;</span>: <span class="string">&quot;my_index_alias&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">]</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>更多索引别名知识查看： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/indices-aliases.html">Update index alias API</a></li></ul><h5 id="4-settings"><a href="#4-settings" class="headerlink" title="(4) settings"></a>(4) settings</h5><p><strong>分片（shard）</strong></p><ul><li>初始化分片数</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PUT</span> <span class="string">/my_temp_index</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">    <span class="meta">&quot;settings&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;number_of_shards&quot;</span> :   <span class="string">1,   # 主分片数，不可动态修改</span></span><br><span class="line">        <span class="meta">&quot;number_of_replicas&quot;</span> : <span class="string">0    # 副本分片数，可以动态修改</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>动态修改副本分片数</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;number_of_replicas&quot;</span>: <span class="string">0</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>查看分片情况</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引的分片情况</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/shards?v</span></span><br><span class="line"><span class="comment"># 查看 my_index 的分片情况</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/shards/my_index?v</span></span><br></pre></td></tr></table></figure><h5 id="5-mapping"><a href="#5-mapping" class="headerlink" title="(5) mapping"></a>(5) mapping</h5><p><strong>新增索引字段</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 无需 reindex</span></span><br><span class="line"><span class="attr">PUT</span> <span class="string">/my_index/_mapping</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;properties&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;employee-id&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 当给已有无索引字段添加索引后，</span></span><br><span class="line"><span class="comment"># 该字段的新增数据可以被检索到，</span></span><br><span class="line"><span class="comment"># 该字段的历史数据不能被检索到，</span></span><br><span class="line"><span class="comment">#此时可以用 </span></span><br><span class="line"><span class="attr">POST</span> <span class="string">/my_index/_update_by_query</span></span><br><span class="line"><span class="comment"># 语句刷新索引</span></span><br><span class="line"><span class="comment"># 增加子字段也可以用类似方法</span></span><br></pre></td></tr></table></figure><h5 id="6-文档的增删改查（CRUD）"><a href="#6-文档的增删改查（CRUD）" class="headerlink" title="(6) 文档的增删改查（CRUD）"></a>(6) 文档的增删改查（CRUD）</h5><table><thead><tr><th>Elasticsearch</th><th>类比MySQL</th><th>说明</th></tr></thead><tbody><tr><td>Index</td><td>replcae into</td><td>Index在索引不存在时会创建索引， replace into 并不会创建库或表</td></tr><tr><td>Create</td><td>insert into</td><td>增加</td></tr><tr><td>Read</td><td>select</td><td>读取</td></tr><tr><td>Update</td><td>update</td><td>更新</td></tr><tr><td>Delete</td><td>delete</td><td>删除</td></tr></tbody></table><ul><li><h6 id="Create（增加）"><a href="#Create（增加）" class="headerlink" title="Create（增加）"></a>Create（增加）</h6><ul><li>指定 ID</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/my_index/_doc/1</span></span><br><span class="line"><span class="meta">&#123;&quot;user&quot;</span>:<span class="string">&quot;walker&quot;&#125;</span></span><br></pre></td></tr></table></figure><ul><li>系统自动生成 ID</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/my_index/_doc</span></span><br><span class="line"><span class="meta">&#123;&quot;user&quot;</span>:<span class="string">&quot;walker&quot;&#125;</span></span><br></pre></td></tr></table></figure></li><li><h6 id="Read（读取）"><a href="#Read（读取）" class="headerlink" title="Read（读取）"></a>Read（读取）</h6><ul><li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html">Query DSL</a></li><li>查看某个索引的文档总数</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看某个索引的文档总数</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_cat/count/my_index?v</span></span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/my_index/_count</span></span><br></pre></td></tr></table></figure><ul><li>返回索引的所有文档</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 返回索引的所有文档</span></span><br><span class="line"><span class="attr">GET</span>  <span class="string">/kibana_sample_data_ecommerce/_search</span></span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line"><span class="attr">POST</span> <span class="string">my_index/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;match_all&quot;</span>: <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>根据ID查看文档</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 根据ID查看文档</span></span><br><span class="line"><span class="attr">GET</span>  <span class="string">/kibana_sample_data_ecommerce/_doc/xPGYeWwBVtEez7y_Ku1U</span></span><br></pre></td></tr></table></figure><ul><li>term 查询精确匹配</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># term 查询精确匹配</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;term&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;currency&quot;</span>: <span class="string">&quot;EUR&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 通过 Constant Score 将查询转换成一个 Filtering</span></span><br><span class="line"><span class="comment"># 避免算分，并利用缓存，提高性能</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;constant_score&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;filter&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;term&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">          <span class="meta">&quot;currency&quot;</span>: <span class="string">&quot;EUR&quot;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>通配符模糊查询</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通配符模糊查询</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;wildcard&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;currency&quot;</span>: <span class="string">&quot;*U*&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 通过 Constant Score 将查询转换成一个 Filtering</span></span><br><span class="line"><span class="comment"># 避免算分，并利用缓存，提高性能</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;constant_score&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;filter&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;wildcard&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">          <span class="meta">&quot;currency&quot;</span>: <span class="string">&quot;*U*&quot;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>多条件组合查询</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Boolean query</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/my_index/_search</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;bool&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;filter&quot;</span>: <span class="string">[</span></span><br><span class="line">        <span class="attr">&#123;</span></span><br><span class="line">          <span class="meta">&quot;term&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">            <span class="meta">&quot;author&quot;</span>: <span class="string">&quot;walker&quot;</span></span><br><span class="line">          <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;,</span></span><br><span class="line">        <span class="attr">&#123;</span></span><br><span class="line">          <span class="meta">&quot;wildcard&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">            <span class="meta">&quot;title&quot;</span>: <span class="string">&quot;*科技*&quot;</span></span><br><span class="line">          <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">      <span class="attr">]</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>返回查询数据量</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 返回查询数据量</span></span><br><span class="line"><span class="attr">GET</span> <span class="string">/my_index/_count</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;wildcard&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">      <span class="meta">&quot;title&quot;</span>: <span class="string">&quot;*科技*&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>游标查询（深度分页 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-request-body.html#request-body-search-scroll">Scroll</a>，命中数大于10000时，可返回命中总数）</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 游标查询</span></span><br><span class="line"><span class="attr">POST</span> <span class="string">/my_index/_search?scroll=1m</span></span><br></pre></td></tr></table></figure></li><li><h6 id="Update（更新）"><a href="#Update（更新）" class="headerlink" title="Update（更新）"></a>Update（更新）</h6><ul><li>指定 ID 更新</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">/my_index/_update/1</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;doc&quot;</span>: <span class="string">&#123;</span></span><br><span class="line">    <span class="meta">&quot;user&quot;</span>: <span class="string">&quot;walker&quot;,</span></span><br><span class="line">    <span class="meta">&quot;age&quot;</span>: <span class="string">99</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure></li><li><h6 id="Delete（删除）"><a href="#Delete（删除）" class="headerlink" title="Delete（删除）"></a>Delete（删除）</h6><ul><li>指定 ID 删除</li></ul><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">DELETE</span> <span class="string">/my_index/_doc/1</span></span><br></pre></td></tr></table></figure></li><li><h6 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h6><p>上面讲的都是对单文档进行操作，多文档批量操作可自行去翻看官网文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/docs.html">Document APIs</a></p></li></ul><h5 id="7-Elasticsearch-SQL"><a href="#7-Elasticsearch-SQL" class="headerlink" title="(7) Elasticsearch SQL"></a>(7) Elasticsearch SQL</h5><p><strong>用法示例</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">_sql?format=txt</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&quot;SELECT Carrier FROM kibana_sample_data_flights LIMIT 100&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>将 SQL 转化为 DSL</strong></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">POST</span> <span class="string">_sql/translate</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;query&quot;</span>: <span class="string">&quot;SELECT Carrier FROM kibana_sample_data_flights LIMIT 100&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 转换结果如下</span></span><br><span class="line"><span class="attr">&#123;</span></span><br><span class="line">  <span class="meta">&quot;size&quot;</span> : <span class="string">100,</span></span><br><span class="line">  <span class="meta">&quot;_source&quot;</span> : <span class="string">false,</span></span><br><span class="line">  <span class="meta">&quot;stored_fields&quot;</span> : <span class="string">&quot;_none_&quot;,</span></span><br><span class="line">  <span class="meta">&quot;docvalue_fields&quot;</span> : <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;field&quot;</span> : <span class="string">&quot;Carrier&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">&quot;sort&quot;</span> : <span class="string">[</span></span><br><span class="line">    <span class="attr">&#123;</span></span><br><span class="line">      <span class="meta">&quot;_doc&quot;</span> : <span class="string">&#123;</span></span><br><span class="line">        <span class="meta">&quot;order&quot;</span> : <span class="string">&quot;asc&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">]</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="2-Mapping之字段类型"><a href="#2-Mapping之字段类型" class="headerlink" title="2. Mapping之字段类型"></a>2. Mapping之字段类型</h4><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B.png"></p><h5 id="1-基本类型"><a href="#1-基本类型" class="headerlink" title="(1) 基本类型"></a>(1) 基本类型</h5><ul><li><h6 id="string-字符串类型"><a href="#string-字符串类型" class="headerlink" title="string (字符串类型)"></a>string (字符串类型)</h6><p><code>string类型在ElasticSearch 旧版本中使用较多，从ElasticSearch 5.x开始不再支持string，由text和keyword类型替代。</code></p><ul><li><p><strong>text</strong></p><p>文本类型,在索引文件中，存储的不是原字符串，而是使用分词器对内容进行分词处理后得到一系列的词根，然后一一存储在index的倒排索引中。当一个字段是要被全文搜索的，比如Email内容、产品描述，应该使用text类型。设置text类型以后，字段内容会被分析，在生成倒排索引以前，字符串会被分析器分成一个一个词项。text类型的字段不用于排序，很少用于聚合。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line"><span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line"><span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line"><span class="attr">&quot;store&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>keyword</strong></p><p>关键字类型，将原始输入内容当成一个词根存储在倒排索引中，与text字段的区别是该字段不会使用分词器进行分词。 keyword类型适用于索引结构化的字段，比如email地址、主机名、状态码和标签。如果字段需要进行过滤(比如查找已发布博客中status属性为published的文章)、排序、聚合。keyword类型的字段只能通过精确值搜索到。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;foo&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><h6 id="numeric-datatypes-数字类型"><a href="#numeric-datatypes-数字类型" class="headerlink" title="numeric datatypes(数字类型)"></a>numeric datatypes(数字类型)</h6><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E6%95%B4%E6%95%B0%E7%B1%BB%E5%9E%8B.png"></p><p>在满足需求的情况下，尽可能选择范围小的数据类型。比如，某个字段的取值最大值不会超过100，那么选择byte类型即可。迄今为止吉尼斯记录的人类的年龄的最大值为134岁，对于年龄字段，short足矣。字段的长度越短，索引和搜索的效率越高。</p></li><li><h6 id="浮点类型"><a href="#浮点类型" class="headerlink" title="浮点类型"></a>浮点类型</h6><p><img src="https://gitee.com/lemon-cs/images/raw/master/%E6%B5%AE%E7%82%B9%E7%B1%BB%E5%9E%8B.png"></p><p>对于float、half_float和scaled_float,-0.0和+0.0是不同的值，使用term查询查找-0.0不会匹配+0.0，同样range查询中上边界是-0.0不会匹配+0.0，下边界是+0.0不会匹配-0.0。</p><p>其中scaled_float，比如价格只需要精确到分，price为57.34的字段缩放因子为100，存起来就是5734<br>优先考虑使用带缩放因子的scaled_float浮点类型。</p></li><li><h6 id="date-日期类型"><a href="#date-日期类型" class="headerlink" title="date(日期类型)"></a>date(日期类型)</h6><p>日期类型表示格式可以是以下几种：</p><blockquote><ol><li>日期格式的字符串，比如 “2018-01-13” 或 “2018-01-13 12:10:30”</li><li>long类型的毫秒数( milliseconds-since-the-epoch，epoch就是指UNIX诞生的UTC时间1970年1月1日0时0分0秒)</li><li>integer的秒数(seconds-since-the-epoch)</li></ol></blockquote><p>ElasticSearch 内部会将日期数据转换为UTC，并存储为milliseconds-since-the-epoch的long型整数。<br>例子：日期格式数据</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;postdate&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>:<span class="string">&quot;date&quot;</span>,</span><br><span class="line">    <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><h6 id="boolean类型"><a href="#boolean类型" class="headerlink" title="boolean类型"></a>boolean类型</h6><p>逻辑类型（布尔类型）可以接受true/false/”true”/”false”值</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;empty&quot;</span>:&#123;</span><br><span class="line">               <span class="string">&quot;type&quot;</span>:<span class="string">&quot;boolean&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></li><li><h6 id="binary类型"><a href="#binary类型" class="headerlink" title="binary类型"></a>binary类型</h6><p>二进制字段是指用base64来表示索引中存储的二进制数据，可用来存储二进制形式的数据，例如图像。默认情况下，该类型的字段只存储不索引。二进制类型只支持index_name属性。</p></li><li><h6 id="range-datatype"><a href="#range-datatype" class="headerlink" title="range datatype"></a>range datatype</h6><p>数据范围类型，一个字段表示一个范围，具体包含如下类型：</p><ul><li>integer_range</li><li>float_range</li><li>double_range</li><li>date_range</li><li>ip_range</li></ul><p>所谓的范围类型，就是一个值自身就代表一个范围，例如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT range_index</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"> <span class="number">4</span>    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"> <span class="number">6</span>        <span class="string">&quot;expected_attendees&quot;</span>: &#123;</span><br><span class="line"> <span class="number">7</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer_range&quot;</span></span><br><span class="line"> <span class="number">8</span>        &#125;</span><br><span class="line"> <span class="number">9</span>      &#125;</span><br><span class="line"><span class="number">10</span>    &#125;</span><br><span class="line"><span class="number">11</span>  &#125;</span><br><span class="line"><span class="number">12</span>&#125;</span><br></pre></td></tr></table></figure><p>其索引数据时：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">index_mapping_integer_range</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"> <span class="number">2</span>        RestHighLevelClient client = EsClient.getClient();</span><br><span class="line"> <span class="number">3</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">4</span>            IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;mapping_test_ranger&quot;</span>, <span class="string">&quot;_doc&quot;</span>);</span><br><span class="line"> <span class="number">5</span>            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> <span class="number">6</span>            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Integer&gt; pd = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> <span class="number">7</span>            pd.put(<span class="string">&quot;gte&quot;</span>, <span class="number">10</span>);</span><br><span class="line"> <span class="number">8</span>            pd.put(<span class="string">&quot;lte&quot;</span>, <span class="number">20</span>);</span><br><span class="line"> <span class="number">9</span>            data.put(<span class="string">&quot;expected_attendees&quot;</span>, pd);</span><br><span class="line"><span class="number">10</span>            request.source(data);</span><br><span class="line"><span class="number">11</span>            System.out.println(client.index(request, RequestOptions.DEFAULT));</span><br><span class="line"><span class="number">12</span>        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"><span class="number">13</span>            e.printStackTrace();</span><br><span class="line"><span class="number">14</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">15</span>            EsClient.close(client);</span><br><span class="line"><span class="number">16</span>        &#125;</span><br><span class="line"><span class="number">17</span>    &#125;</span><br></pre></td></tr></table></figure><p>搜索方式：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">search_integer_range</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"> <span class="number">2</span>        RestHighLevelClient client = EsClient.getClient();</span><br><span class="line"> <span class="number">3</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">4</span>            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line"> <span class="number">5</span>            searchRequest.indices(<span class="string">&quot;mapping_test_ranger&quot;</span>);</span><br><span class="line"> <span class="number">6</span>            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"> <span class="number">7</span>            sourceBuilder.query(</span><br><span class="line"> <span class="number">8</span>                     <span class="comment">//QueryBuilders.matchAllQuery()   </span></span><br><span class="line"> <span class="number">9</span>                     <span class="comment">//QueryBuilders.termQuery(&quot;expected_attendees&quot;, 12)           // @1</span></span><br><span class="line"><span class="number">10</span>            <span class="comment">//      QueryBuilders.rangeQuery(&quot;expected_attendees&quot;).lte(30).gte(19) // @2</span></span><br><span class="line"><span class="number">11</span>                    QueryBuilders.rangeQuery(<span class="string">&quot;expected_attendees&quot;</span>).lte(<span class="number">30</span>).gte(<span class="number">21</span>) <span class="comment">// @3</span></span><br><span class="line"><span class="number">12</span>            ); </span><br><span class="line"><span class="number">13</span>            searchRequest.source(sourceBuilder);</span><br><span class="line"><span class="number">14</span>            SearchResponse result = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"><span class="number">15</span>            System.out.println(result);</span><br><span class="line"><span class="number">16</span>        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"><span class="number">17</span>            e.printStackTrace();</span><br><span class="line"><span class="number">18</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">19</span>            EsClient.close(client);</span><br><span class="line"><span class="number">20</span>        &#125;</span><br><span class="line"><span class="number">21</span>    &#125;</span><br></pre></td></tr></table></figure><p>代码@1：可以通过termQuery精确匹配。 代码@2：只有定义的范围中，任意一个值匹配查询条件，则文档匹配。 代码@3：不匹配文档。</p><p>range类型支持如下映射类型参数：co-erce、boost、index、store。</p></li></ul><h5 id="2-复合类型"><a href="#2-复合类型" class="headerlink" title="(2) 复合类型"></a>(2) <strong>复合类型</strong></h5><ul><li><h6 id="array"><a href="#array" class="headerlink" title="array"></a><strong>array</strong></h6><p>数组类型，不需要使用额外的类型定义，例如定义如下字段映射：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"><span class="number">2</span>      <span class="string">&quot;status_code&quot;</span>: &#123; </span><br><span class="line"><span class="number">3</span>     <span class="string">&quot;type&quot;</span>:       <span class="string">&quot;keyword&quot;</span>      <span class="comment">// 默认情况下，“doc_values”:true</span></span><br><span class="line"><span class="number">4</span>      &#125;</span><br><span class="line"><span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure><p>定义的类型为：keyword，在索引时是直接支持数组的。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">1<span class="built_in">String</span>[] keywords = <span class="keyword">new</span> <span class="built_in">String</span>[] &#123;<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;def&quot;</span>&#125;；</span><br><span class="line">2<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; source = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">3souce.put(<span class="string">&quot;status_code&quot;</span>,keywords )。</span><br></pre></td></tr></table></figure></li><li><h6 id="Object-datatype"><a href="#Object-datatype" class="headerlink" title="Object datatype"></a>Object datatype</h6><p>数据类型，对象或json对象字符串。</p></li><li><h6 id="Nested-datatype"><a href="#Nested-datatype" class="headerlink" title="Nested datatype"></a>Nested datatype</h6><p>嵌套数据类型，用于关联查询。</p></li><li><h6 id="Geo-datatypes"><a href="#Geo-datatypes" class="headerlink" title="Geo datatypes"></a>Geo datatypes</h6><p>地图数据类型。</p></li><li><h6 id="geo-point"><a href="#geo-point" class="headerlink" title="geo_point"></a>geo_point</h6><p>地图坐标；存储经纬度。其使用场景：</p><ol><li>Geo Bounding Box Query 找出落在指定矩形框中的坐标点</li><li>Geo Distance Query 找出与指定位置在给定距离内的点</li><li>找出与指定点距离在给定最小距离和最大)距离之间的点</li><li>Geo Polygon Query 查找包含在多边形范围内的文档 与地理位置相关的查询，将在整个SearchAPI讲解完成后再详细学习。</li></ol></li><li><h6 id="geo-shape-datatype"><a href="#geo-shape-datatype" class="headerlink" title="geo_shape datatype"></a>geo_shape datatype</h6><p>geo_shape数据类型方便了对任意地理形状(如矩形和多边形)进行索引和搜索。当正在索引的数据或正在执行的查询包含除了点以外的形状时应该使用它。</p></li></ul><h5 id="3-特定类型"><a href="#3-特定类型" class="headerlink" title="(3) 特定类型"></a>(3) 特定类型</h5><ul><li><h6 id="ip类型"><a href="#ip类型" class="headerlink" title="ip类型"></a>ip类型</h6><p>IP地址类型。可以存储和索引ipv4、ipv6的IP地址。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT my_index</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"> <span class="number">4</span>    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"> <span class="number">6</span>        <span class="string">&quot;ip_addr&quot;</span>: &#123;</span><br><span class="line"> <span class="number">7</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span></span><br><span class="line"> <span class="number">8</span>        &#125;</span><br><span class="line"> <span class="number">9</span>      &#125;</span><br><span class="line"><span class="number">10</span>    &#125;</span><br><span class="line"><span class="number">11</span>  &#125;</span><br><span class="line"><span class="number">12</span>&#125;</span><br><span class="line"><span class="number">13</span></span><br><span class="line">14PUT my_index/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">15</span>&#123;</span><br><span class="line"><span class="number">16</span>  <span class="string">&quot;ip_addr&quot;</span>: <span class="string">&quot;192.168.1.1&quot;</span></span><br><span class="line"><span class="number">17</span>&#125;</span><br><span class="line">18GET my_index/_search</span><br><span class="line"><span class="number">19</span>&#123;</span><br><span class="line"><span class="number">20</span>  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line"><span class="number">21</span>    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line"><span class="number">22</span>      <span class="string">&quot;ip_addr&quot;</span>: <span class="string">&quot;192.168.0.0/16&quot;</span></span><br><span class="line"><span class="number">23</span>    &#125;</span><br><span class="line"><span class="number">24</span>  &#125;</span><br><span class="line"><span class="number">25</span>&#125;</span><br></pre></td></tr></table></figure></li><li><h6 id="Completion-datatype"><a href="#Completion-datatype" class="headerlink" title="Completion datatype"></a><strong>Completion datatype</strong></h6><p>类型值：completion ;为了优化在查找时输入自动补全而设计的类型，输入自动补全会在查询部分专题详解。</p></li><li><h6 id="Token-count-datatype"><a href="#Token-count-datatype" class="headerlink" title="Token count datatype"></a><strong>Token count datatype</strong></h6><p>类型值：token_count，再接收一个字符串经过分析后将返回词根的个数，举例说明如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT my_index</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"> <span class="number">4</span>    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"> <span class="number">6</span>        <span class="string">&quot;name&quot;</span>: &#123; </span><br><span class="line"> <span class="number">7</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line"> <span class="number">8</span>          <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line"> <span class="number">9</span>            <span class="string">&quot;length&quot;</span>: &#123;  <span class="comment">// 为name定义的另外一个映射方式，其原始输入值还是name字段。</span></span><br><span class="line"><span class="number">10</span>              <span class="string">&quot;type&quot;</span>:     <span class="string">&quot;token_count&quot;</span>,     <span class="comment">// @1</span></span><br><span class="line"><span class="number">11</span>              <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>        <span class="comment">// @2</span></span><br><span class="line"><span class="number">12</span>            &#125;</span><br><span class="line"><span class="number">13</span>          &#125;</span><br><span class="line"><span class="number">14</span>        &#125;</span><br><span class="line"><span class="number">15</span>      &#125;</span><br><span class="line"><span class="number">16</span>    &#125;</span><br><span class="line"><span class="number">17</span>  &#125;</span><br><span class="line"><span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure><p>@1：定义name.length字段，其类型为token_count，使用标准分词器对原始字段name的值进行分析，返回返回分析后的词根个数。 @2：分词器。</p><p>查询示例：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT my_index/_doc/<span class="number">1</span></span><br><span class="line"> <span class="number">2</span>&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Smith&quot;</span> &#125;</span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> 4PUT my_index/_doc/<span class="number">2</span></span><br><span class="line"> <span class="number">5</span>&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Rachel Alice Williams&quot;</span> &#125;</span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> 7GET my_index/_search</span><br><span class="line"> <span class="number">8</span>&#123;</span><br><span class="line"> <span class="number">9</span>  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line"><span class="number">10</span>    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line"><span class="number">11</span>      <span class="string">&quot;name.length&quot;</span>: <span class="number">3</span> </span><br><span class="line"><span class="number">12</span>    &#125;</span><br><span class="line"><span class="number">13</span>  &#125;</span><br><span class="line"><span class="number">14</span>&#125;</span><br></pre></td></tr></table></figure><p>该查询条件能匹配_doc/2，因为name字段的值经过标准分词器分词后，能得到3个词根,与”name.length”:3匹配。</p></li><li><h6 id="join-datatype"><a href="#join-datatype" class="headerlink" title="join datatype"></a><strong>join datatype</strong></h6><p>类型值:join。join类型允许在同一个索引中（同一个类型type）中定义多个不同类型的文档（例如学生文档、班级文档-）这些类型是个一对多关联关系（父子级联关系）。</p><p>下面根据示例来学习join type，下面先创建一个join的映射。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT my_index</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"> <span class="number">4</span>    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"> <span class="number">6</span>        <span class="string">&quot;my_join_field&quot;</span>: &#123;       <span class="comment">// @1</span></span><br><span class="line"> <span class="number">7</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;join&quot;</span>,</span><br><span class="line"> <span class="number">8</span>          <span class="string">&quot;relations&quot;</span>: &#123;          <span class="comment">// @2</span></span><br><span class="line"> <span class="number">9</span>            <span class="string">&quot;question&quot;</span>: <span class="string">&quot;answer&quot;</span>     </span><br><span class="line"><span class="number">10</span>          &#125;</span><br><span class="line"><span class="number">11</span>        &#125;</span><br><span class="line"><span class="number">12</span>      &#125;</span><br><span class="line"><span class="number">13</span>    &#125;</span><br><span class="line"><span class="number">14</span>  &#125;</span><br><span class="line"><span class="number">15</span>&#125;</span><br></pre></td></tr></table></figure><p>代码@1：定义join字段名称。 代码@2：通过relations字段来定义父子关系，其定义方式为 “父实例名称” : “子实例名称”，question是answer的父类型。 索引父文档的方式如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT my_index/_doc/<span class="number">1</span>?refresh</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;This is a question&quot;</span>,</span><br><span class="line"> <span class="number">4</span>  <span class="string">&quot;my_join_field&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;question&quot;</span> </span><br><span class="line"> <span class="number">6</span>  &#125;</span><br><span class="line"> <span class="number">7</span>&#125;</span><br><span class="line"> 8PUT my_index/_doc/<span class="number">2</span>?refresh</span><br><span class="line"> <span class="number">9</span>&#123;</span><br><span class="line"><span class="number">10</span>  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;This is a another question&quot;</span>,</span><br><span class="line"><span class="number">11</span>  <span class="string">&quot;my_join_field&quot;</span>: &#123;</span><br><span class="line"><span class="number">12</span>    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;question&quot;</span></span><br><span class="line"><span class="number">13</span>  &#125;</span><br><span class="line"><span class="number">14</span>&#125;</span><br></pre></td></tr></table></figure><p>索引父文档时，在souce字段中必须指定其关系，例如”name”: “question”，上述索引，用JAVA实现如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">createMapping_join_demo</span>(<span class="params"></span>)</span> &#123; <span class="comment">// 创建映射</span></span><br><span class="line"> <span class="number">2</span>        RestHighLevelClient client = EsClient.getClient();</span><br><span class="line"> <span class="number">3</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">4</span>            CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;map_test_join&quot;</span>);</span><br><span class="line"> <span class="number">5</span>            <span class="built_in">Map</span> relations = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> <span class="number">6</span>            relations.put(<span class="string">&quot;question&quot;</span>, <span class="string">&quot;answer&quot;</span>);</span><br><span class="line"> <span class="number">7</span>            XContentBuilder jsonBuilder = XContentFactory.jsonBuilder()</span><br><span class="line"> <span class="number">8</span>                                            .startObject()</span><br><span class="line"> <span class="number">9</span>                                                .startObject(<span class="string">&quot;properties&quot;</span>)</span><br><span class="line"><span class="number">10</span>                                                    .startObject(<span class="string">&quot;text&quot;</span>)</span><br><span class="line"><span class="number">11</span>                                                        .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;text&quot;</span>)</span><br><span class="line"><span class="number">12</span>                                                    .endObject()</span><br><span class="line"><span class="number">13</span>                                                    .startObject(<span class="string">&quot;my_join_field&quot;</span>)</span><br><span class="line"><span class="number">14</span>                                                        .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;join&quot;</span>)</span><br><span class="line"><span class="number">15</span>                                                        .field(<span class="string">&quot;relations&quot;</span>, relations)</span><br><span class="line"><span class="number">16</span>                                                    .endObject()</span><br><span class="line"><span class="number">17</span>                                                .endObject()</span><br><span class="line"><span class="number">18</span>                                            .endObject();</span><br><span class="line"><span class="number">19</span>            request.mapping(<span class="string">&quot;_doc&quot;</span>, jsonBuilder);</span><br><span class="line"><span class="number">20</span>            System.out.println(client.indices().create(request, RequestOptions.DEFAULT));</span><br><span class="line"><span class="number">21</span>        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"><span class="number">22</span>            e.printStackTrace();</span><br><span class="line"><span class="number">23</span>        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="number">24</span>            EsClient.close(client);</span><br><span class="line"><span class="number">25</span>        &#125;</span><br><span class="line"><span class="number">26</span>    &#125;</span><br><span class="line"><span class="number">27</span>       <span class="comment">// 下面是构建souce字段，必须包含my_join_field，指明是父文档还是子文档。</span></span><br><span class="line">28<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; data1 = <span class="keyword">new</span> HashMap();</span><br><span class="line"><span class="number">29</span>    data1.put(<span class="string">&quot;text&quot;</span>,<span class="string">&quot;This is a another question&quot;</span>);</span><br><span class="line"><span class="number">30</span>    <span class="built_in">Map</span> my_join_field = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="number">31</span>    my_join_field.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;question&quot;</span>);</span><br><span class="line"><span class="number">32</span>    data1.put(<span class="string">&quot;my_join_field&quot;</span>,my_join_field);</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="number">34</span><span class="comment">//索引子文档时，必须通过parent指定父文档ID，并且其routing字段需要设置为父文档ID，确保父子文档在同一个分片上。</span></span><br><span class="line">35PUT my_index/_doc/<span class="number">3</span>?routing=<span class="number">1</span>&amp;refresh </span><br><span class="line"><span class="number">36</span>&#123;</span><br><span class="line"><span class="number">37</span>  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;This is an answer&quot;</span>,</span><br><span class="line"><span class="number">38</span>  <span class="string">&quot;my_join_field&quot;</span>: &#123;</span><br><span class="line"><span class="number">39</span>    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;answer&quot;</span>, </span><br><span class="line"><span class="number">40</span>    <span class="string">&quot;parent&quot;</span>: <span class="string">&quot;1&quot;</span> </span><br><span class="line"><span class="number">41</span>  &#125;</span><br><span class="line"><span class="number">42</span>&#125;</span><br></pre></td></tr></table></figure><p>关于join字段的查询，将在DSL Join ty-pe相关查询时重点介绍。</p></li><li><h6 id="Alias-datatype"><a href="#Alias-datatype" class="headerlink" title="Alias datatype"></a><strong>Alias datatype</strong></h6><p>类型值为：alias，可以字段指定别名，其映射定义方式如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> 1PUT trips</span><br><span class="line"> <span class="number">2</span>&#123;</span><br><span class="line"> <span class="number">3</span>  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"> <span class="number">4</span>    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line"> <span class="number">5</span>      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"> <span class="number">6</span>        <span class="string">&quot;distance&quot;</span>: &#123;</span><br><span class="line"> <span class="number">7</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line"> <span class="number">8</span>        &#125;,</span><br><span class="line"> <span class="number">9</span>        <span class="string">&quot;route_length_miles&quot;</span>: &#123;</span><br><span class="line"><span class="number">10</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;alias&quot;</span>,</span><br><span class="line"><span class="number">11</span>          <span class="string">&quot;path&quot;</span>: <span class="string">&quot;distance&quot;</span> <span class="comment">// @1</span></span><br><span class="line"><span class="number">12</span>        &#125;,</span><br><span class="line"><span class="number">13</span>        <span class="string">&quot;transit_mode&quot;</span>: &#123;</span><br><span class="line"><span class="number">14</span>          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="number">15</span>        &#125;</span><br><span class="line"><span class="number">16</span>      &#125;</span><br><span class="line"><span class="number">17</span>    &#125;</span><br><span class="line"><span class="number">18</span>  &#125;</span><br><span class="line"><span class="number">19</span>&#125;</span><br></pre></td></tr></table></figure><p>通过使用path来指定是哪个字段的别名。</p></li></ul><h3 id="2-3-DSL语法和搜索"><a href="#2-3-DSL语法和搜索" class="headerlink" title="2.3-DSL语法和搜索"></a>2.3-DSL语法和搜索</h3><p>Elasticsearch提供了一个基于JSON的完整查询DSL（领域特定语言）来定义查询。把查询DSL看作是查询的AST（抽象语法树），由两种类型的子句组成：</p><ul><li>Leaf query clauses(叶查询字句)</li></ul><p>叶子查询子句指在特定的字段中寻找特定的值，例如匹配、范围查询或term(完全匹配)。这些查询可以单独使用。</p><ul><li>Compound query clauses（复合查询字句）</li></ul><p>复合查询字句包装其他叶子或复合字句，用于以逻辑方式组合多个查询（如bool、dis_max）或改变他们的行为（如常量查询）。</p><p>查询子句的行为取决于它是在查询上下文中使用还是在过滤上下文中使用：</p><ul><li>查询上下文</li></ul><p>在查询上下文中使用的查询子句，查询字句回答了“这个文档与这个查询子句(查询条件)匹配得有多好？”除了决定文档是否匹配之外，查询子句还计算一个分数，表示相对与其他文档该文档匹配的程度。每当一个查询子句传递给查询参数（query）时，查询上下文就会生效，比如搜索API中的查询参数。</p><ul><li>过滤上下文</li></ul><p>在过滤上下文中，查询子句回答“这个文档是否匹配这个查询子句？”答案是简单的“是”或“否”——没有计算出分数。过滤上下文主要用于过滤结构化数据（相当与<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cdb-overview?from=10680">关系型数据库</a>的过滤条件）。例如这个时间戳是否会在2015年到2016年之间？文章的状态是为“发布”吗？等等。</p><p>经常使用的过滤器(filter context)会被Elasticsearch自动缓存，以提高性能。每当一个查询子句被传递给过滤器参数（filter）时，过滤器上下文就会生效，例如bool查询中的filter或must_not参数、或filter查询中的常量查询(constant_score)或filter查询。</p><p>举例如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;query&quot;</span>: &#123;         <span class="comment">// @1</span></span><br><span class="line">       <span class="string">&quot;bool&quot;</span>: &#123;     <span class="comment">// @2</span></span><br><span class="line">             <span class="string">&quot;must&quot;</span>: [  </span><br><span class="line">                       &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;title&quot;</span>:   <span class="string">&quot;Search&quot;</span>        &#125;&#125;,           <span class="comment">// @3</span></span><br><span class="line">                    &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Elasticsearch&quot;</span> &#125;&#125;          <span class="comment">// @4</span></span><br><span class="line">             ],</span><br><span class="line">             <span class="string">&quot;filter&quot;</span>: [     <span class="comment">// @5</span></span><br><span class="line">                   &#123; <span class="string">&quot;term&quot;</span>:  &#123; <span class="string">&quot;status&quot;</span>: <span class="string">&quot;published&quot;</span> &#125;&#125;,         <span class="comment">// @6                  </span></span><br><span class="line">                               &#123; <span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;publish_date&quot;</span>: &#123; <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2015-01-01&quot;</span> &#125;&#125;&#125;   <span class="comment">// @7</span></span><br><span class="line">                ]</span><br><span class="line">         &#125; <span class="comment">// end bool</span></span><br><span class="line">   &#125;  <span class="comment">// end query</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码@1：query参数定义查询上下文，query参数为elasticsearch的查询上下文。</p><p>代码@2：使用elasticsearch的bool查询表达式，会在后续详细介绍。</p><p>代码@3：查询上下文，使用关键字match，表示title字段中包含”Search”字符即认为匹配。（可以类比关系型数据库 a.title like ‘%Search%’）</p><p>代码@4：查询上下文，使用关键字match，表示content字段中包含”Elasticsearch”字符即认为匹配。</p><p>代码@5：定义过滤上下文。</p><p>代码@6：使用term(完整匹配)，即status字段的值是否是“published”。（相当于关系型数据库的 a.status = ‘published’）</p><p>代码@7：使用range，代表范围匹配，即publish_date字段的值是否大于等于2015-01-01。(相当于a.publish_date &gt;= 2015-01-01’)。</p><h4 id="1-全文检索"><a href="#1-全文检索" class="headerlink" title="1. 全文检索"></a>1. 全文检索</h4><ul><li><p>match query</p><p>标准的全文检索模式，包含模糊匹配、前缀或近似匹配等。</p></li><li><p>match_phrase query</p><p>与match query类似，但只是用来精确匹配的短语。</p></li><li><p>match_phrase_prefix query</p><p>与match_phrase查询类似，但是在最后一个单词上执行通配符搜索。</p></li><li><p>multi_match query</p><p>支持多字段的match query。</p></li><li><p>common terms query</p><p>相比match query，消除停用词与高频词对相关度的影响。</p></li><li><p>query_string query</p><p>查询字符串方式。</p></li><li><p>simple_query_string query</p><p>简单查询字符串方式。</p></li></ul><h5 id="（1）match-query详解"><a href="#（1）match-query详解" class="headerlink" title="（1）match query详解"></a>（1）match query详解</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"># 查询所有</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询固定条数(默认size=<span class="number">10</span>)</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询从<span class="number">10</span>-<span class="number">15</span>条数据(<span class="keyword">from</span>默认从<span class="number">0</span>开始)</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">&quot;form&quot;</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 按某字段(时间)排序,desc降序，asc升序</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  , <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 只查询某些字段</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  , <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;@timestamp&quot;</span>, <span class="string">&quot;index&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>全文索引查询，这意外着首先会对待查字符串（查询条件）进行分词，然后再去匹配，返回结果中会待上本次匹配的关联度分数。</p><p>例如存在这样一条数据：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;_source&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;post_date&quot;</span>:<span class="string">&quot;2009-11-16T14:12:12&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>:<span class="string">&quot;trying out Elasticsearch&quot;</span>,</span><br><span class="line">   <span class="string">&quot;user&quot;</span>:<span class="string">&quot;dingw2&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询字符串：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;query&quot;</span>: &#123;        </span><br><span class="line">   <span class="string">&quot;match&quot;</span> : &#123;            </span><br><span class="line">         <span class="string">&quot;message&quot;</span> : <span class="string">&quot;this out Elasticsearch&quot;</span>        </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其JAVA代码对应：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;this out elasticsearch&quot;</span>));</span><br></pre></td></tr></table></figure><p>其大体步骤如下：</p><p>首先对this out Elasticsearch分词，最终返回结果为 this、out、Elasticsearch，然后分别去库中进行匹配，默认只要一个匹配，就认为匹配，但会加入一个匹配程度（关联度），用scoce分数表示。</p><p><strong>match query常用参数详解:</strong></p><ul><li>operator（操作类型） 可选值为：Operator.OR 和 Operator.AND。表示对查询字符串分词后，返回的词根列表，OR只需一个满足及认为匹配，而AND则需要全部词根都能匹配，默认值为：Operator.OR。</li><li>minimum_should_match 最少需要匹配个数。在操作类型为Operator.OR时生效，指明分词后的词根，至少minimum_should_match 个词根匹配，则命中。</li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;match&quot;</span> : &#123;        </span><br><span class="line">   <span class="string">&quot;message&quot;</span> : <span class="string">&quot;this out Elasticsearch&quot;</span>，</span><br><span class="line">   “minimum_should_match ”：“<span class="number">3</span>”        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时由于this词根并不在原始数据”trying out Elasticsearch”中，又要求必须匹配的词根个数为3，故本次查询，无法命中。minimum_should_match 可选值如下：</p><table><thead><tr><th align="left">Type</th><th align="left">Example</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">Integer</td><td align="left">3</td><td align="left">直接数字，不考虑查询字符串分词后的个数。如果分词的个数小于3个，则无法匹配到任何条目。</td></tr><tr><td align="left">Negative integer</td><td align="left">-2</td><td align="left">负数表示最多不允许不匹配的个数。也就是需要匹配的个数为(total-2)。</td></tr><tr><td align="left">Percentage</td><td align="left">75%</td><td align="left">百分比，表示需要匹配的词根占总数的百分比。</td></tr><tr><td align="left">Negative percentage</td><td align="left">-25%</td><td align="left">允许不匹配的个数占总数的百分比。</td></tr><tr><td align="left">Combination</td><td align="left">3&lt;90%</td><td align="left">如果查询字符串分词的个数小于等于3（前面的整数），则只要全部匹配则返回，如果分词的个数大于3个，则只要90%的匹配即可。</td></tr><tr><td align="left">Multiple combinations</td><td align="left">2&lt;-25% 9&lt;-3</td><td align="left">支持多条件表达式，中间用空格分开。该表达式的意义如下：1、如果分词的个数小于等于2，则必须全部匹配；如果大于2小于9，则除了25%（注意负号）之外都需要满足。2、如果大于9个，则只允许其中3个不满足。</td></tr></tbody></table><ul><li>analyzer</li></ul><p>设置分词器，默认使用字段映射中定义的分词器或elasticsearch默认的分词器。</p><ul><li>lenient</li></ul><p>是否忽略由于数据类型不匹配引起的异常，默认为false。例如尝试用文本查询字符串查询数值字段，默认会抛出错误。</p><ul><li>fuzziness</li></ul><p>模糊匹配。</p><ul><li>zero_terms_query</li></ul><p>默认情况下，如果分词器会过滤查询字句中的停用词，可能会造成查询字符串分词后变成空字符串，此时默认的行为是无法匹配到任何文档，如果想改变该默认情况，可以设置zero_terms_query=all，类似于match_all,默认值为none。</p><ul><li>cutoff_frequency</li></ul><p>match查询支持cutoff_frequency，允许指定绝对或相对的文档频率：</p><ul><li>OR：高频单词被放入“或许有”的类别，仅在至少有一个低频（低于cutoff_frequency）单词满足条件时才积分；</li><li>AND：高频单词被放入“或许有”的类别，仅在所有低频（低于cutoff_frequency）单词满足条件时才积分。该查询允许在运行时动态处理停用词而不需要使用停用词文件。它阻止了对高频短语（停用词）的评分/迭代，并且只在更重要/更低频率的短语与文档匹配时才会考虑这些文档。然而，如果所有查询条件都高于给定的cutoff_frequency，则查询将自动转换为纯连接(and)查询，以确保快速执行。</li></ul><p>cutoff_frequency取值是相对于文档的总数的小数[0..1)，也可以是绝对值[1, +∞)。</p><ul><li>Synonyms（同义词）</li></ul><p>可在分词器中定义同义词，具体同义词将在后续章节中会单独介绍。</p><p><strong>match query示例:</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">testMatchQuery</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">       RestHighLevelClient client = EsClient.getClient();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">           searchRequest.indices(<span class="string">&quot;twitter&quot;</span>);</span><br><span class="line">           SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">           sourceBuilder.query(</span><br><span class="line">                   QueryBuilders.matchQuery(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;is out Elasticsearch&quot;</span>)</span><br><span class="line">                       .zeroTermsQuery(ZeroTermsQuery.ALL)</span><br><span class="line">                       .operator(Operator.OR)</span><br><span class="line">                       .minimumShouldMatch(<span class="string">&quot;4&lt;90%&quot;</span>)</span><br><span class="line">                   ).sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;post_date&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                    .docValueField(<span class="string">&quot;post_date&quot;</span>, <span class="string">&quot;epoch_millis&quot;</span>);</span><br><span class="line">           searchRequest.source(sourceBuilder);</span><br><span class="line">           SearchResponse result = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">           System.out.println(result);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           EsClient.close(client);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h5 id="（2）match-phrase"><a href="#（2）match-phrase" class="headerlink" title="（2）match_phrase"></a>（2）match_phrase</h5><p>与match query类似，但只是用来精确匹配的短语。</p><p>其主要工作流程：</p><p>首先，Elasticsearch(lucene)会使用分词器对全文本进行分词（返回一个一个的词根（顺序排列）），然后同样使用分词器对查询字符串进行分析，返回一个一个的词根（顺序性）。如果能在全字段中能够精确找到与查询字符串通用的词根序列，则认为匹配，否则认为不匹配。</p><p>举例如下：</p><p>如果原文字段message:”quick brown fox test we will like to you”,则使用标准分词器(analyzer=standard)返回的结果如下：</p><p>使用命令：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;192.168.1.10:9200/_analyze&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> &quot;tokenizer&quot; : &quot;standard&quot;,</span></span><br><span class="line"><span class="string"> &quot;text&quot; : &quot;quick brown fox test we will like to you&quot;,</span></span><br><span class="line"><span class="string"> &quot;attributes&quot; : [&quot;keyword&quot;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>得出如下结果：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;tokens&quot;</span>:[</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;quick&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">0</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">5</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;brown&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">6</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">11</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">1</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;fox&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">12</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">15</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">2</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">16</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">20</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">3</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;we&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">21</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">23</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">4</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;will&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">24</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">28</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">5</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;like&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">29</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">33</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">6</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;to&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">34</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">36</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">7</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">&quot;token&quot;</span>:<span class="string">&quot;you&quot;</span>,</span><br><span class="line">           <span class="string">&quot;start_offset&quot;</span>:<span class="number">37</span>,</span><br><span class="line">           <span class="string">&quot;end_offset&quot;</span>:<span class="number">40</span>,</span><br><span class="line">           <span class="string">&quot;type&quot;</span>:<span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">           <span class="string">&quot;position&quot;</span>:<span class="number">8</span></span><br><span class="line">       &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其词根具有顺序性（词根序列）为quick、brown、fox、test 、we 、will、 like、 to 、you</p><p>如果查询字符串为 quick brown，分词后的词根序列为 quick brown，则是原词根序列的子集，则匹配。</p><p>如果查询字符串为 quick fox，分词后的词根序列为 quick fox，与原词根序列不匹配。如果指定slop属性，设置为1，则匹配，其表示每一个词根直接跳过一个词根形成新的序列，与搜索词根进行比较，是否匹配。</p><p>如果查询字符串为quick fox test,其特点是quick与原序列跳过一个词brown，但fox后面不跳过任何次，与test紧挨着，如果指定slop=1，同样能匹配到文档，但查询字符串quick fox test will，却匹配不到文档，说明slop表示整个搜索词根中为了匹配流，能跳过的最大次数。</p><p>按照match_phrase的定义，与match query的区别一个在与精确匹配，一个在于词组term（理解为词根序列），故match_phrase与match相比，不会有如下参数：fuzziness、cutoff_frequency、operator、minimum_should_match 这些参数。</p><h5 id="（3）match-phrase-prefix"><a href="#（3）match-phrase-prefix" class="headerlink" title="（3）match_phrase_prefix"></a>（3）match_phrase_prefix</h5><p>与match phrase基本相同，只是该查询模式会对最后一个词根进行前缀匹配。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;match_phrase_prefix&quot;</span> : &#123;</span><br><span class="line">           <span class="string">&quot;message&quot;</span> : &#123;</span><br><span class="line">               <span class="string">&quot;query&quot;</span> : <span class="string">&quot;quick brown f&quot;</span>,</span><br><span class="line">               <span class="string">&quot;max_expansions&quot;</span> : <span class="number">10</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其工作流程如下：首先先对除最后一个词进行分词，得到词根序列 quick brown，然后遍历整个elasticsearch倒排索引，查找以f开头的词根，依次组成多个词根流，例如(quick brown fox) (quick brown foot)，默认查找50组，受参数max_expansions控制，在使用时请设置合理的max_expansions，该值越大，查询速度将会变的更慢。该技术主要完成及时搜索，指用户在输入过程中，就根据前缀返回查询结果，随着用户输入的字符越多，查询的结果越接近用户的需求。</p><h5 id="（4）multi-match"><a href="#（4）multi-match" class="headerlink" title="（4）multi_match"></a>（4）multi_match</h5><p>multi_match查询建立在match查询之上，允许多字段查询。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;multi_match&quot;</span> : &#123;</span><br><span class="line">     <span class="string">&quot;query&quot;</span>:    <span class="string">&quot;this is a test&quot;</span>,</span><br><span class="line">     <span class="string">&quot;fields&quot;</span>: [ <span class="string">&quot;subject&quot;</span>, <span class="string">&quot;message&quot;</span> ]   <span class="comment">// @1</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@1执行作用（查询）的字段，有如下几种用法：</p><ol><li><p>[ “subject”, “message” ] ，表示针对查询自动对subject,message字段进行查询匹配。</p></li><li><p>[ “title”, “*<em>name” ]，支持通配符，表示对title，以</em>name结尾的字段进行查询匹配。</p></li><li><p>[ “subject^3”, “message” ]，表示subject字段是message的重要性的3倍，类似于字段权重</p></li></ol><h4 id="2-布尔查询"><a href="#2-布尔查询" class="headerlink" title="2. 布尔查询"></a>2. 布尔查询</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"># 匹配word包含中秋(两个字中有一个就能匹配)且index=<span class="number">2</span>的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>:&#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;中秋&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;index&quot;</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 匹配word包含中秋(两个字中有一个就能匹配)或index=<span class="number">2</span>的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>:&#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;中秋&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;index&quot;</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 匹配word不包含中秋(两个字中有一个就能匹配)且index=<span class="number">2</span>的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>:&#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;中秋&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;index&quot;</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 在bool中must,must_not,should等关键字可以混用,表示多条件同时满足</span><br><span class="line"># 匹配word包含中秋(两个字中有一个就能匹配)且index!=<span class="number">2</span>的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>:&#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;中秋&quot;</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">      , <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;index&quot;</span>: <span class="number">2</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-范围查询"><a href="#3-范围查询" class="headerlink" title="3. 范围查询"></a>3. <strong>范围查询</strong></h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 查询索引在<span class="number">11</span><span class="number">-20</span>之间的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-过滤查询-filters"><a href="#4-过滤查询-filters" class="headerlink" title="4. 过滤查询(filters)"></a>4. <strong>过滤查询(filters)</strong></h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"># 在Elasticsearch5.x版本中filtered方法弃用改用bool中的filter</span><br><span class="line"># 匹配日期在<span class="number">9</span>-<span class="number">12</span>到<span class="number">9</span>-<span class="number">24</span>日的数据</span><br><span class="line">GET /tmpl-word-log*/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;must&quot;</span>: &#123;<span class="string">&quot;match_all&quot;</span>: &#123;&#125;&#125;, </span><br><span class="line">        <span class="string">&quot;filter&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;@timestamp&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;gte&quot;</span>:<span class="string">&quot;2018-09-12T00:00:00.000+0800&quot;</span>,</span><br><span class="line">          <span class="string">&quot;lte&quot;</span>:<span class="string">&quot;2018-09-24T23:59:59.000+0800&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="5-分页查询"><a href="#5-分页查询" class="headerlink" title="5. 分页查询"></a>5. 分页查询</h4><h5 id="（1）from-size-分页"><a href="#（1）from-size-分页" class="headerlink" title="（1）from / size 分页"></a>（1）from / size 分页</h5><p>from - 表示起始位置，size - 表示每页数量；类似与 MySQL 的 limit + offset。<br>示例：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;from&quot;</span> : 10, <span class="string">&quot;size&quot;</span> : 10,</span><br><span class="line">    <span class="string">&quot;query&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span> : &#123; <span class="string">&quot;user&quot;</span> : <span class="string">&quot;kimchy&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是，from + size 不能超过10000，也就是说在前10000条之内，可以随意翻页，10000条之后就不行了。</p><p>实际上，通过设置 index.max_result_window 可以修改这个限制，但是不建议这么做，因为这种方式翻页越深效率越低。</p><p>原理：</p><p>Query阶段：</p><ol><li>当一个请求发送到某个ES节点时，该节点（Node1）会根据from和size，建立一个结果集窗口，窗口大小为from+size。假如from=10000,size=100，则窗口大小为10100。</li><li>此节点将请求广播到其他相关节点上，从每个Shards中取Top 10100条的score和id。</li><li>所有Shards获取的结果汇聚到Node1，假如有5个Shards，则一共会取到5 * 10100 = 50500条数据。</li><li>Node1进行归并排序，并选择Top 10100条，存入结果集窗口。</li></ol><p>Fetch阶段：<br>根据Query阶段得到的排序结果，从 from 位置取 size 条数据，抓取文档详细内容返回。</p><p>从此过程中可以看出，翻页越靠后，需要参与排序的文档就越多，效率也就越低。所以，如果结果集很大，不建议用这种分页方式。</p><h5 id="（2）使用-scroll-分页"><a href="#（2）使用-scroll-分页" class="headerlink" title="（2）使用 scroll 分页"></a>（2）使用 scroll 分页</h5><p>使用scroll就像传统数据库中的游标一样，方式如下：</p><p>第一步</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST /twitter/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 100,</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scroll=1m，表示“search context”存活时间1分钟。返回结果中会带有一个“_scroll_id”，这个值在后续的翻页过程中使用。</p><p>第二步</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;scroll&quot;</span> : <span class="string">&quot;1m&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scroll_id&quot;</span> : <span class="string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不用指定index和type，也不用其他查询条件，只要把上一步的_scroll_id即可。</p><p>之后翻页一直如此，每次执行会自动滚动100条数据，直到返回的结果为空为止。</p><p>每次执行间隔不要超过1分钟，否则“search context”会释放掉。</p><p>第三步</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DELETE /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;scroll_id&quot;</span> : <span class="string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果遍历完成后，删除scroll_id。这一步也可以不做，等1分钟后没有继续翻页请求，“search context”会自动释放掉，不过建议还是手动清除，节省资源。</p><p>优化：<br>如果目的是为了遍历所有结果，而不关心结果的顺序，那么可以按“_doc”排序来提高性能</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST /twitter/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 100,</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;sort&quot;</span>: [<span class="string">&quot;_doc&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与 from/size 分页方式不同，使用 scroll 分页只能单向顺序翻页，不能随机翻页，适用于遍历结果集的场景。</p><p>scroll 翻页能够深度翻页，但是翻页期间需要维护“search context”，这是需要占用一定资源的。</p><p>所以对于用户高并发访问的场景，不推荐用这种方式，scroll 更适用于批处理类的后台任务。</p><h5 id="（3）使用scroll-scan-的高效滚动"><a href="#（3）使用scroll-scan-的高效滚动" class="headerlink" title="（3）使用scroll-scan 的高效滚动"></a>（3）使用scroll-scan 的高效滚动</h5><p>scroll API 保持了那些已经返回记录结果，所以能更加高效地返回排序的结果。但是，按照默认设定排序结果仍然需要代价。</p><p>一般来说，你仅仅想要找到结果，不关心顺序。你可以通过组合 scroll 和 scan 来关闭任何打分或者排序，以最高效的方式返回结果。你需要做的就是将 search_type=scan 加入到查询的字符串中：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">POST /my_index/my_type/_search?scroll=1m&amp;search_type=scan</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;cityName&quot;</span> : <span class="string">&quot;杭州&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置 search_type 为 scan 可以关闭打分，让滚动更加高效。<br>扫描式的滚动请求和标准的滚动请求有四处不同：</p><p>(1)不算分，关闭排序。结果会按照在索引中出现的顺序返回;<br>(2)不支持聚合;<br>(3)初始 search 请求的响应不会在 hits 数组中包含任何结果。第一批结果就会按照第一个 scroll 请求返回。<br>(4)参数 size 控制了每个分片上而非每个请求的结果数目，所以 size 为 10 的情况下，如果命中了 5 个分片，那么每个 scroll 请求最多会返回 50 个结果。</p><p>如果你想支持打分，即使不进行排序，将 track_scores 设置为 true。</p><h5 id="（4）使用-search-after-分页"><a href="#（4）使用-search-after-分页" class="headerlink" title="（4）使用 search after 分页"></a>（4）使用 search after 分页</h5><p>这种方式同样可以深度翻页，但是弥补了 scroll 方式的不足。其思想是：用前一次的查询结果作为下一次的查询条件。</p><p>示例：</p><p>首次查询</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /user_model/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;<span class="string">&quot;match_all&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;<span class="string">&quot;_id&quot;</span>: <span class="string">&quot;asc&quot;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span> : <span class="number">4379</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">6</span>,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : <span class="number">6</span>,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : <span class="number">38213940</span>,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span> : [</span><br><span class="line">      ...</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;user_model&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;00000f78f59644b1967783986c35496c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;sort&quot;</span> : [</span><br><span class="line">          <span class="string">&quot;00000f78f59644b1967783986c35496c&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后续查询</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /user_model/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;<span class="string">&quot;match_all&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;<span class="string">&quot;_id&quot;</span>: <span class="string">&quot;asc&quot;</span>&#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span>: [<span class="string">&quot;00000f78f59644b1967783986c35496c&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，search_after 为上次查询结果中最后一条记录的 sort 值。</p><h5 id="（5）总结："><a href="#（5）总结：" class="headerlink" title="（5）总结："></a>（5）总结：</h5><ol><li>如果数据量小（10000条内），或者只关注结果集的TopN数据，可以使用from / size 分页，简单粗暴</li><li>数据量大，深度翻页，后台批处理任务（数据迁移）之类的任务，使用 scroll 方式</li><li>数据量大，深度翻页，用户实时、高并发查询需求，使用 search after 方式</li></ol><h4 id="6-批量查询"><a href="#6-批量查询" class="headerlink" title="6. 批量查询"></a>6. 批量查询</h4><p>Elasticsearch 的速度已经很快了，但甚至能更快。 将多个请求合并成一个，避免单独处理每个请求花费的网络延时和开销。 如果你需要从 Elasticsearch 检索很多文档，那么使用 <em>multi-get</em> 或者 <code>mget</code> API 来将这些检索请求放在一个请求中，将比逐个文档请求更快地检索到全部文档。</p><p><code>mget</code> API 要求有一个 <code>docs</code> 数组作为参数，每个元素包含需要检索文档的元数据， 包括 <code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 。如果你想检索一个或者多个特定的字段，那么你可以通过 <code>_source</code> 参数来指定这些字段的名字：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :  <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :    <span class="number">2</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :  <span class="string">&quot;pageviews&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :    <span class="number">1</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span>: <span class="string">&quot;views&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该响应体也包含一个 <code>docs</code> 数组， 对于每一个在请求中指定的文档，这个数组中都包含有一个对应的响应，且顺序与请求中的顺序相同。 其中的每一个响应都和使用单个 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/get-doc.html"><code>get</code> request</a> 请求所得到的响应体相同：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> :  <span class="string">&quot;This is a piece of cake...&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span> : <span class="string">&quot;My first external blog entry&quot;</span></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">&quot;_version&quot;</span> : <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;pageviews&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;views&quot;</span> : <span class="number">2</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想检索的数据都在相同的 <code>_index</code> 中（甚至相同的 <code>_type</code> 中），则可以在 URL 中指定默认的 <code>/_index</code> 或者默认的 <code>/_index/_type</code> 。</p><p>你仍然可以通过单独请求覆盖这些值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123; <span class="attr">&quot;_id&quot;</span> : <span class="number">2</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;pageviews&quot;</span>, <span class="attr">&quot;_id&quot;</span> :   <span class="number">1</span> &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上，如果所有文档的 <code>_index</code> 和 <code>_type</code> 都是相同的，你可以只传一个 <code>ids</code> 数组，而不是整个 <code>docs</code> 数组：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;ids&quot;</span> : [ <span class="string">&quot;2&quot;</span>, <span class="string">&quot;1&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，我们请求的第二个文档是不存在的。我们指定类型为 <code>blog</code> ，但是文档 ID <code>1</code> 的类型是 <code>pageviews</code> ，这个不存在的情况将在响应体中被报告：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>:   <span class="string">&quot;My first external blog entry&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;text&quot;</span>:    <span class="string">&quot;This is a piece of cake...&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> :    <span class="literal">false</span>  </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-4-批量操作"><a href="#2-4-批量操作" class="headerlink" title="2.4-批量操作"></a>2.4-批量操作</h3><p>与 <code>mget</code> 可以使我们一次取回多个文档同样的方式， <code>bulk</code> API 允许在单个步骤中进行多次 <code>create</code> 、 <code>index</code> 、 <code>update</code> 或 <code>delete</code> 请求。 如果你需要索引一个数据流比如日志事件，它可以排队和索引数百或数千批次。</p><p><code>bulk</code> 与其他的请求体格式稍有不同，如下所示：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">action</span>: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body        &#125;\n</span><br><span class="line">&#123; <span class="attr">action</span>: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body        &#125;\n</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这种格式类似一个有效的单行 JSON 文档 <em>流</em> ，它通过换行符(<code>\n</code>)连接到一起。注意两个要点：</p><ul><li>每行一定要以换行符(<code>\n</code>)结尾， <em>包括最后一行</em> 。这些换行符被用作一个标记，可以有效分隔行。</li><li>这些行不能包含未转义的换行符，因为他们将会对解析造成干扰。这意味着这个 JSON <em>不</em> 能使用 pretty 参数打印。</li></ul><p><strong>bulk的请求模板</strong></p><p>分成action、metadata和doc三部份</p><p>action : 必须是以下4种选项之一</p><ul><li><p>index(最常用) : 如果文档不存在就创建他，如果文档存在就更新他</p></li><li><p>create : 如果文档不存在就创建他，但如果文档存在就返回错误</p><p>使用时一定要在metadata设置_id值，他才能去判断这个文档是否存在</p></li><li><p>update : 更新一个文档，如果文档不存在就返回错误</p><p>使用时也要给_id值，且后面文档的格式和其他人不一样</p></li><li><p>delete : 删除一个文档，如果要删除的文档id不存在，就返回错误</p><p>使用时也必须在metadata中设置文档_id，且后面不能带一个doc，因为没意义，他是用_id去删除文档的</p></li></ul><p>metadata : 设置这个文档的metadata，像是_id、_index、_type…</p><p>doc : 就是一般的文档格式</p><ul><li><p><strong><code>create</code></strong></p><p>如果文档不存在，那么就创建它。详情请见 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/create-doc.html">创建新文档</a>。</p></li><li><p><strong><code>index</code></strong></p><p>创建一个新文档或者替换一个现有的文档。详情请见 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index-doc.html">索引文档</a> 和 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/update-doc.html">更新整个文档</a>。</p></li><li><p><strong><code>update</code></strong></p><p>部分更新一个文档。详情请见 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/partial-updates.html">文档的部分更新</a>。</p></li><li><p><strong><code>delete</code></strong></p><p>删除一个文档。详情请见 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/delete-doc.html">删除文档</a>。</p></li></ul><p><code>metadata</code> 应该指定被索引、创建、更新或者删除的文档的 <code>_index</code> 、 <code>_type</code> 和 <code>_id</code> 。</p><p>例如，一个 <code>delete</code> 请求看起来是这样的：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123; <span class="string">&quot;delete&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br></pre></td></tr></table></figure><p><code>request body</code> 行由文档的 <code>_source</code> 本身组成—文档包含的字段和值。它是 <code>index</code> 和 <code>create</code> 操作所必需的，这是有道理的：你必须提供文档以索引。</p><p>它也是 <code>update</code> 操作所必需的，并且应该包含你传递给 <code>update</code> API 的相同请求体： <code>doc</code> 、 <code>upsert</code> 、 <code>script</code> 等等。 删除操作不需要 <code>request body</code> 行。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123; <span class="string">&quot;create&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>:    <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>如果不指定 <code>_id</code> ，将会自动生成一个 ID ：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>:    <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>为了把所有的操作组合在一起，一个完整的 <code>bulk</code> 请求 有以下形式:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125; </span><br><span class="line">&#123; <span class="string">&quot;create&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>:    <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>:    <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span>, <span class="string">&quot;_retry_on_conflict&quot;</span> : <span class="number">3</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> : &#123;<span class="string">&quot;title&quot;</span> : <span class="string">&quot;My updated blog post&quot;</span>&#125; &#125; </span><br></pre></td></tr></table></figure><h2 id="3-ES整合SpringBoot"><a href="#3-ES整合SpringBoot" class="headerlink" title="3-ES整合SpringBoot"></a>3-ES整合SpringBoot</h2><p>面介绍下 SpringBoot 如何通过 elasticsearch-rest-high-level-client 工具操作 ElasticSearch，这里需要说一下，为什么没有使用 Spring 家族封装的 spring-data-elasticsearch。</p><p>主要原因是灵活性和更新速度，Spring 将 ElasticSearch 过度封装，让开发者很难跟 ES 的 DSL 查询语句进行关联。再者就是更新速度，ES 的更新速度是非常快，但是 spring-data-elasticsearch 更新速度比较缓慢。</p><p>由于上面两点，所以选择了官方推出的 Java 客户端 elasticsearch-rest-high-level-client，它的代码写法跟 DSL 语句很相似，懂 ES 查询的使用其上手很快。</p><h3 id="3-1-Maven-引入相关依赖"><a href="#3-1-Maven-引入相关依赖" class="headerlink" title="3.1-Maven 引入相关依赖"></a>3.1-Maven 引入相关依赖</h3><ul><li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU2MTI4MjI0MQ==&mid=2247486990&idx=1&sn=77fdaccf5691e2871d8ab25d385f045f&chksm=fc7a63a0cb0deab6a1a85505a1924bdd4728c990c71443222d0ec8f5fd20fa138b82fd679b7a&scene=21#wechat_redirect">lombok</a>：lombok 工具依赖。</p></li><li><p>fastjson：用于将 JSON 转换对象的依赖。</p></li><li><p>spring-boot-starter-web： <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU2MTI4MjI0MQ==&mid=2247486774&idx=3&sn=a13875e4a12fc7a32d39d6ac4ca15b33&chksm=fc7a6098cb0de98e56ee49654d2b31ea0309709166ebbf6d820fc41570bc6445b514b4940b6b&scene=21#wechat_redirect">SpringBoot</a> 的 Web 依赖。</p></li><li><p>elasticsearch：ElasticSearch：依赖，需要和 ES 版本保持一致。</p></li><li><p>elasticsearch-rest-high-level-client：用于操作 ES 的 Java 客户端。</p></li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>club.mydlq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-elasticsearch-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>springboot-elasticsearch-example<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot ElasticSearch<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--fastjson--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--elasticsearch--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-ElasticSearch-连接配置"><a href="#3-2-ElasticSearch-连接配置" class="headerlink" title="3.2-ElasticSearch 连接配置"></a>3.2-ElasticSearch 连接配置</h3><h4 id="1-application-yml-配置文件"><a href="#1-application-yml-配置文件" class="headerlink" title="1. application.yml 配置文件"></a>1. <strong>application.yml 配置文件</strong></h4><p>为了方便更改连接 ES 的连接配置，所以我们将配置信息放置于 application.yaml 中：</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#base</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment">#spring</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springboot-elasticsearch-example</span></span><br><span class="line"><span class="comment">#elasticsearch</span></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">schema:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9200</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="attr">socketTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="attr">connectionRequestTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="attr">maxConnectNum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">maxConnectPerRoute:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><h4 id="2-java-连接配置类"><a href="#2-java-连接配置类" class="headerlink" title="2. java 连接配置类"></a>2. <strong>java 连接配置类</strong></h4><p>这里需要写一个 Java 配置类读取 application 中的配置信息：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ElasticSearch 配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 协议 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.schema:http&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String schema;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 集群地址，如果有多个用“,”隔开 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 连接超时时间 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.connectTimeout:5000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Socket 连接超时时间 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.socketTimeout:10000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> socketTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 获取连接的超时时间 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.connectionRequestTimeout:5000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectionRequestTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 最大连接数 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.maxConnectNum:100&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxConnectNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 最大路由连接数 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.maxConnectPerRoute:100&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxConnectPerRoute;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 拆分地址</span></span><br><span class="line">        List&lt;HttpHost&gt; hostLists = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String[] hostList = address.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String addr : hostList) &#123;</span><br><span class="line">            String host = addr.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">            String port = addr.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">            hostLists.add(<span class="keyword">new</span> HttpHost(host, Integer.parseInt(port), schema));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 转换成 HttpHost 数组</span></span><br><span class="line">        HttpHost[] httpHost = hostLists.toArray(<span class="keyword">new</span> HttpHost[]&#123;&#125;);</span><br><span class="line">        <span class="comment">// 构建连接对象</span></span><br><span class="line">        RestClientBuilder builder = RestClient.builder(httpHost);</span><br><span class="line">        <span class="comment">// 异步连接延时配置</span></span><br><span class="line">        builder.setRequestConfigCallback(requestConfigBuilder -&gt; &#123;</span><br><span class="line">            requestConfigBuilder.setConnectTimeout(connectTimeout);</span><br><span class="line">            requestConfigBuilder.setSocketTimeout(socketTimeout);</span><br><span class="line">            requestConfigBuilder.setConnectionRequestTimeout(connectionRequestTimeout);</span><br><span class="line">            <span class="keyword">return</span> requestConfigBuilder;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 异步连接数配置</span></span><br><span class="line">        builder.setHttpClientConfigCallback(httpClientBuilder -&gt; &#123;</span><br><span class="line">            httpClientBuilder.setMaxConnTotal(maxConnectNum);</span><br><span class="line">            httpClientBuilder.setMaxConnPerRoute(maxConnectPerRoute);</span><br><span class="line">            <span class="keyword">return</span> httpClientBuilder;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(builder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-索引操作示例"><a href="#3-3-索引操作示例" class="headerlink" title="3.3-索引操作示例"></a>3.3-索引操作示例</h3><h4 id="1-Restful-操作示例"><a href="#1-Restful-操作示例" class="headerlink" title="1. Restful 操作示例"></a>1. Restful 操作示例</h4><p><strong>创建索引</strong></p><p>创建名为 mydlq-user 的索引与对应 Mapping。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">PUT /mydlq-user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;dynamic&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;remark&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;salary&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;birthDate&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">          <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;createTime&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>删除索引</strong></p><p>删除 mydlq-user 索引。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">DELETE /mydlq-user</span><br></pre></td></tr></table></figure><h4 id="2-Java-代码示例"><a href="#2-Java-代码示例" class="headerlink" title="2. Java 代码示例"></a>2. Java 代码示例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.create.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.create.CreateIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.support.master.AcknowledgedResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexService2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 Mapping</span></span><br><span class="line">            XContentBuilder mapping = XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                    .field(<span class="string">&quot;dynamic&quot;</span>, <span class="keyword">true</span>)</span><br><span class="line">                    .startObject(<span class="string">&quot;properties&quot;</span>)</span><br><span class="line">                        .startObject(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text&quot;</span>)</span><br><span class="line">                            .startObject(<span class="string">&quot;fields&quot;</span>)</span><br><span class="line">                                .startObject(<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                    .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                .endObject()</span><br><span class="line">                            .endObject()</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;address&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text&quot;</span>)</span><br><span class="line">                            .startObject(<span class="string">&quot;fields&quot;</span>)</span><br><span class="line">                                .startObject(<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                    .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                .endObject()</span><br><span class="line">                            .endObject()</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;remark&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text&quot;</span>)</span><br><span class="line">                            .startObject(<span class="string">&quot;fields&quot;</span>)</span><br><span class="line">                                .startObject(<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                    .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;keyword&quot;</span>)</span><br><span class="line">                                .endObject()</span><br><span class="line">                            .endObject()</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;integer&quot;</span>)</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;salary&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;float&quot;</span>)</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;birthDate&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;date&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;format&quot;</span>, <span class="string">&quot;yyyy-MM-dd&quot;</span>)</span><br><span class="line">                        .endObject()</span><br><span class="line">                        .startObject(<span class="string">&quot;createTime&quot;</span>)</span><br><span class="line">                            .field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;date&quot;</span>)</span><br><span class="line">                        .endObject()</span><br><span class="line">                    .endObject()</span><br><span class="line">                .endObject();</span><br><span class="line">            <span class="comment">// 创建索引配置信息，配置</span></span><br><span class="line">            Settings settings = Settings.builder()</span><br><span class="line">                    .put(<span class="string">&quot;index.number_of_shards&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                    .put(<span class="string">&quot;index.number_of_replicas&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">// 新建创建索引请求对象，然后设置索引类型（ES 7.0 将不存在索引类型）和 mapping 与 index 配置</span></span><br><span class="line">            CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;mydlq-user&quot;</span>, settings);</span><br><span class="line">            request.mapping(<span class="string">&quot;doc&quot;</span>, mapping);</span><br><span class="line">            <span class="comment">// RestHighLevelClient 执行创建索引</span></span><br><span class="line">            CreateIndexResponse createIndexResponse = restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 判断是否创建成功</span></span><br><span class="line">            <span class="keyword">boolean</span> isCreated = createIndexResponse.isAcknowledged();</span><br><span class="line">            log.info(<span class="string">&quot;是否创建成功：&#123;&#125;&quot;</span>, isCreated);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 新建删除索引请求对象</span></span><br><span class="line">            DeleteIndexRequest request = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            <span class="comment">// 执行删除索引</span></span><br><span class="line">            AcknowledgedResponse acknowledgedResponse = restHighLevelClient.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 判断是否删除成功</span></span><br><span class="line">            <span class="keyword">boolean</span> siDeleted = acknowledgedResponse.isAcknowledged();</span><br><span class="line">            log.info(<span class="string">&quot;是否删除成功：&#123;&#125;&quot;</span>, siDeleted);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-文档操作示例"><a href="#3-4-文档操作示例" class="headerlink" title="3.4-文档操作示例"></a>3.4-文档操作示例</h3><h4 id="1-Restful-操作示例-1"><a href="#1-Restful-操作示例-1" class="headerlink" title="1. Restful 操作示例"></a>1. Restful 操作示例</h4><p><strong>增加文档信息</strong></p><p>在索引 mydlq-user 中增加一条文档信息。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">POST /mydlq-user/doc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;北京市&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">29</span>,</span><br><span class="line">    <span class="string">&quot;birthDate&quot;</span>: <span class="string">&quot;1990-01-10&quot;</span>,</span><br><span class="line">    <span class="string">&quot;createTime&quot;</span>: <span class="number">1579530727699</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;remark&quot;</span>: <span class="string">&quot;来自北京市的张先生&quot;</span>,</span><br><span class="line">    <span class="string">&quot;salary&quot;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>获取文档信息</strong></p><p>获取 mydlq-user 的索引 id=1 的文档信息。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/doc/<span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>更新文档信息</strong></p><p>更新之前创建的 id=1 的文档信息。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">PUT /mydlq-user/doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;北京市海淀区&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">29</span>,</span><br><span class="line">    <span class="string">&quot;birthDate&quot;</span>: <span class="string">&quot;1990-01-10&quot;</span>,</span><br><span class="line">    <span class="string">&quot;createTime&quot;</span>: <span class="number">1579530727699</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;remark&quot;</span>: <span class="string">&quot;来自北京市的张先生&quot;</span>,</span><br><span class="line">    <span class="string">&quot;salary&quot;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>删除文档信息</strong></p><p>删除之前创建的 id=1 的文档信息。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">DELETE /mydlq-user/doc/<span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="2-Java-代码示例-1"><a href="#2-Java-代码示例-1" class="headerlink" title="2. Java 代码示例"></a>2. Java 代码示例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加文档信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建索引请求对象</span></span><br><span class="line">            IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;mydlq-user&quot;</span>, <span class="string">&quot;doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建员工信息</span></span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">            userInfo.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">            userInfo.setAge(<span class="number">29</span>);</span><br><span class="line">            userInfo.setSalary(<span class="number">100.00f</span>);</span><br><span class="line">            userInfo.setAddress(<span class="string">&quot;北京市&quot;</span>);</span><br><span class="line">            userInfo.setRemark(<span class="string">&quot;来自北京市的张先生&quot;</span>);</span><br><span class="line">            userInfo.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">            userInfo.setBirthDate(<span class="string">&quot;1990-01-10&quot;</span>);</span><br><span class="line">            <span class="comment">// 将对象转换为 byte 数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] json = JSON.toJSONBytes(userInfo);</span><br><span class="line">            <span class="comment">// 设置文档内容</span></span><br><span class="line">            indexRequest.source(json, XContentType.JSON);</span><br><span class="line">            <span class="comment">// 执行增加文档</span></span><br><span class="line">            IndexResponse response = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">            log.info(<span class="string">&quot;创建状态：&#123;&#125;&quot;</span>, response.status());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文档信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取请求对象</span></span><br><span class="line">            GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;mydlq-user&quot;</span>, <span class="string">&quot;doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取文档信息</span></span><br><span class="line">            GetResponse getResponse = restHighLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">            <span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">                UserInfo userInfo = JSON.parseObject(getResponse.getSourceAsBytes(), UserInfo.class);</span><br><span class="line">                log.info(<span class="string">&quot;员工信息：&#123;&#125;&quot;</span>, userInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新文档信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建索引请求对象</span></span><br><span class="line">            UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(<span class="string">&quot;mydlq-user&quot;</span>, <span class="string">&quot;doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="comment">// 设置员工更新信息</span></span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">            userInfo.setSalary(<span class="number">200.00f</span>);</span><br><span class="line">            userInfo.setAddress(<span class="string">&quot;北京市海淀区&quot;</span>);</span><br><span class="line">            <span class="comment">// 将对象转换为 byte 数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] json = JSON.toJSONBytes(userInfo);</span><br><span class="line">            <span class="comment">// 设置更新文档内容</span></span><br><span class="line">            updateRequest.doc(json, XContentType.JSON);</span><br><span class="line">            <span class="comment">// 执行更新文档</span></span><br><span class="line">            UpdateResponse response = restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">            log.info(<span class="string">&quot;创建状态：&#123;&#125;&quot;</span>, response.status());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除文档信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建删除请求对象</span></span><br><span class="line">            DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;mydlq-user&quot;</span>, <span class="string">&quot;doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="comment">// 执行删除文档</span></span><br><span class="line">            DeleteResponse response = restHighLevelClient.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">            log.info(<span class="string">&quot;删除状态：&#123;&#125;&quot;</span>, response.status());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-插入初始化数据"><a href="#3-5-插入初始化数据" class="headerlink" title="3.5-插入初始化数据"></a>3.5-插入初始化数据</h3><h4 id="1-单条插入"><a href="#1-单条插入" class="headerlink" title="1. 单条插入"></a>1. 单条插入</h4><p>POST mydlq-user/_doc</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;零零&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市丰台区&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;age&quot;</span>:<span class="number">29</span>,</span><br><span class="line">  <span class="attr">&quot;salary&quot;</span>:<span class="number">3000</span>,</span><br><span class="line">  <span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1990-11-11&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-11-11T08:18:00.000Z&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-批量插入"><a href="#2-批量插入" class="headerlink" title="2. 批量插入"></a>2. 批量插入</h4><p>POST _bulk</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;刘一&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市丰台区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">30</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">3000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1989-11-11&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-03-15T08:18:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;陈二&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市昌平区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">27</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">7900</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1992-01-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-11-08T11:15:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市房山区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">28</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">8800</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1991-10-05&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-07-22T13:22:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;李四&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市大兴区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;高层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">26</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">9000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1993-08-18&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-10-17T15:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;王五&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市密云区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">31</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">4800</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1988-07-20&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-05-29T09:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;赵六&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市通州区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">32</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">6500</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1987-06-02&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-12-10T18:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;孙七&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市朝阳区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">33</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">7000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1986-04-15&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-06-06T13:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;周八&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市西城区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">32</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">5000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1987-09-26&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-01-26T14:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;吴九&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市海淀区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;高层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">30</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">11000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1989-11-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-09-07T13:34:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;郑十&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市东城区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">29</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">5000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1990-12-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-03-06T12:08:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;萧十一&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市平谷区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">29</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">3300</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1990-11-11&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-03-10T08:17:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;曹十二&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市怀柔区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">27</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">6800</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1992-01-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-12-03T11:09:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;吴十三&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市延庆区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">25</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">7000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1994-10-05&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-07-27T14:22:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;冯十四&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市密云区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">25</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">3000</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1994-08-18&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-04-22T15:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;蒋十五&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市通州区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">31</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">2800</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1988-07-20&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-06-13T10:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;苗十六&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市门头沟区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;高层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">32</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">11500</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1987-06-02&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-11-11T18:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;鲁十七&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市石景山区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;高员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">33</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">9500</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1986-04-15&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-06-06T14:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;沈十八&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市朝阳区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;中层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">31</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">8300</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1988-09-26&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-09-25T14:00:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;吕十九&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市西城区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">31</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">4500</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1988-11-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-09-22T13:34:00.000Z&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;mydlq-user&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;丁二十&quot;</span>,<span class="attr">&quot;address&quot;</span>:<span class="string">&quot;北京市东城区&quot;</span>,<span class="attr">&quot;remark&quot;</span>:<span class="string">&quot;低层员工&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">33</span>,<span class="attr">&quot;salary&quot;</span>:<span class="number">2100</span>,<span class="attr">&quot;birthDate&quot;</span>:<span class="string">&quot;1986-12-25&quot;</span>,<span class="attr">&quot;createTime&quot;</span>:<span class="string">&quot;2019-03-07T12:08:00.000Z&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="3-查询数据"><a href="#3-查询数据" class="headerlink" title="3. 查询数据"></a>3. 查询数据</h4><p>插入完成后再查询数据，查看之前插入的数据是否存在：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br></pre></td></tr></table></figure><p>执行后得到下面记录:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;BeN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;刘一&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市丰台区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;低层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">30</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">3000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1989-11-11&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-03-15T08:18:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;BuN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;陈二&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市昌平区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;中层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">27</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">7900</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1992-01-25&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-11-08T11:15:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;B-N0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市房山区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;中层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">8800</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1991-10-05&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-07-22T13:22:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;CON0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市大兴区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;高层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">26</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">9000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1993-08-18&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-10-17T15:00:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;CeN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市密云区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;低层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">31</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">4800</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1988-07-20&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-05-29T09:00:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;CuN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;赵六&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市通州区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;中层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">6500</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1987-06-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-12-10T18:00:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;C-N0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;孙七&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市朝阳区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;中层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">33</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">7000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1986-04-15&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-06-06T13:00:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;DON0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;周八&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市西城区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;低层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">5000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1987-09-26&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-01-26T14:00:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;DeN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;吴九&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市海淀区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;高层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">30</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">11000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1989-11-25&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-09-07T13:34:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;mydlq-user&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;DuN0BW8B7BNodGwRFTRj&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;郑十&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市东城区&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;低层员工&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>: <span class="number">29</span>,</span><br><span class="line">          <span class="attr">&quot;salary&quot;</span>: <span class="number">5000</span>,</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: <span class="string">&quot;1990-12-25&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2019-03-06T12:08:00.000Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-6-查询操作示例"><a href="#3-6-查询操作示例" class="headerlink" title="3.6-查询操作示例"></a>3.6-查询操作示例</h3><h4 id="1-精确查询-term"><a href="#1-精确查询-term" class="headerlink" title="1. 精确查询(term)"></a>1. 精确查询(term)</h4><h5 id="（1）Restful-操作示例"><a href="#（1）Restful-操作示例" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p><strong>精确查询</strong></p><p>精确查询，查询地址为 北京市通州区 的人员信息：</p><p>查询条件不会进行分词，但是查询内容可能会分词，导致查询不到。之前在创建索引时设置 Mapping 中 address 字段存在 keyword 字段是专门用于不分词查询的子字段。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;address.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;北京市通州区&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>精确查询-多内容查询</strong></p><p>精确查询，查询地址为 北京市丰台区、北京市昌平区 或 北京市大兴区 的人员信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;address.keyword&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;北京市丰台区&quot;</span>,</span><br><span class="line">        <span class="string">&quot;北京市昌平区&quot;</span>,</span><br><span class="line">        <span class="string">&quot;北京市大兴区&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例"><a href="#（2）Java-代码示例" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TermQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 精确查询（查询条件不会进行分词，但是查询内容可能会分词，导致查询不到）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">termQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件（注意：termQuery 支持多种格式查询，如 boolean、int、double、string 等，这里使用的是 string 的查询）</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;address.keyword&quot;</span>, <span class="string">&quot;北京市通州区&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多个内容在一个字段中进行查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">termsQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件（注意：termsQuery 支持多种格式查询，如 boolean、int、double、string 等，这里使用的是 string 的查询）</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.termsQuery(<span class="string">&quot;address.keyword&quot;</span>, <span class="string">&quot;北京市丰台区&quot;</span>, <span class="string">&quot;北京市昌平区&quot;</span>, <span class="string">&quot;北京市大兴区&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-匹配查询-match"><a href="#2-匹配查询-match" class="headerlink" title="2. 匹配查询(match)"></a>2. 匹配查询(match)</h4><h5 id="（1）Restful-操作示例-1"><a href="#（1）Restful-操作示例-1" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p><strong>匹配查询全部数据与分页</strong></p><p>匹配查询符合条件的所有数据，并且设置以 salary 字段升序排序，并设置分页：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;salary&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>匹配查询数据</strong></p><p>匹配查询地址为 通州区 的数据：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;通州区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>词语匹配查询</strong></p><p>词语匹配进行查询，匹配 address 中为 北京市通州区 的员工信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北京市通州区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>内容多字段查询</strong></p><p>查询在字段 address、remark 中存在 北京 内容的员工信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;北京&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [<span class="string">&quot;address&quot;</span>,<span class="string">&quot;remark&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-1"><a href="#（2）Java-代码示例-1" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.MatchAllQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MatchQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 匹配查询符合条件的所有数据，并设置分页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">matchAllQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            MatchAllQueryBuilder matchAllQueryBuilder = QueryBuilders.matchAllQuery();</span><br><span class="line">            <span class="comment">// 创建查询源构造器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(matchAllQueryBuilder);</span><br><span class="line">            <span class="comment">// 设置分页</span></span><br><span class="line">            searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">3</span>);</span><br><span class="line">            <span class="comment">// 设置排序</span></span><br><span class="line">            searchSourceBuilder.sort(<span class="string">&quot;salary&quot;</span>, SortOrder.ASC);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 匹配查询数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">matchQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;*通州区&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 词语匹配查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">matchPhraseQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.matchPhraseQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;北京市通州区&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容在多字段中进行查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">matchMultiQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.multiMatchQuery(<span class="string">&quot;北京市&quot;</span>, <span class="string">&quot;address&quot;</span>, <span class="string">&quot;remark&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-模糊查询-fuzzy"><a href="#3-模糊查询-fuzzy" class="headerlink" title="3. 模糊查询(fuzzy)"></a>3. 模糊查询(fuzzy)</h4><h5 id="（1）Restful-操作示例-2"><a href="#（1）Restful-操作示例-2" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>模糊查询所有以 三 结尾的姓名</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;三&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-2"><a href="#（2）Java-代码示例-2" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.unit.Fuzziness;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FuzzyQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模糊查询所有以 “三” 结尾的姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">fuzzyQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.fuzzyQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;三&quot;</span>).fuzziness(Fuzziness.AUTO));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-范围查询-range"><a href="#4-范围查询-range" class="headerlink" title="4. 范围查询(range)"></a>4. 范围查询(range)</h4><h5 id="（1）Restful-操作示例-3"><a href="#（1）Restful-操作示例-3" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>查询岁数 ≥ 30 岁的员工数据：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询生日距离现在 30 年间的员工数据：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;birthDate&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;now-30y&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5><a href="#" class="headerlink"></a></h5><h5 id="（2）Java-代码示例-3"><a href="#（2）Java-代码示例-3" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RangeQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询岁数 ≥ 30 岁的员工数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rangeQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>).gte(<span class="number">30</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询距离现在 30 年间的员工数据</span></span><br><span class="line"><span class="comment">     * [年(y)、月(M)、星期(w)、天(d)、小时(h)、分钟(m)、秒(s)]</span></span><br><span class="line"><span class="comment">     * 例如：</span></span><br><span class="line"><span class="comment">     * now-1h 查询一小时内范围</span></span><br><span class="line"><span class="comment">     * now-1d 查询一天内时间范围</span></span><br><span class="line"><span class="comment">     * now-1y 查询最近一年内的时间范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dateRangeQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            <span class="comment">// includeLower（是否包含下边界）、includeUpper（是否包含上边界）</span></span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.rangeQuery(<span class="string">&quot;birthDate&quot;</span>)</span><br><span class="line">                    .gte(<span class="string">&quot;now-30y&quot;</span>).includeLower(<span class="keyword">true</span>).includeUpper(<span class="keyword">true</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-通配符查询-wildcard"><a href="#5-通配符查询-wildcard" class="headerlink" title="5. 通配符查询(wildcard)"></a>5. 通配符查询(wildcard)</h4><h5 id="（1）Restful-操作示例-4"><a href="#（1）Restful-操作示例-4" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>查询所有以 “三” 结尾的姓名：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;*三&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-4"><a href="#（2）Java-代码示例-4" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildcardQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有以 “三” 结尾的姓名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * *：表示多个字符（0个或多个字符）</span></span><br><span class="line"><span class="comment">     * ?：表示单个字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">wildcardQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.wildcardQuery(<span class="string">&quot;name.keyword&quot;</span>, <span class="string">&quot;*三&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-布尔查询-bool"><a href="#6-布尔查询-bool" class="headerlink" title="6. 布尔查询(bool)"></a>6. 布尔查询(bool)</h4><h5 id="（1）Restful-操作示例-5"><a href="#（1）Restful-操作示例-5" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>查询出生在 1990-1995 年期间，且地址在 北京市昌平区、北京市大兴区、北京市房山区 的员工信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;birthDate&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="number">1990</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">1995</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;address.keyword&quot;</span>: [</span><br><span class="line">              <span class="string">&quot;北京市昌平区&quot;</span>,</span><br><span class="line">              <span class="string">&quot;北京市大兴区&quot;</span>,</span><br><span class="line">              <span class="string">&quot;北京市房山区&quot;</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-5"><a href="#（2）Java-代码示例-5" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> club.mydlq.elasticsearch.model.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoolQueryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">boolQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 Bool 查询构建器</span></span><br><span class="line">            BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">            <span class="comment">// 构建查询条件</span></span><br><span class="line">            boolQueryBuilder.must(QueryBuilders.termsQuery(<span class="string">&quot;address.keyword&quot;</span>, <span class="string">&quot;北京市昌平区&quot;</span>, <span class="string">&quot;北京市大兴区&quot;</span>, <span class="string">&quot;北京市房山区&quot;</span>))</span><br><span class="line">                    .filter().add(QueryBuilders.rangeQuery(<span class="string">&quot;birthDate&quot;</span>).format(<span class="string">&quot;yyyy&quot;</span>).gte(<span class="string">&quot;1990&quot;</span>).lte(<span class="string">&quot;1995&quot;</span>));</span><br><span class="line">            <span class="comment">// 构建查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询对象配置到其中</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行查询，然后处理响应结果</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 根据状态和数据条数验证是否返回了数据</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(searchResponse.status()) &amp;&amp; searchResponse.getHits().totalHits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    <span class="comment">// 将 JSON 转换成对象</span></span><br><span class="line">                    UserInfo userInfo = JSON.parseObject(hit.getSourceAsString(), UserInfo.class);</span><br><span class="line">                    <span class="comment">// 输出查询信息</span></span><br><span class="line">                    log.info(userInfo.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-7-聚合查询操作示例"><a href="#3-7-聚合查询操作示例" class="headerlink" title="3.7-聚合查询操作示例"></a>3.7-聚合查询操作示例</h3><h4 id="1-Metric-聚合分析"><a href="#1-Metric-聚合分析" class="headerlink" title="1. Metric 聚合分析"></a>1. Metric 聚合分析</h4><h5 id="（1）Restful-操作示例-6"><a href="#（1）Restful-操作示例-6" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>统计员工总数、工资最高值、工资最低值、工资平均工资、工资总和：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_stats&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;stats&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工工资最低值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_min&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;min&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工工资最高值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_max&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工工资平均值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_avg&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工工资总值：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_sum&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工总数：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;employee_count&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;value_count&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计员工工资百分位：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_percentiles&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;percentiles&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-6"><a href="#（2）Java-代码示例-6" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.avg.ParsedAvg;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.max.ParsedMax;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.min.ParsedMin;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.percentiles.ParsedPercentiles;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.percentiles.Percentile;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.stats.ParsedStats;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.sum.ParsedSum;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.sum.SumAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.valuecount.ParsedValueCount;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggrMetricService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stats 统计员工总数、员工工资最高值、员工工资最低值、员工平均工资、员工工资总和</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationStats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.stats(<span class="string">&quot;salary_stats&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 设置查询结果不返回，只返回聚合结果</span></span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Stats 对象</span></span><br><span class="line">                ParsedStats aggregation = aggregations.get(<span class="string">&quot;salary_stats&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;count：&#123;&#125;&quot;</span>, aggregation.getCount());</span><br><span class="line">                log.info(<span class="string">&quot;avg：&#123;&#125;&quot;</span>, aggregation.getAvg());</span><br><span class="line">                log.info(<span class="string">&quot;max：&#123;&#125;&quot;</span>, aggregation.getMax());</span><br><span class="line">                log.info(<span class="string">&quot;min：&#123;&#125;&quot;</span>, aggregation.getMin());</span><br><span class="line">                log.info(<span class="string">&quot;sum：&#123;&#125;&quot;</span>, aggregation.getSum());</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * min 统计员工工资最低值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.min(<span class="string">&quot;salary_min&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Min 对象</span></span><br><span class="line">                ParsedMin aggregation = aggregations.get(<span class="string">&quot;salary_min&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;min：&#123;&#125;&quot;</span>, aggregation.getValue());</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * max 统计员工工资最高值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationMax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.max(<span class="string">&quot;salary_max&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Max 对象</span></span><br><span class="line">                ParsedMax aggregation = aggregations.get(<span class="string">&quot;salary_max&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;max：&#123;&#125;&quot;</span>, aggregation.getValue());</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * avg 统计员工工资平均值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationAvg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.avg(<span class="string">&quot;salary_avg&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Avg 对象</span></span><br><span class="line">                ParsedAvg aggregation = aggregations.get(<span class="string">&quot;salary_avg&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;avg：&#123;&#125;&quot;</span>, aggregation.getValue());</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sum 统计员工工资总值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            SumAggregationBuilder aggr = AggregationBuilders.sum(<span class="string">&quot;salary_sum&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Sum 对象</span></span><br><span class="line">                ParsedSum aggregation = aggregations.get(<span class="string">&quot;salary_sum&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;sum：&#123;&#125;&quot;</span>, String.valueOf((aggregation.getValue())));</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * count 统计员工总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.count(<span class="string">&quot;employee_count&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 ValueCount 对象</span></span><br><span class="line">                ParsedValueCount aggregation = aggregations.get(<span class="string">&quot;employee_count&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;count：&#123;&#125;&quot;</span>, aggregation.getValue());</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * percentiles 统计员工工资百分位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationPercentiles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String responseResult = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置聚合条件</span></span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.percentiles(<span class="string">&quot;salary_percentiles&quot;</span>).field(<span class="string">&quot;salary&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status()) || aggregations != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 转换为 Percentiles 对象</span></span><br><span class="line">                ParsedPercentiles aggregation = aggregations.get(<span class="string">&quot;salary_percentiles&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Percentile percentile : aggregation) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;百分位：&#123;&#125;：&#123;&#125;&quot;</span>, percentile.getPercent(), percentile.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据具体业务逻辑返回不同结果，这里为了方便直接将返回响应对象Json串</span></span><br><span class="line">            responseResult = response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-Bucket-聚合分析"><a href="#2-Bucket-聚合分析" class="headerlink" title="2. Bucket 聚合分析"></a>2. Bucket 聚合分析</h4><h5 id="（1）Restful-操作示例-7"><a href="#（1）Restful-操作示例-7" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>按岁数进行聚合分桶，统计各个岁数员工的人数：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;age_bucket&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;10&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按工资范围进行聚合分桶，统计工资在 3000-5000、5000-9000 和 9000 以上的员工信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_range_bucket&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;低级员工&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">3000</span></span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;中级员工&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">5000</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">9000</span></span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;高级员工&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">9000</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按照时间范围进行分桶，统计 1985-1990 年和 1990-1995 年出生的员工信息：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;date_range_bucket&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;birthDate&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;出生日期1985-1990的员工&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;1985&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;1990&quot;</span></span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;出生日期1990-1995的员工&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;1990&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;1995&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按工资多少进行聚合分桶，设置统计的最小值为 0，最大值为 12000，区段间隔为 3000：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_histogram&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;extended_bounds&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;min&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;max&quot;</span>: <span class="number">12000</span></span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="attr">&quot;interval&quot;</span>: <span class="number">3000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按出生日期进行分桶：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;birthday_histogram&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;birthDate&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;year&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-7"><a href="#（2）Java-代码示例-7" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.histogram.Histogram;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.range.Range;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggrBucketService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按岁数进行聚合分桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggrBucketTerms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.terms(<span class="string">&quot;age_bucket&quot;</span>).field(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">10</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Terms byCompanyAggregation = aggregations.get(<span class="string">&quot;age_bucket&quot;</span>);</span><br><span class="line">                List&lt;? extends Terms.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125; | 总数：&#123;&#125;&quot;</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按工资范围进行聚合分桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggrBucketRange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.range(<span class="string">&quot;salary_range_bucket&quot;</span>)</span><br><span class="line">                    .field(<span class="string">&quot;salary&quot;</span>)</span><br><span class="line">                    .addUnboundedTo(<span class="string">&quot;低级员工&quot;</span>, <span class="number">3000</span>)</span><br><span class="line">                    .addRange(<span class="string">&quot;中级员工&quot;</span>, <span class="number">5000</span>, <span class="number">9000</span>)</span><br><span class="line">                    .addUnboundedFrom(<span class="string">&quot;高级员工&quot;</span>, <span class="number">9000</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Range byCompanyAggregation = aggregations.get(<span class="string">&quot;salary_range_bucket&quot;</span>);</span><br><span class="line">                List&lt;? extends Range.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Range.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125; | 总数：&#123;&#125;&quot;</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照时间范围进行分桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggrBucketDateRange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.dateRange(<span class="string">&quot;date_range_bucket&quot;</span>)</span><br><span class="line">                    .field(<span class="string">&quot;birthDate&quot;</span>)</span><br><span class="line">                    .format(<span class="string">&quot;yyyy&quot;</span>)</span><br><span class="line">                    .addRange(<span class="string">&quot;1985-1990&quot;</span>, <span class="string">&quot;1985&quot;</span>, <span class="string">&quot;1990&quot;</span>)</span><br><span class="line">                    .addRange(<span class="string">&quot;1990-1995&quot;</span>, <span class="string">&quot;1990&quot;</span>, <span class="string">&quot;1995&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Range byCompanyAggregation = aggregations.get(<span class="string">&quot;date_range_bucket&quot;</span>);</span><br><span class="line">                List&lt;? extends Range.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Range.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125; | 总数：&#123;&#125;&quot;</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按工资多少进行聚合分桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggrBucketHistogram</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.histogram(<span class="string">&quot;salary_histogram&quot;</span>)</span><br><span class="line">                    .field(<span class="string">&quot;salary&quot;</span>)</span><br><span class="line">                    .extendedBounds(<span class="number">0</span>, <span class="number">12000</span>)</span><br><span class="line">                    .interval(<span class="number">3000</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Histogram byCompanyAggregation = aggregations.get(<span class="string">&quot;salary_histogram&quot;</span>);</span><br><span class="line">                List&lt;? extends Histogram.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125; | 总数：&#123;&#125;&quot;</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按出生日期进行分桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggrBucketDateHistogram</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder aggr = AggregationBuilders.dateHistogram(<span class="string">&quot;birthday_histogram&quot;</span>)</span><br><span class="line">                    .field(<span class="string">&quot;birthDate&quot;</span>)</span><br><span class="line">                    .interval(<span class="number">1</span>)</span><br><span class="line">                    .dateHistogramInterval(DateHistogramInterval.YEAR)</span><br><span class="line">                    .format(<span class="string">&quot;yyyy&quot;</span>);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(aggr);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Histogram byCompanyAggregation = aggregations.get(<span class="string">&quot;birthday_histogram&quot;</span>);</span><br><span class="line"></span><br><span class="line">                List&lt;? extends Histogram.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125; | 总数：&#123;&#125;&quot;</span>, bucket.getKeyAsString(), bucket.getDocCount());</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-Metric-与-Bucket-聚合分析"><a href="#3-Metric-与-Bucket-聚合分析" class="headerlink" title="3. Metric 与 Bucket 聚合分析"></a>3. Metric 与 Bucket 聚合分析</h4><h5 id="（1）Restful-操作示例-8"><a href="#（1）Restful-操作示例-8" class="headerlink" title="（1）Restful 操作示例"></a>（1）Restful 操作示例</h5><p>按照员工岁数分桶、然后统计每个岁数员工工资最高值:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET mydlq-user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;salary_bucket&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="string">&quot;10&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;salary_max_user&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;top_hits&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;salary&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="（2）Java-代码示例-8"><a href="#（2）Java-代码示例-8" class="headerlink" title="（2）Java 代码示例"></a>（2）Java 代码示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.rest.RestStatus;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.tophits.ParsedTopHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggrBucketMetricService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * topHits 按岁数分桶、然后统计每个员工工资最高值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">aggregationTopHits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AggregationBuilder testTop = AggregationBuilders.topHits(<span class="string">&quot;salary_max_user&quot;</span>)</span><br><span class="line">                    .size(<span class="number">1</span>)</span><br><span class="line">                    .sort(<span class="string">&quot;salary&quot;</span>, SortOrder.DESC);</span><br><span class="line">            AggregationBuilder salaryBucket = AggregationBuilders.terms(<span class="string">&quot;salary_bucket&quot;</span>)</span><br><span class="line">                    .field(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">                    .size(<span class="number">10</span>);</span><br><span class="line">            salaryBucket.subAggregation(testTop);</span><br><span class="line">            <span class="comment">// 查询源构建器</span></span><br><span class="line">            SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">            searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">            searchSourceBuilder.aggregation(salaryBucket);</span><br><span class="line">            <span class="comment">// 创建查询请求对象，将查询条件配置到其中</span></span><br><span class="line">            SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;mydlq-user&quot;</span>);</span><br><span class="line">            request.source(searchSourceBuilder);</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 获取响应中的聚合信息</span></span><br><span class="line">            Aggregations aggregations = response.getAggregations();</span><br><span class="line">            <span class="comment">// 输出内容</span></span><br><span class="line">            <span class="keyword">if</span> (RestStatus.OK.equals(response.status())) &#123;</span><br><span class="line">                <span class="comment">// 分桶</span></span><br><span class="line">                Terms byCompanyAggregation = aggregations.get(<span class="string">&quot;salary_bucket&quot;</span>);</span><br><span class="line">                List&lt;? extends Terms.Bucket&gt; buckets = byCompanyAggregation.getBuckets();</span><br><span class="line">                <span class="comment">// 输出各个桶的内容</span></span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">                log.info(<span class="string">&quot;聚合信息:&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;桶名：&#123;&#125;&quot;</span>, bucket.getKeyAsString());</span><br><span class="line">                    ParsedTopHits topHits = bucket.getAggregations().get(<span class="string">&quot;salary_max_user&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (SearchHit hit:topHits.getHits())&#123;</span><br><span class="line">                        log.info(hit.getSourceAsString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;-------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>参考：</p><p>——<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020205776">https://segmentfault.com/a/1190000020205776</a></p><p>——<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/60b242cbd8b4">https://www.jianshu.com/p/60b242cbd8b4</a></p><p>——<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020022504">https://segmentfault.com/a/1190000020022504</a></p><p>——<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Lz5Gq1Lwkn8GgMUozqUVjQ">https://mp.weixin.qq.com/s/Lz5Gq1Lwkn8GgMUozqUVjQ</a></p></blockquote></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">空白格</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lemon-cs.github.io/2020/05/08/ElasticSearch%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://lemon-cs.github.io/2020/05/08/ElasticSearch%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lemon-cs.github.io" target="_blank">Lemon-CS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Elasticsearch/">Elasticsearch</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></div><div class="post_share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2022/01/e846e507b0d2ee95.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/05/11/BIONIOAIO/"><img class="prev-cover" src="https://static01.imgkr.com/temp/b12638cdfe384f10ae77ede2ae7d804c.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">BIO-NIO-AIO</div></div></a></div><div class="next-post pull-right"><a href="/2020/05/07/%E4%B8%80%E8%87%B4%E6%80%A7Hash%E7%AE%97%E6%B3%95/"><img class="next-cover" src="https://s3.bmp.ovh/imgs/2022/01/e846e507b0d2ee95.jpeg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">一致性Hash算法</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81NTAxNC8zMTQ4Mg=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./images/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">空白格</div><div class="author-info__description">杯中的水是亮闪闪的,海里的水是黑沉沉的!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">66</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lemon-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lemon-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:591930734@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到Lemon-CS</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ElasticSearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-text">ElasticSearch学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-text">1-简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFElasticSearch%EF%BC%9F"><span class="toc-text">1.1-什么是ElasticSearch？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AFLucene%EF%BC%9F"><span class="toc-text">1.2-什么是Lucene？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-ES%E6%98%AF%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E7%9A%84%EF%BC%9F"><span class="toc-text">1.3-ES是如何产生的？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E6%A3%80%E7%B4%A2%EF%BC%9F"><span class="toc-text">1. 大规模数据如何检索？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%BA%94%E5%AF%B9%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">2. 传统数据库的应对解决方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">3. 非关系型数据库的解决方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AE%8C%E5%85%A8%E6%8A%8A%E6%95%B0%E6%8D%AE%E6%94%BE%E5%85%A5%E5%86%85%E5%AD%98%E6%80%8E%E4%B9%88%E6%A0%B7%EF%BC%9F"><span class="toc-text">4. 完全把数据放入内存怎么样？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E4%BB%80%E4%B9%88%E6%98%AF%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%EF%BC%9F"><span class="toc-text">1.4-什么是全文检索？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95%E5%92%8C%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">1.5-正排索引和倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">1. 正排索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">2. 倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9D%A5%E6%9F%A5%E8%AF%A2%E5%91%A2%EF%BC%9F"><span class="toc-text">如何来查询呢？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%BB%84%E6%88%90"><span class="toc-text">倒排索引组成</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E8%AF%8D%E8%AF%8D%E5%85%B8%E6%9F%A5%E8%AF%A2%E5%AE%9A%E4%BD%8D%E9%97%AE%E9%A2%98"><span class="toc-text">单词词典查询定位问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%91%E5%9E%8B%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-text">树型结构：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-ElasticSearch%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">1.5-ElasticSearch的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ElaticSearch-%E5%92%8C-DB-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">1. ElaticSearch 和 DB 的关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95"><span class="toc-text">2. 索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%96%87%E6%A1%A3"><span class="toc-text">3. 文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%98%A0%E5%B0%84"><span class="toc-text">4. 映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Near-Realtime-NRT-%E5%87%A0%E4%B9%8E%E5%AE%9E%E6%97%B6"><span class="toc-text">5. Near Realtime(NRT) 几乎实时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Cluster-%E9%9B%86%E7%BE%A4"><span class="toc-text">6. Cluster 集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-Node%E8%8A%82%E7%82%B9"><span class="toc-text">7. Node节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-Shards-amp-Replicas%E5%88%86%E7%89%87%E4%B8%8E%E5%89%AF%E6%9C%AC"><span class="toc-text">8. Shards &amp; Replicas分片与副本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ElasticSearch%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">2-ElasticSearch的安装和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-ElasticSearch%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">2.1-ElasticSearch的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Linux%E4%B8%8B%E5%AE%89%E8%A3%85ES"><span class="toc-text">1. Linux下安装ES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Docker%E4%B8%8B%E5%AE%89%E8%A3%85ES"><span class="toc-text">2. Docker下安装ES</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-ElasticSearch%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">2.2-ElasticSearch的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ELasticSearch%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">1. ELasticSearch常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF"><span class="toc-text">(1) 集群信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95-1"><span class="toc-text">(2) 索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8D"><span class="toc-text">(3) 索引别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-settings"><span class="toc-text">(4) settings</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-mapping"><span class="toc-text">(5) mapping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E6%96%87%E6%A1%A3%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%EF%BC%88CRUD%EF%BC%89"><span class="toc-text">(6) 文档的增删改查（CRUD）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Create%EF%BC%88%E5%A2%9E%E5%8A%A0%EF%BC%89"><span class="toc-text">Create（增加）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Read%EF%BC%88%E8%AF%BB%E5%8F%96%EF%BC%89"><span class="toc-text">Read（读取）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Update%EF%BC%88%E6%9B%B4%E6%96%B0%EF%BC%89"><span class="toc-text">Update（更新）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Delete%EF%BC%88%E5%88%A0%E9%99%A4%EF%BC%89"><span class="toc-text">Delete（删除）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">批量操作</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Elasticsearch-SQL"><span class="toc-text">(7) Elasticsearch SQL</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Mapping%E4%B9%8B%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="toc-text">2. Mapping之字段类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="toc-text">(1) 基本类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#string-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="toc-text">string (字符串类型)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#numeric-datatypes-%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-text">numeric datatypes(数字类型)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-text">浮点类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#date-%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="toc-text">date(日期类型)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#boolean%E7%B1%BB%E5%9E%8B"><span class="toc-text">boolean类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#binary%E7%B1%BB%E5%9E%8B"><span class="toc-text">binary类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#range-datatype"><span class="toc-text">range datatype</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="toc-text">(2) 复合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#array"><span class="toc-text">array</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Object-datatype"><span class="toc-text">Object datatype</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Nested-datatype"><span class="toc-text">Nested datatype</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Geo-datatypes"><span class="toc-text">Geo datatypes</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#geo-point"><span class="toc-text">geo_point</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#geo-shape-datatype"><span class="toc-text">geo_shape datatype</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%89%B9%E5%AE%9A%E7%B1%BB%E5%9E%8B"><span class="toc-text">(3) 特定类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ip%E7%B1%BB%E5%9E%8B"><span class="toc-text">ip类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Completion-datatype"><span class="toc-text">Completion datatype</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Token-count-datatype"><span class="toc-text">Token count datatype</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#join-datatype"><span class="toc-text">join datatype</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Alias-datatype"><span class="toc-text">Alias datatype</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-DSL%E8%AF%AD%E6%B3%95%E5%92%8C%E6%90%9C%E7%B4%A2"><span class="toc-text">2.3-DSL语法和搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-text">1. 全文检索</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89match-query%E8%AF%A6%E8%A7%A3"><span class="toc-text">（1）match query详解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89match-phrase"><span class="toc-text">（2）match_phrase</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89match-phrase-prefix"><span class="toc-text">（3）match_phrase_prefix</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89multi-match"><span class="toc-text">（4）multi_match</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-text">2. 布尔查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-text">3. 范围查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%87%E6%BB%A4%E6%9F%A5%E8%AF%A2-filters"><span class="toc-text">4. 过滤查询(filters)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">5. 分页查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89from-size-%E5%88%86%E9%A1%B5"><span class="toc-text">（1）from &#x2F; size 分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E4%BD%BF%E7%94%A8-scroll-%E5%88%86%E9%A1%B5"><span class="toc-text">（2）使用 scroll 分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E4%BD%BF%E7%94%A8scroll-scan-%E7%9A%84%E9%AB%98%E6%95%88%E6%BB%9A%E5%8A%A8"><span class="toc-text">（3）使用scroll-scan 的高效滚动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8-search-after-%E5%88%86%E9%A1%B5"><span class="toc-text">（4）使用 search after 分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">（5）总结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="toc-text">6. 批量查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">2.4-批量操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ES%E6%95%B4%E5%90%88SpringBoot"><span class="toc-text">3-ES整合SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Maven-%E5%BC%95%E5%85%A5%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-text">3.1-Maven 引入相关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-ElasticSearch-%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2-ElasticSearch 连接配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-application-yml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">1. application.yml 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-java-%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">2. java 连接配置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.3-索引操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">1. Restful 操作示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">2. Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.4-文档操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">1. Restful 操作示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">2. Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E6%8F%92%E5%85%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-text">3.5-插入初始化数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%95%E6%9D%A1%E6%8F%92%E5%85%A5"><span class="toc-text">1. 单条插入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="toc-text">2. 批量插入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-text">3. 查询数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.6-查询操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2-term"><span class="toc-text">1. 精确查询(term)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2-match"><span class="toc-text">2. 匹配查询(match)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-fuzzy"><span class="toc-text">3. 模糊查询(fuzzy)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-range"><span class="toc-text">4. 范围查询(range)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-3"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link"><span class="toc-text"></span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-3"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%9F%A5%E8%AF%A2-wildcard"><span class="toc-text">5. 通配符查询(wildcard)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-4"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-4"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2-bool"><span class="toc-text">6. 布尔查询(bool)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-5"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-5"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.7-聚合查询操作示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Metric-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-text">1. Metric 聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-6"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-6"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Bucket-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-text">2. Bucket 聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-7"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-7"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Metric-%E4%B8%8E-Bucket-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-text">3. Metric 与 Bucket 聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Restful-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-8"><span class="toc-text">（1）Restful 操作示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Java-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-8"><span class="toc-text">（2）Java 代码示例</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%A5%E9%97%A8/" title="23种设计模式入门"><img src="https://s3.bmp.ovh/imgs/2021/12/468eb316ff103180.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="23种设计模式入门"></a><div class="content"><a class="title" href="/2022/02/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%A5%E9%97%A8/" title="23种设计模式入门">23种设计模式入门</a><time datetime="2022-02-10T12:29:08.355Z" title="发表于 2022-02-10 20:29:08">2022-02-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/03/Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8Fcrontab%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/" title="Go语言实现分布式crontab任务系统"><img src="https://static01.imgkr.com/temp/fa403895570e4cafb459adbcdca97dbe.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Go语言实现分布式crontab任务系统"></a><div class="content"><a class="title" href="/2021/12/03/Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8Fcrontab%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/" title="Go语言实现分布式crontab任务系统">Go语言实现分布式crontab任务系统</a><time datetime="2021-12-03T14:09:50.000Z" title="发表于 2021-12-03 22:09:50">2021-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/16/Go%E6%93%8D%E4%BD%9CMongoDB/" title="Go操作MongoDB"><img src="https://static01.imgkr.com/temp/67e21ea4f0cb464cb52de4d60aad3962.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Go操作MongoDB"></a><div class="content"><a class="title" href="/2021/11/16/Go%E6%93%8D%E4%BD%9CMongoDB/" title="Go操作MongoDB">Go操作MongoDB</a><time datetime="2021-11-16T14:09:50.000Z" title="发表于 2021-11-16 22:09:50">2021-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/24/Netty%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Netty入门学习笔记"><img src="https://static01.imgkr.com/temp/f64b83005c0248dca40c71705366ac18.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Netty入门学习笔记"></a><div class="content"><a class="title" href="/2020/06/24/Netty%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Netty入门学习笔记">Netty入门学习笔记</a><time datetime="2020-06-24T06:31:42.000Z" title="发表于 2020-06-24 14:31:42">2020-06-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/07/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E4%BD%8D%E5%9B%BE/" title="布隆过滤器和位图"><img src="/./images/scotland.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="布隆过滤器和位图"></a><div class="content"><a class="title" href="/2020/06/07/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E4%BD%8D%E5%9B%BE/" title="布隆过滤器和位图">布隆过滤器和位图</a><time datetime="2020-06-07T13:20:01.000Z" title="发表于 2020-06-07 21:20:01">2020-06-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 空白格</div><div class="footer_custom_text">欢迎来到Lemon-CS</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadLivere(){var e,t,o,r;"object"==typeof LivereTower?window.LivereTower.init():(e=document,t="script",r=e.getElementsByTagName(t)[0],"function"!=typeof LivereTower&&((o=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",o.async=!0,r.parentNode.insertBefore(o,r)))}{function loadOtherComment(){loadLivere()}loadLivere()}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];pjaxSelectors.unshift('meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]');var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>