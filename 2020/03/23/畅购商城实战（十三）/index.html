<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>畅购商城（十三）之秒杀微服务 | Lemon-CS</title><meta name="keywords" content="SpringCloud,微服务,项目实战"><meta name="author" content="空白格"><meta name="copyright" content="空白格"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第13章 秒杀学习目标 &#x3D;&#x3D;秒杀业务分析&#x3D;&#x3D; 秒杀商品压入Redis缓存 Spring定时任务了解-定时将秒杀商品存入到Redis中 秒杀商品频道页实现-秒杀商品列表页 秒杀商品详情页实现 下单实现(普通下单) &#x3D;&#x3D;多线程异步抢单实现-队列削峰&#x3D;&#x3D;  1 秒杀业务分析1.1 需求分析所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为">
<meta property="og:type" content="article">
<meta property="og:title" content="畅购商城（十三）之秒杀微服务">
<meta property="og:url" content="https://lemon-cs.github.io/2020/03/23/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89/index.html">
<meta property="og:site_name" content="Lemon-CS">
<meta property="og:description" content="第13章 秒杀学习目标 &#x3D;&#x3D;秒杀业务分析&#x3D;&#x3D; 秒杀商品压入Redis缓存 Spring定时任务了解-定时将秒杀商品存入到Redis中 秒杀商品频道页实现-秒杀商品列表页 秒杀商品详情页实现 下单实现(普通下单) &#x3D;&#x3D;多线程异步抢单实现-队列削峰&#x3D;&#x3D;  1 秒杀业务分析1.1 需求分析所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lemon-cs.github.io/images/colorhub.jpg">
<meta property="article:published_time" content="2020-03-23T15:41:31.000Z">
<meta property="article:modified_time" content="2021-12-21T15:49:27.344Z">
<meta property="article:author" content="空白格">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="项目实战">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lemon-cs.github.io/images/colorhub.jpg"><link rel="shortcut icon" href="/./images/Blog.png"><link rel="canonical" href="https://lemon-cs.github.io/2020/03/23/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 空白格","link":"链接: ","source":"来源: Lemon-CS","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '畅购商城（十三）之秒杀微服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-21 23:49:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/constown/HexoCustomFile@0.0.4/dist/css/custom.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./images/colorhub.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lemon-CS</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">畅购商城（十三）之秒杀微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-23T15:41:31.000Z" title="发表于 2020-03-23 23:41:31">2020-03-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-21T15:49:27.344Z" title="更新于 2021-12-21 23:49:27">2021-12-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="畅购商城（十三）之秒杀微服务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第13章-秒杀"><a href="#第13章-秒杀" class="headerlink" title="第13章 秒杀"></a>第13章 秒杀</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li>==秒杀业务分析==</li>
<li>秒杀商品压入Redis缓存</li>
<li>Spring定时任务了解-定时将秒杀商品存入到Redis中</li>
<li>秒杀商品频道页实现-秒杀商品列表页</li>
<li>秒杀商品详情页实现</li>
<li>下单实现(普通下单)</li>
<li>==多线程异步抢单实现-队列削峰==</li>
</ul>
<h2 id="1-秒杀业务分析"><a href="#1-秒杀业务分析" class="headerlink" title="1 秒杀业务分析"></a>1 秒杀业务分析</h2><h3 id="1-1-需求分析"><a href="#1-1-需求分析" class="headerlink" title="1.1 需求分析"></a>1.1 需求分析</h3><p>所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。</p>
<p>秒杀商品通常有两种限制：库存限制、时间限制。</p>
<p>需求：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">（1）录入秒杀商品数据，主要包括：商品标题、原价、秒杀价、商品图片、介绍、秒杀时段等信息</span></span><br><span class="line"><span class="attr">（2）秒杀频道首页列出秒杀商品（进行中的）点击秒杀商品图片跳转到秒杀商品详细页。</span></span><br><span class="line"><span class="attr">（3）商品详细页显示秒杀商品信息，点击立即抢购实现秒杀下单，下单时扣减库存。当库存为0或不在活动期范围内时无法秒杀。</span></span><br><span class="line"><span class="attr">（4）秒杀下单成功，直接跳转到支付页面（微信扫码），支付成功，跳转到成功页，填写收货地址、电话、收件人等信息，完成订单。</span></span><br><span class="line"><span class="attr">（5）当用户秒杀下单5分钟内未支付，取消预订单，调用微信支付的关闭订单接口，恢复库存。</span></span><br></pre></td></tr></table></figure>



<h3 id="1-2-表结构说明"><a href="#1-2-表结构说明" class="headerlink" title="1.2 表结构说明"></a>1.2 表结构说明</h3><p><strong>秒杀商品信息表</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_seckill_goods` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `sup_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;spu ID&#x27;</span>,</span><br><span class="line">  `sku_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;sku ID&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标题&#x27;</span>,</span><br><span class="line">  `small_pic` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品图片&#x27;</span>,</span><br><span class="line">  `price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;原价格&#x27;</span>,</span><br><span class="line">  `cost_price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀价格&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;添加日期&#x27;</span>,</span><br><span class="line">  `check_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;审核日期&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;审核状态，0未审核，1审核通过，2审核不通过&#x27;</span>,</span><br><span class="line">  `start_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;开始时间&#x27;</span>,</span><br><span class="line">  `end_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;结束时间&#x27;</span>,</span><br><span class="line">  `num` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀商品数&#x27;</span>,</span><br><span class="line">  `stock_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;剩余库存数&#x27;</span>,</span><br><span class="line">  `introduction` <span class="type">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p><strong>秒杀订单表</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_seckill_order` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `seckill_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀商品ID&#x27;</span>,</span><br><span class="line">  `money` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付金额&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `pay_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付时间&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;状态，0未支付，1已支付&#x27;</span>,</span><br><span class="line">  `receiver_address` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收货人地址&#x27;</span>,</span><br><span class="line">  `receiver_mobile` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收货人电话&#x27;</span>,</span><br><span class="line">  `receiver` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收货人&#x27;</span>,</span><br><span class="line">  `transaction_id` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易流水&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-秒杀需求分析"><a href="#1-3-秒杀需求分析" class="headerlink" title="1.3 秒杀需求分析"></a>1.3 秒杀需求分析</h3><p>秒杀技术实现核心思想是运用缓存减少数据库瞬间的访问压力！读取商品详细信息时运用缓存，当用户点击抢购时减少缓存中的库存数量，当库存数为0时或活动期结束时，同步到数据库。 产生的秒杀预订单也不会立刻写到数据库中，而是先写到缓存，当用户付款成功后再写入数据库。</p>
<p>当然，上面实现的思路只是一种最简单的方式，并未考虑其中一些问题，例如并发状况容易产生的问题。我们看看下面这张思路更严谨的图：</p>
<p><img src="1557198248396.png"></p>
<h2 id="2-秒杀商品压入缓存"><a href="#2-秒杀商品压入缓存" class="headerlink" title="2 秒杀商品压入缓存"></a>2 秒杀商品压入缓存</h2><p><img src="1556962837177.png"></p>
<p>我们这里秒杀商品列表和秒杀商品详情都是从Redis中取出来的，所以我们首先要将符合参与秒杀的商品定时查询出来，并将数据存入到Redis缓存中。</p>
<p>数据存储类型我们可以选择Hash类型。</p>
<p>秒杀分页列表这里可以通过获取redisTemplate.boundHashOps(key).values()获取结果数据。</p>
<p>秒杀商品详情，可以通过redisTemplate.boundHashOps(key).get(key)获取详情。</p>
<h3 id="2-1-秒杀服务工程"><a href="#2-1-秒杀服务工程" class="headerlink" title="2.1 秒杀服务工程"></a>2.1 秒杀服务工程</h3><p>我们将商品数据压入到Reids缓存，可以在秒杀工程的服务工程中完成，可以按照如下步骤实现：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1.查询活动没结束的所有秒杀商品</span></span><br><span class="line">	<span class="meta">1)状态必须为审核通过</span> <span class="string">status=1</span></span><br><span class="line">	<span class="attr">2)商品库存个数&gt;0</span></span><br><span class="line">	<span class="meta">3)活动没有结束</span>  <span class="string">endTime&gt;=now()</span></span><br><span class="line">	<span class="attr">4)在Redis中没有该商品的缓存</span></span><br><span class="line">	<span class="attr">5)执行查询获取对应的结果集</span></span><br><span class="line"><span class="attr">2.将活动没有结束的秒杀商品入库</span></span><br></pre></td></tr></table></figure>

<p>我们首先搭建一个秒杀服务工程，然后按照上面步骤实现。</p>
<p>搭建changgou-service-seckill，作为秒杀工程的服务提供工程。</p>
<p>(1)pom.xml依赖</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>秒杀微服务<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-seckill<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-seckill-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(2) application.yml配置</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">18093</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">seckill</span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://192.168.211.132:3306/changgou_seckill?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line">  <span class="attr">rabbitmq</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">192.168.211.132 #mq的服务器地址</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">guest #账号</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">guest #密码</span></span><br><span class="line">  <span class="attr">main</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">allow-bean-definition-overriding</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="comment">#hystrix 配置</span></span><br><span class="line"><span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">command</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">default</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">execution</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">timeout</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #如果enabled设置为false，则请求超时交给ribbon控制</span></span><br><span class="line">          <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line">        <span class="attr">isolation</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">thread</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds</span>: <span class="string">10000</span></span><br><span class="line">          <span class="attr">strategy</span>: <span class="string">SEMAPHORE</span></span><br></pre></td></tr></table></figure>



<p>(3) 导入生成文件</p>
<p>将生成的Dao文件和Pojo文件导入到工程中，如下图：</p>
<p><img src="1565587738788.png"></p>
<p>(4) 启动类配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &#123;&quot;com.changgou.seckill.dao&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SeckillApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IdWorker <span class="title">idWorker</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IdWorker(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2-2-定时任务"><a href="#2-2-定时任务" class="headerlink" title="2.2 定时任务"></a>2.2 定时任务</h3><p>一会儿我们采用Spring的定时任务定时将符合参与秒杀的商品查询出来再存入到Redis缓存，所以这里需要使用到定时任务。</p>
<p>这里我们了解下定时任务相关的配置,配置步骤如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1)在定时任务类的指定方法上加上@Scheduled开启定时任务</span></span><br><span class="line"><span class="attr">2)定时任务表达式：使用cron属性来配置定时任务执行时间</span></span><br></pre></td></tr></table></figure>





<h4 id="2-2-1-定时任务方法配置"><a href="#2-2-1-定时任务方法配置" class="headerlink" title="2.2.1 定时任务方法配置"></a>2.2.1 定时任务方法配置</h4><p>创建com.changgou.seckill.timer.SeckillGoodsPushTask类，并在类中加上定时任务执行方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillGoodsPushTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 每30秒执行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/30 * * * * ?&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadGoodsPushRedis</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-定时任务常用时间表达式"><a href="#2-2-2-定时任务常用时间表达式" class="headerlink" title="2.2.2 定时任务常用时间表达式"></a>2.2.2 定时任务常用时间表达式</h4><p>CronTrigger配置完整格式为： [秒][分] [小时][日] [月][周] [年]</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>说明</th>
<th>是否必填</th>
<th>允许填写的值</th>
<th>允许的通配符</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>秒</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>2</td>
<td>分</td>
<td>是</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>3</td>
<td>小时</td>
<td>是</td>
<td>0-23</td>
<td>, - * /</td>
</tr>
<tr>
<td>4</td>
<td>日</td>
<td>是</td>
<td>1-31</td>
<td>, - * ? / L W</td>
</tr>
<tr>
<td>5</td>
<td>月</td>
<td>是</td>
<td>1-12或JAN-DEC</td>
<td>, - * /</td>
</tr>
<tr>
<td>6</td>
<td>周</td>
<td>是</td>
<td>1-7或SUN-SAT</td>
<td>, - * ? / L W</td>
</tr>
<tr>
<td>7</td>
<td>年</td>
<td>否</td>
<td>empty 或1970-2099</td>
<td>, - * /</td>
</tr>
</tbody></table>
<p>使用说明：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">通配符说明</span>:<span class="string"></span></span><br><span class="line"><span class="meta">*</span> <span class="string">表示所有值. 例如:在分的字段上设置 &quot;*&quot;,表示每一分钟都会触发。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?</span> <span class="string">表示不指定值。使用的场景为不需要关心当前设置这个字段的值。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">例如</span>:<span class="string">要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为&quot;?&quot; 具体设置为 0 0 0 10 * ?</span></span><br><span class="line"></span><br><span class="line"><span class="meta">-</span> <span class="string">表示区间。例如 在小时上设置 &quot;10-12&quot;,表示 10,11,12点都会触发。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">,</span> <span class="string">表示指定多个值，例如在周字段上设置 &quot;MON,WED,FRI&quot; 表示周一，周三和周五触发  12,14,19</span></span><br><span class="line"></span><br><span class="line"><span class="meta">/</span> <span class="string">用于递增触发。如在秒上面设置&quot;5/15&quot; 表示从5秒开始，每增15秒触发(5,20,35,50)。 在月字段上设置&#x27;1/3&#x27;所示每月1号开始，每隔三天触发一次。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">L</span> <span class="string">表示最后的意思。在日字段设置上，表示当月的最后一天(依据当前月份，如果是二月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于&quot;7&quot;或&quot;SAT&quot;。如果在&quot;L&quot;前加上数字，则表示该数据的最后一个。例如在周字段上设置&quot;6L&quot;这样的格式,则表示“本月最后一个星期五&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">W</span> <span class="string">表示离指定日期的最近那个工作日(周一至周五). 例如在日字段上设置&quot;15W&quot;，表示离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)触发, 如果15号是周未，则找最近的下周一(16号)触发.如果15号正好在工作日(周一至周五)，则就在该天触发。如果指定格式为 &quot;1W&quot;,它则表示每月1号往后最近的工作日触发。如果1号正是周六，则将在3号下周一触发。(注，&quot;W&quot;前只能设置具体的数字,不允许区间&quot;-&quot;).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 序号(表示每月的第几个周几)，例如在周字段上设置&quot;6#3&quot;表示在每月的第三个周六.注意如果指定&quot;#5&quot;,正好第五周没有周六，则不会触发该配置(用在母亲节和父亲节再合适不过了) ；</span></span><br></pre></td></tr></table></figure>

<p>常用表达式</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">0</span> <span class="string">0 10,14,16 * * ? 每天上午10点，下午2点，4点 </span></span><br><span class="line"><span class="attr">0</span> <span class="string">0/30 9-17 * * ? 朝九晚五工作时间内每半小时 </span></span><br><span class="line"><span class="attr">0</span> <span class="string">0 12 ? * WED 表示每个星期三中午12点 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">0 12 * * ?&quot; 每天中午12点触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 ? * *&quot; 每天上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 * * ?&quot; 每天上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 * * ? *&quot; 每天上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 * * ? 2005&quot; 2005年的每天上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">* 14 * * ?&quot; 在每天下午2点到下午2:59期间的每1分钟触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">0/5 14 * * ?&quot; 在每天下午2点到下午2:55期间的每5分钟触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">0/5 14,18 * * ?&quot; 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">0-5 14 * * ?&quot; 在每天下午2点到下午2:05期间的每1分钟触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">10,44 14 ? 3 WED&quot; 每年三月的星期三的下午2:10和2:44触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 ? * MON-FRI&quot; 周一至周五的上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 15 * ?&quot; 每月15日上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 L * ?&quot; 每月最后一日的上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 ? * 6L&quot; 每月的最后一个星期五上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 ? * 6L 2002-2005&quot; 2002年至2005年的每月的最后一个星期五上午10:15触发 </span></span><br><span class="line"><span class="meta">&quot;0</span> <span class="string">15 10 ? * 6#3&quot; 每月的第三个星期五上午10:15触发</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3-秒杀商品压入缓存实现"><a href="#2-3-秒杀商品压入缓存实现" class="headerlink" title="2.3 秒杀商品压入缓存实现"></a>2.3 秒杀商品压入缓存实现</h3><h4 id="2-3-1-数据检索条件分析"><a href="#2-3-1-数据检索条件分析" class="headerlink" title="2.3.1 数据检索条件分析"></a>2.3.1 数据检索条件分析</h4><p>按照2.1中的几个步骤实现将秒杀商品从数据库中查询出来，并存入到Redis缓存</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1.查询活动没结束的所有秒杀商品</span></span><br><span class="line">	<span class="attr">1)计算秒杀时间段</span></span><br><span class="line">	<span class="meta">2)状态必须为审核通过</span> <span class="string">status=1</span></span><br><span class="line">	<span class="attr">3)商品库存个数&gt;0</span></span><br><span class="line">	<span class="meta">4)活动没有结束</span>  <span class="string">endTime&gt;=now()</span></span><br><span class="line">	<span class="attr">5)在Redis中没有该商品的缓存</span></span><br><span class="line">	<span class="attr">6)执行查询获取对应的结果集</span></span><br><span class="line"><span class="attr">2.将活动没有结束的秒杀商品入库</span></span><br></pre></td></tr></table></figure>

<p>上面这里会涉及到时间操作，所以这里提前准备了一个时间工具包DateUtil。</p>
<h4 id="2-3-2-时间菜单分析"><a href="#2-3-2-时间菜单分析" class="headerlink" title="2.3.2 时间菜单分析"></a>2.3.2 时间菜单分析</h4><p><img src="1558681303792.png"></p>
<p>我们将商品数据从数据库中查询出来，并存入Redis缓存，但页面每次显示的时候，只显示当前正在秒杀以及往后延时2个小时、4个小时、6个小时、8个小时的秒杀商品数据。我们要做的第一个事是计算出秒杀时间菜单，这个菜单是从后台获取的。</p>
<p>这个时间菜单的计算我们来分析下，可以先求出当前时间的凌晨，然后每2个小时后作为下一个抢购的开始时间，这样可以分出12个抢购时间段,如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">00</span>:<span class="string">00-02:00</span></span><br><span class="line"><span class="attr">02</span>:<span class="string">00-04:00</span></span><br><span class="line"><span class="attr">04</span>:<span class="string">00-06:00</span></span><br><span class="line"><span class="attr">06</span>:<span class="string">00-08:00</span></span><br><span class="line"><span class="attr">08</span>:<span class="string">00-10:00</span></span><br><span class="line"><span class="attr">10</span>:<span class="string">00-12:00</span></span><br><span class="line"><span class="attr">12</span>:<span class="string">00-14:00</span></span><br><span class="line"><span class="attr">14</span>:<span class="string">00-16:00</span></span><br><span class="line"><span class="attr">16</span>:<span class="string">00-18:00</span></span><br><span class="line"><span class="attr">18</span>:<span class="string">00-20:00</span></span><br><span class="line"><span class="attr">20</span>:<span class="string">00-22:00</span></span><br><span class="line"><span class="attr">22</span>:<span class="string">00-00:00</span></span><br></pre></td></tr></table></figure>

<p>而现实的菜单只需要计算出当前时间在哪个时间段范围，该时间段范围就属于正在秒杀的时间段，而后面即将开始的秒杀时间段的计算也就出来了，可以在当前时间段基础之上+2小时、+4小时、+6小时、+8小时。</p>
<p>关于时间菜单的运算，在给出的DateUtil包里已经实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 获取时间菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Date&gt; <span class="title">getDateMenus</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//定义一个List&lt;Date&gt;集合，存储所有时间段</span></span><br><span class="line">    List&lt;Date&gt; dates = getDates(<span class="number">12</span>);</span><br><span class="line">    <span class="comment">//判断当前时间属于哪个时间范围</span></span><br><span class="line">    Date now = <span class="keyword">new</span> Date();</span><br><span class="line">    <span class="keyword">for</span> (Date cdate : dates) &#123;</span><br><span class="line">        <span class="comment">//开始时间&lt;=当前时间&lt;开始时间+2小时</span></span><br><span class="line">        <span class="keyword">if</span>(cdate.getTime()&lt;=now.getTime() &amp;&amp; now.getTime()&lt;addDateHour(cdate,<span class="number">2</span>).getTime())&#123;</span><br><span class="line">            now = cdate;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前需要显示的时间菜单</span></span><br><span class="line">    List&lt;Date&gt; dateMenus = <span class="keyword">new</span> ArrayList&lt;Date&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">5</span> ; i++) &#123;</span><br><span class="line">        dateMenus.add(addDateHour(now,i*<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dateMenus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 指定时间往后N个时间间隔</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hours</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Date&gt; <span class="title">getDates</span><span class="params">(<span class="keyword">int</span> hours)</span> </span>&#123;</span><br><span class="line">    List&lt;Date&gt; dates = <span class="keyword">new</span> ArrayList&lt;Date&gt;();</span><br><span class="line">    <span class="comment">//循环12次</span></span><br><span class="line">    Date date = toDayStartHour(<span class="keyword">new</span> Date()); <span class="comment">//凌晨</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;hours ; i++) &#123;</span><br><span class="line">        <span class="comment">//每次递增2小时,将每次递增的时间存入到List&lt;Date&gt;集合中</span></span><br><span class="line">        dates.add(addDateHour(date,i*<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-3-3-查询秒杀商品导入Reids"><a href="#2-3-3-查询秒杀商品导入Reids" class="headerlink" title="2.3.3 查询秒杀商品导入Reids"></a>2.3.3 查询秒杀商品导入Reids</h4><p>我们可以写个定时任务，查询从当前时间开始，往后延续4个时间菜单间隔，也就是一共只查询5个时间段抢购商品数据，并压入缓存，实现代码如下：</p>
<p>修改SeckillGoodsPushTask的loadGoodsPushRedis方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillGoodsPushTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillGoodsMapper seckillGoodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 定时任务方法</span></span><br><span class="line"><span class="comment">     * 0/30 * * * * ?:从每分钟的第0秒开始执行，每过30秒执行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/30 * * * * ?&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadGoodsPushRedis</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取时间段集合</span></span><br><span class="line">        List&lt;Date&gt; dateMenus = DateUtil.getDateMenus();</span><br><span class="line">        <span class="comment">//循环时间段</span></span><br><span class="line">        <span class="keyword">for</span> (Date startTime : dateMenus) &#123;</span><br><span class="line">            <span class="comment">// namespace = SeckillGoods_20195712</span></span><br><span class="line">            String extName = DateUtil.data2str(startTime,DateUtil.PATTERN_YYYYMMDDHH);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//根据时间段数据查询对应的秒杀商品数据</span></span><br><span class="line">            Example example = <span class="keyword">new</span> Example(SeckillGoods.class);</span><br><span class="line">            Example.Criteria criteria = example.createCriteria();</span><br><span class="line">            <span class="comment">// 1)商品必须审核通过  status=1</span></span><br><span class="line">            criteria.andEqualTo(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            <span class="comment">// 2)库存&gt;0</span></span><br><span class="line">            criteria.andGreaterThan(<span class="string">&quot;stockCount&quot;</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 3)开始时间&lt;=活动开始时间</span></span><br><span class="line">            criteria.andGreaterThanOrEqualTo(<span class="string">&quot;startTime&quot;</span>,startTime);</span><br><span class="line">            <span class="comment">// 4)活动结束时间&lt;开始时间+2小时</span></span><br><span class="line">            criteria.andLessThan(<span class="string">&quot;endTime&quot;</span>, DateUtil.addDateHour(startTime,<span class="number">2</span>));</span><br><span class="line">            <span class="comment">// 5)排除之前已经加载到Redis缓存中的商品数据</span></span><br><span class="line">            Set keys = redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + extName).keys();</span><br><span class="line">            <span class="keyword">if</span>(keys!=<span class="keyword">null</span> &amp;&amp; keys.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                criteria.andNotIn(<span class="string">&quot;id&quot;</span>,keys);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询数据</span></span><br><span class="line">            List&lt;SeckillGoods&gt; seckillGoods = seckillGoodsMapper.selectByExample(example);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将秒杀商品数据存入到Redis缓存</span></span><br><span class="line">            <span class="keyword">for</span> (SeckillGoods seckillGood : seckillGoods) &#123;</span><br><span class="line">                redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span>+extName).put(seckillGood.getId(),seckillGood);</span><br><span class="line">                 redisTemplate.expireAt(<span class="string">&quot;SeckillGoods_&quot;</span>+extName,DateUtil.addDateHour(dateMenu, <span class="number">2</span>));</span><br><span class="line">            </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Redis数据如下：</p>
<p><img src="1558681242681.png"></p>
<h2 id="3-秒杀频道页"><a href="#3-秒杀频道页" class="headerlink" title="3 秒杀频道页"></a>3 秒杀频道页</h2><p><img src="1556968533617.png"></p>
<p>秒杀频道首页，显示正在秒杀的和未开始秒杀的商品（已经开始或者还没开始，未结束的秒杀商品） </p>
<h3 id="3-1-秒杀时间菜单"><a href="#3-1-秒杀时间菜单" class="headerlink" title="3.1 秒杀时间菜单"></a>3.1 秒杀时间菜单</h3><p><img src="1558683021114.png"></p>
<p>如上图，时间菜单需要根据当前时间动态加载，时间菜单的计算上面功能中已经实现，在DateUtil工具包中。我们只需要将时间菜单获取，然后响应到页面，页面根据对应的数据显示即可。</p>
<p>创建com.changgou.seckill.controller.SeckillGoodsController，并添加菜单获取方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/seckill/goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillGoodsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*****</span></span><br><span class="line"><span class="comment">     * 获取时间菜单</span></span><br><span class="line"><span class="comment">     * URLL:/seckill/goods/menus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/menus&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Date&gt; <span class="title">dateMenus</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DateUtil.getDateMenus();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用Postman测试，效果如下：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:18084/seckill/goods/menus">http://localhost:18084/seckill/goods/menus</a></p>
<p><img src="1558683622962.png"></p>
<h3 id="3-2-秒杀频道页"><a href="#3-2-秒杀频道页" class="headerlink" title="3.2 秒杀频道页"></a>3.2 秒杀频道页</h3><p>秒杀频道页是指将对应时区的秒杀商品从Reids缓存中查询出来，并到页面显示。对应时区秒杀商品存储的时候以Hash类型进行了存储，key=SeckillGoods_2019010112，value=每个商品详情。</p>
<p>每次用户在前端点击对应时间菜单的时候，可以将时间菜单的开始时间以yyyyMMddHH格式提交到后台，后台根据时间格式查询出对应时区秒杀商品信息。</p>
<h4 id="3-2-1-业务层"><a href="#3-2-1-业务层" class="headerlink" title="3.2.1 业务层"></a>3.2.1 业务层</h4><p>创建com.changgou.seckill.service.SeckillGoodsService,添加根据时区查询秒杀商品的方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillGoodsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 获取指定时间对应的秒杀商品列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;SeckillGoods&gt; <span class="title">list</span><span class="params">(String key)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建com.changgou.seckill.service.impl.SeckillGoodsServiceImpl，实现根据时区查询秒杀商品的方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillGoodsServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillGoodsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * Redis中根据Key获取秒杀商品列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;SeckillGoods&gt; <span class="title">list</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span>+key).values();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="3-2-2-控制层"><a href="#3-2-2-控制层" class="headerlink" title="3.2.2 控制层"></a>3.2.2 控制层</h4><p>修改com.changgou.seckill.controller.SeckillGoodsController，并添加秒杀商品查询方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SeckillGoodsService seckillGoodsService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * URL:/seckill/goods/list</span></span><br><span class="line"><span class="comment"> * 对应时间段秒杀商品集合查询</span></span><br><span class="line"><span class="comment"> * 调用Service查询数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> time:2019050716</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;SeckillGoods&gt; <span class="title">list</span><span class="params">(String time)</span></span>&#123;</span><br><span class="line">    <span class="comment">//调用Service查询数据</span></span><br><span class="line">    <span class="keyword">return</span> seckillGoodsService.list(time);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>使用Postman测试，效果如下：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:18084/seckill/goods/list?time=2019052414">http://localhost:18084/seckill/goods/list?time=2019052414</a></p>
<p><img src="1558683781637.png"></p>
<h2 id="4-秒杀详情页"><a href="#4-秒杀详情页" class="headerlink" title="4 秒杀详情页"></a>4 秒杀详情页</h2><p>通过秒杀频道页点击请购按钮，会跳转到商品秒杀详情页，秒杀详情页需要根据商品ID查询商品详情，我们可以在频道页点击秒杀抢购的时候将ID一起传到后台，然后根据ID去Redis中查询详情信息。</p>
<h3 id="4-1-业务层"><a href="#4-1-业务层" class="headerlink" title="4.1 业务层"></a>4.1 业务层</h3><p>修改com.changgou.seckill.service.SeckillGoodsService，添加如下方法实现查询秒杀商品详情,代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * 根据ID查询商品详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> time:时间区间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id:商品ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">SeckillGoods <span class="title">one</span><span class="params">(String time,Long id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>修改com.changgou.seckill.service.impl.SeckillGoodsServiceImpl，添加查询秒杀商品详情，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * 根据商品ID查询商品详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> time:时间区间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id:商品ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillGoods <span class="title">one</span><span class="params">(String time, Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (SeckillGoods) redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span>+time).get(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-控制层"><a href="#4-2-控制层" class="headerlink" title="4.2 控制层"></a>4.2 控制层</h3><p>修改com.changgou.seckill.controller.SeckillGoodsController，添加如下方法实现查询秒杀商品详情，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * URL:/seckill/goods/one</span></span><br><span class="line"><span class="comment"> * 根据ID查询商品详情</span></span><br><span class="line"><span class="comment"> * 调用Service查询商品详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/one&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillGoods <span class="title">one</span><span class="params">(String time,Long id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//调用Service查询商品详情</span></span><br><span class="line">    <span class="keyword">return</span> seckillGoodsService.one(time,id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用Postman测试，效果如下：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:18084/seckill/goods/one?id=1131814843662340096&amp;time=2019052414">http://localhost:18084/seckill/goods/one?id=1131814843662340096&amp;time=2019052414</a></p>
<p><img src="1558684240451.png"></p>
<h2 id="5-下单实现"><a href="#5-下单实现" class="headerlink" title="5 下单实现"></a>5 下单实现</h2><p>用户下单，从控制层-&gt;Service层-&gt;Dao层，所以我们先把dao创建好，再创建service层，再创建控制层。</p>
<p>用户下单，为了提升下单速度，我们将订单数据存入到Redis缓存中，如果用户支付了，则将Reids缓存中的订单存入到MySQL中，并清空Redis缓存中的订单。</p>
<h3 id="5-1-业务层"><a href="#5-1-业务层" class="headerlink" title="5.1 业务层"></a>5.1 业务层</h3><p>创建com.changgou.seckill.service.SeckillOrderService，并在接口中增加下单方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 添加秒杀订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id:商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time:商品秒杀开始时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username:用户登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">add</span><span class="params">(Long id, String time, String username)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建com.changgou.seckill.service.impl.SeckillOrderServiceImpl实现类，并在类中添加下单实现方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillOrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillGoodsMapper seckillGoodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IdWorker idWorker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 添加订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(Long id, String time, String username)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取商品数据</span></span><br><span class="line">        SeckillGoods goods = (SeckillGoods) redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).get(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有库存，则直接抛出异常</span></span><br><span class="line">        <span class="keyword">if</span>(goods==<span class="keyword">null</span> || goods.getStockCount()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;已售罄!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果有库存，则创建秒杀商品订单</span></span><br><span class="line">        SeckillOrder seckillOrder = <span class="keyword">new</span> SeckillOrder();</span><br><span class="line">        seckillOrder.setId(idWorker.nextId());</span><br><span class="line">        seckillOrder.setSeckillId(id);</span><br><span class="line">        seckillOrder.setMoney(goods.getCostPrice());</span><br><span class="line">        seckillOrder.setUserId(username);</span><br><span class="line">        seckillOrder.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        seckillOrder.setStatus(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将秒杀订单存入到Redis中</span></span><br><span class="line">        redisTemplate.boundHashOps(<span class="string">&quot;SeckillOrder&quot;</span>).put(username,seckillOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//库存减少</span></span><br><span class="line">        goods.setStockCount(goods.getStockCount()-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前商品是否还有库存</span></span><br><span class="line">        <span class="keyword">if</span>(goods.getStockCount()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//并且将商品数据同步到MySQL中</span></span><br><span class="line">            seckillGoodsMapper.updateByPrimaryKeySelective(goods);</span><br><span class="line">            <span class="comment">//如果没有库存,则清空Redis缓存中该商品</span></span><br><span class="line">            redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).delete(id);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//如果有库存，则直数据重置到Reids中</span></span><br><span class="line">            redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).put(id,goods);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-控制层"><a href="#5-2-控制层" class="headerlink" title="5.2 控制层"></a>5.2 控制层</h3><p>创建com.changgou.seckill.controller.SeckillOrderController，添加下单方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/seckill/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillOrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillOrderService seckillOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * URL:/seckill/order/add</span></span><br><span class="line"><span class="comment">     * 添加订单</span></span><br><span class="line"><span class="comment">     * 调用Service增加订单</span></span><br><span class="line"><span class="comment">     * 匿名访问：anonymousUser</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/add&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">add</span><span class="params">(String time, Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//用户登录名</span></span><br><span class="line">            String username = TokenDcode.getUserInfo().get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用Service增加订单</span></span><br><span class="line">            Boolean bo = seckillOrderService.add(id, time, username);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(bo)&#123;</span><br><span class="line">                <span class="comment">//抢单成功</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">&quot;抢单成功！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.ERROR,<span class="string">&quot;服务器繁忙，请稍后再试&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p> 问题分析:</p>
<p>上述功能完成了秒杀抢单操作，但没有解决并发相关的问题，例如并发、超卖现象，这块甚至有可能产生雪崩问题。</p>
<h2 id="6-多线程抢单"><a href="#6-多线程抢单" class="headerlink" title="6 多线程抢单"></a>6 多线程抢单</h2><h3 id="6-1-实现思路分析"><a href="#6-1-实现思路分析" class="headerlink" title="6.1  实现思路分析"></a>6.1  实现思路分析</h3><p><img src="1557038616667.png"></p>
<p>在审视秒杀中，操作一般都是比较复杂的，而且并发量特别高，比如，检查当前账号操作是否已经秒杀过该商品，检查该账号是否存在存在刷单行为，记录用户操作日志等。</p>
<p>下订单这里，我们一般采用多线程下单，但多线程中我们又需要保证用户抢单的公平性，也就是先抢先下单。我们可以这样实现，用户进入秒杀抢单，如果用户复合抢单资格，只需要记录用户抢单数据，存入队列，多线程从队列中进行消费即可，存入队列采用左压，多线程下单采用右取的方式。</p>
<h3 id="6-2-异步实现"><a href="#6-2-异步实现" class="headerlink" title="6.2 异步实现"></a>6.2 异步实现</h3><p>要想使用Spring的异步操作，需要先开启异步操作，用<code>@EnableAsync</code>注解开启，然后在对应的异步方法上添加注解<code>@Async</code>即可。</p>
<p>创建com.changgou.seckill.task.MultiThreadingCreateOrder类，在类中创建一个createOrder方法，并在方法上添加<code>@Async</code>,代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadingCreateOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 多线程下单操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;准备执行....&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;开始执行....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面createOrder方法进行了休眠阻塞操作，我们在下单的方法调用createOrder方法，如果下单的方法没有阻塞，继续执行，说明属于异步操作，如果阻塞了，说明没有执行异步操作。</p>
<p>修改秒杀抢单SeckillOrderServiceImpl代码，注入MultiThreadingCreateOrder,并调用createOrder方法，代码如下：</p>
<p><img src="1557385433020.png"></p>
<p>使用Postman测试如下：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:18084/seckill/order/add?id=1131814847898587136&amp;time=2019052510">http://localhost:18084/seckill/order/add?id=1131814847898587136&amp;time=2019052510</a></p>
<p><img src="1558751891710.png"></p>
<h3 id="6-3-多线程抢单"><a href="#6-3-多线程抢单" class="headerlink" title="6.3 多线程抢单"></a>6.3 多线程抢单</h3><p><img src="1557040051819.png"></p>
<p>用户每次下单的时候，我们都让他们先进行排队，然后采用多线程的方式创建订单，排队我们可以采用Redis的队列实现，多线程下单我们可以采用Spring的异步实现。 </p>
<h4 id="6-3-1-多线程下单"><a href="#6-3-1-多线程下单" class="headerlink" title="6.3.1 多线程下单"></a>6.3.1 多线程下单</h4><p>将之前下单的代码全部挪到多线程的方法中，com.changgou.seckill.service.impl.SeckillOrderServiceImpl类的方法值负责调用即可，代码如下：</p>
<p><img src="1557385708495.png"></p>
<p>多线程下单代码如下图：</p>
<p><img src="1558769724637.png"></p>
<p>上图代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadingCreateOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillGoodsMapper seckillGoodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IdWorker idWorker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 多线程下单操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//时间区间</span></span><br><span class="line">            String time = <span class="string">&quot;2019052510&quot;</span>;</span><br><span class="line">            <span class="comment">//用户登录名</span></span><br><span class="line">            String username=<span class="string">&quot;szitheima&quot;</span>;</span><br><span class="line">            <span class="comment">//用户抢购商品</span></span><br><span class="line">            Long id = <span class="number">1131814847898587136L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取商品数据</span></span><br><span class="line">            SeckillGoods goods = (SeckillGoods) redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).get(id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果没有库存，则直接抛出异常</span></span><br><span class="line">            <span class="keyword">if</span>(goods==<span class="keyword">null</span> || goods.getStockCount()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;已售罄!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果有库存，则创建秒杀商品订单</span></span><br><span class="line">            SeckillOrder seckillOrder = <span class="keyword">new</span> SeckillOrder();</span><br><span class="line">            seckillOrder.setId(idWorker.nextId());</span><br><span class="line">            seckillOrder.setSeckillId(id);</span><br><span class="line">            seckillOrder.setMoney(goods.getCostPrice());</span><br><span class="line">            seckillOrder.setUserId(username);</span><br><span class="line">            seckillOrder.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">            seckillOrder.setStatus(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将秒杀订单存入到Redis中</span></span><br><span class="line">            redisTemplate.boundHashOps(<span class="string">&quot;SeckillOrder&quot;</span>).put(username,seckillOrder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//库存减少</span></span><br><span class="line">            goods.setStockCount(goods.getStockCount()-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断当前商品是否还有库存</span></span><br><span class="line">            <span class="keyword">if</span>(goods.getStockCount()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//并且将商品数据同步到MySQL中</span></span><br><span class="line">                seckillGoodsMapper.updateByPrimaryKeySelective(goods);</span><br><span class="line">                <span class="comment">//如果没有库存,则清空Redis缓存中该商品</span></span><br><span class="line">                redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).delete(id);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//如果有库存，则直数据重置到Reids中</span></span><br><span class="line">                redisTemplate.boundHashOps(<span class="string">&quot;SeckillGoods_&quot;</span> + time).put(id,goods);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时测试，是可以正常下单的，但是用户名和订单都写死了，此处需要继续优化。</p>
<h4 id="6-3-2-排队下单"><a href="#6-3-2-排队下单" class="headerlink" title="6.3.2 排队下单"></a>6.3.2 排队下单</h4><h5 id="6-3-2-1-排队信息封装"><a href="#6-3-2-1-排队信息封装" class="headerlink" title="6.3.2.1 排队信息封装"></a>6.3.2.1 排队信息封装</h5><p>用户每次下单的时候，我们可以创建一个队列进行排队，然后采用多线程的方式创建订单，排队我们可以采用Redis的队列实现。 排队信息中需要有用户抢单的商品信息，主要包含商品ID，商品抢购时间段，用户登录名。我们可以设计个javabean，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillStatus</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀用户名</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">//秒杀状态  1:排队中，2:秒杀等待支付,3:支付超时，4:秒杀失败,5:支付完成</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">//秒杀的商品ID</span></span><br><span class="line">    <span class="keyword">private</span> Long goodsId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//应付金额</span></span><br><span class="line">    <span class="keyword">private</span> Float money;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单号</span></span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="comment">//时间段</span></span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillStatus</span><span class="params">(String username, Date createTime, Integer status, Long goodsId, String time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.goodsId = goodsId;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//get、set...略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="6-3-2-2-排队实现"><a href="#6-3-2-2-排队实现" class="headerlink" title="6.3.2.2 排队实现"></a>6.3.2.2 排队实现</h5><p>我们可以将秒杀抢单信息存入到Redis中,这里采用List方式存储,List本身是一个队列，用户点击抢购的时候，就将用户抢购信息存入到Redis中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillOrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MultiThreadingCreateOrder multiThreadingCreateOrder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 添加订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(Long id, String time, String username)</span></span>&#123;</span><br><span class="line">        <span class="comment">//排队信息封装</span></span><br><span class="line">        SeckillStatus seckillStatus = <span class="keyword">new</span> SeckillStatus(username, <span class="keyword">new</span> Date(),<span class="number">1</span>, id,time);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将秒杀抢单信息存入到Redis中,这里采用List方式存储,List本身是一个队列</span></span><br><span class="line">        redisTemplate.boundListOps(<span class="string">&quot;SeckillOrderQueue&quot;</span>).leftPush(seckillStatus);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//多线程操作</span></span><br><span class="line">        multiThreadingCreateOrder.createOrder();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多线程每次从队列中获取数据，分别获取用户名和订单商品编号以及商品秒杀时间段，进行下单操作，代码如下：</p>
<p><img src="1557387173030.png"></p>
<p>上图代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 多线程下单操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//从队列中获取排队信息</span></span><br><span class="line">    SeckillStatus seckillStatus = (SeckillStatus) redisTemplate.boundListOps(<span class="string">&quot;SeckillOrderQueue&quot;</span>).rightPop();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(seckillStatus!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//时间区间</span></span><br><span class="line">            String time = seckillStatus.getTime();</span><br><span class="line">            <span class="comment">//用户登录名</span></span><br><span class="line">            String username=seckillStatus.getUsername();</span><br><span class="line">            <span class="comment">//用户抢购商品</span></span><br><span class="line">            Long id = seckillStatus.getGoodsId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//...略</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-3-3-下单状态查询"><a href="#6-3-3-下单状态查询" class="headerlink" title="6.3.3 下单状态查询"></a>6.3.3 下单状态查询</h4><p>按照上面的流程，虽然可以实现用户下单异步操作，但是并不能确定下单是否成功，所以我们需要做一个页面判断，每过1秒钟查询一次下单状态,多线程下单的时候，需要修改抢单状态，支付的时候，清理抢单状态。</p>
<h5 id="6-3-3-1-下单更新抢单状态"><a href="#6-3-3-1-下单更新抢单状态" class="headerlink" title="6.3.3.1 下单更新抢单状态"></a>6.3.3.1 下单更新抢单状态</h5><p>用户每次点击抢购的时候，如果排队成功，则将用户抢购状态存储到Redis中，多线程抢单的时候，如果抢单成功，则更新抢单状态。</p>
<p>修改SeckillOrderServiceImpl的add方法，记录状态，代码如下：</p>
<p><img src="1557387666900.png"></p>
<p>上图代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//将抢单状态存入到Redis中</span></span><br><span class="line">redisTemplate.boundHashOps(<span class="string">&quot;UserQueueStatus&quot;</span>).put(username,seckillStatus);</span><br></pre></td></tr></table></figure>



<p>多线程抢单更新状态，修改MultiThreadingCreateOrder的createOrder方法，代码如下：</p>
<p><img src="1557388020394.png"></p>
<p>上图代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//抢单成功，更新抢单状态,排队-&gt;等待支付</span></span><br><span class="line">seckillStatus.setStatus(<span class="number">2</span>);</span><br><span class="line">seckillStatus.setOrderId(seckillOrder.getId());</span><br><span class="line">seckillStatus.setMoney(seckillOrder.getMoney().floatValue());</span><br><span class="line">redisTemplate.boundHashOps(<span class="string">&quot;UserQueueStatus&quot;</span>).put(username,seckillStatus);</span><br></pre></td></tr></table></figure>



<h5 id="6-3-3-2-后台查询抢单状态"><a href="#6-3-3-2-后台查询抢单状态" class="headerlink" title="6.3.3.2 后台查询抢单状态"></a>6.3.3.2 后台查询抢单状态</h5><p>后台提供抢单状态查询方法，修改SeckillOrderService，添加如下查询方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 抢单状态查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">SeckillStatus <span class="title">queryStatus</span><span class="params">(String username)</span></span>;</span><br></pre></td></tr></table></figure>

<p>修改SeckillOrderServiceImpl,添加如下实现方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 抢单状态查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SeckillStatus <span class="title">queryStatus</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (SeckillStatus) redisTemplate.boundHashOps(<span class="string">&quot;UserQueueStatus&quot;</span>).get(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>修改SeckillOrderController,添加如下查询方法：</p>
<p><img src="1558774758978.png"></p>
<p>上图代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * 查询抢购</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/query&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">queryStatus</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取用户名</span></span><br><span class="line">    String username = tokenDcode.getUserInfo().get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据用户名查询用户抢购状态</span></span><br><span class="line">    SeckillStatus seckillStatus = seckillOrderService.queryStatus(username);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(seckillStatus!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,seckillStatus.getStatus(),<span class="string">&quot;抢购状态&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//NOTFOUNDERROR =20006,没有对应的抢购数据</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.NOTFOUNDERROR,<span class="string">&quot;没有抢购信息&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="6-3-3-3-测试"><a href="#6-3-3-3-测试" class="headerlink" title="6.3.3.3 测试"></a>6.3.3.3 测试</h5><p>使用Postman测试查询状态</p>
<p><a target="_blank" rel="noopener" href="http://localhost:18084/seckill/order/query">http://localhost:18084/seckill/order/query</a></p>
<p><img src="1558780100024.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">空白格</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lemon-cs.github.io/2020/03/23/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89/">https://lemon-cs.github.io/2020/03/23/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lemon-cs.github.io" target="_blank">Lemon-CS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></div><div class="post_share"><div class="social-share" data-image="/./images/colorhub.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/25/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E5%9B%9B%EF%BC%89/"><img class="prev-cover" src="/./images/backgroud.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">畅购商城（十四）之秒杀微服务</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/21/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89/"><img class="next-cover" src="/./images/colorhub.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">畅购商城（十二）之支付微服务</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/03/04/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="畅购商城（一）之框架搭建"><img class="cover" src="/./images/village.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-04</div><div class="title">畅购商城（一）之框架搭建</div></div></a></div><div><a href="/2020/03/15/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%83%EF%BC%89/" title="畅购商城（七）之静态页面"><img class="cover" src="/./images/scotland.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-15</div><div class="title">畅购商城（七）之静态页面</div></div></a></div><div><a href="/2020/03/11/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%89%EF%BC%89/" title="畅购商城（三）之商品微服务"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-11</div><div class="title">畅购商城（三）之商品微服务</div></div></a></div><div><a href="/2020/03/17/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B9%9D%EF%BC%89/" title="畅购商城（九）之权限验证"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-17</div><div class="title">畅购商城（九）之权限验证</div></div></a></div><div><a href="/2020/03/07/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%8C%EF%BC%89/" title="畅购商城（二）之分布式文件存储"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-07</div><div class="title">畅购商城（二）之分布式文件存储</div></div></a></div><div><a href="/2020/03/13/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%94%EF%BC%89/" title="畅购商城（五）之商品搜索"><img class="cover" src="/./images/colorhub.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-13</div><div class="title">畅购商城（五）之商品搜索</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81NTAxNC8zMTQ4Mg=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">空白格</div><div class="author-info__description">杯中的水是亮闪闪的,海里的水是黑沉沉的!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lemon-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lemon-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:591930734@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到Lemon-CS</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC13%E7%AB%A0-%E7%A7%92%E6%9D%80"><span class="toc-number">1.</span> <span class="toc-text">第13章 秒杀</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">1 秒杀业务分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 表结构说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%A7%92%E6%9D%80%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 秒杀需求分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%8E%8B%E5%85%A5%E7%BC%93%E5%AD%98"><span class="toc-number">1.3.</span> <span class="toc-text">2 秒杀商品压入缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 秒杀服务工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 定时任务方法配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B8%B8%E7%94%A8%E6%97%B6%E9%97%B4%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 定时任务常用时间表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%8E%8B%E5%85%A5%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 秒杀商品压入缓存实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E6%9D%A1%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">2.3.1 数据检索条件分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.3.2 时间菜单分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%AF%BC%E5%85%A5Reids"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">2.3.3 查询秒杀商品导入Reids</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A7%92%E6%9D%80%E9%A2%91%E9%81%93%E9%A1%B5"><span class="toc-number">1.4.</span> <span class="toc-text">3 秒杀频道页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%A7%92%E6%9D%80%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 秒杀时间菜单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%A7%92%E6%9D%80%E9%A2%91%E9%81%93%E9%A1%B5"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 秒杀频道页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">3.2.1 业务层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">3.2.2 控制层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%A7%92%E6%9D%80%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">1.5.</span> <span class="toc-text">4 秒杀详情页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 业务层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 控制层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.</span> <span class="toc-text">5 下单实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 业务层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 控制层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8A%A2%E5%8D%95"><span class="toc-number">1.7.</span> <span class="toc-text">6 多线程抢单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1  实现思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 异步实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8A%A2%E5%8D%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 多线程抢单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E5%8D%95"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">6.3.1 多线程下单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-%E6%8E%92%E9%98%9F%E4%B8%8B%E5%8D%95"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">6.3.2 排队下单</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-2-1-%E6%8E%92%E9%98%9F%E4%BF%A1%E6%81%AF%E5%B0%81%E8%A3%85"><span class="toc-number">1.7.3.2.1.</span> <span class="toc-text">6.3.2.1 排队信息封装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-2-2-%E6%8E%92%E9%98%9F%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.3.2.2.</span> <span class="toc-text">6.3.2.2 排队实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-3-%E4%B8%8B%E5%8D%95%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">6.3.3 下单状态查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-3-1-%E4%B8%8B%E5%8D%95%E6%9B%B4%E6%96%B0%E6%8A%A2%E5%8D%95%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.3.3.1.</span> <span class="toc-text">6.3.3.1 下单更新抢单状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-3-2-%E5%90%8E%E5%8F%B0%E6%9F%A5%E8%AF%A2%E6%8A%A2%E5%8D%95%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.3.3.2.</span> <span class="toc-text">6.3.3.2 后台查询抢单状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-3-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.3.3.3.</span> <span class="toc-text">6.3.3.3 测试</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/21/hello-world/" title="Hello World"><img src="/./images/backgroud.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/2021/12/21/hello-world/" title="Hello World">Hello World</a><time datetime="2021-12-21T02:50:12.155Z" title="发表于 2021-12-21 10:50:12">2021-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/05/test/" title="test"><img src="/./images/clouds.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="test"/></a><div class="content"><a class="title" href="/2021/01/05/test/" title="test">test</a><time datetime="2021-01-04T16:00:00.000Z" title="发表于 2021-01-05 00:00:00">2021-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计"><img src="/./images/village.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式接口和API设计"/></a><div class="content"><a class="title" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计">分布式接口和API设计</a><time datetime="2020-06-16T15:38:30.000Z" title="发表于 2020-06-16 23:38:30">2020-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列"><img src="/./images/colorhub.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis实战系列"/></a><div class="content"><a class="title" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列">Redis实战系列</a><time datetime="2020-06-14T08:55:40.000Z" title="发表于 2020-06-14 16:55:40">2020-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型"><img src="/./images/colorhub.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IO模型"/></a><div class="content"><a class="title" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型">IO模型</a><time datetime="2020-06-07T13:20:12.000Z" title="发表于 2020-06-07 21:20:12">2020-06-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 空白格</div><div class="footer_custom_text">欢迎来到Lemon-CS</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (true) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>