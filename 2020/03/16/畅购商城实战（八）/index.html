<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>畅购商城（八）之微服务网关和Jwt令牌 | Lemon-CS</title><meta name="keywords" content="SpringCloud,微服务,项目实战"><meta name="author" content="空白格"><meta name="copyright" content="空白格"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第8章 微服务网关和Jwt令牌学习目标 掌握微服务网关的系统搭建  了解什么是微服务网关以及它的作用  掌握系统中心微服务的搭建  掌握用户密码加密存储bcrypt  了解JWT鉴权的介绍  &#x3D;&#x3D;掌握JWT的鉴权的使用&#x3D;&#x3D; 使用Jwt令牌来存储用户登录信息，在微服务网关中识别登录信息(用户的身份)  &#x3D;&#x3D;掌握网关使用JWT进行校验&#x3D;&#x3D;  掌握&#x3D;&#x3D;网关&#x3D;&#x3D;限流   1 微服务网关1.1 微服务网关的">
<meta property="og:type" content="article">
<meta property="og:title" content="畅购商城（八）之微服务网关和Jwt令牌">
<meta property="og:url" content="https://lemon-cs.github.io/2020/03/16/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%85%AB%EF%BC%89/index.html">
<meta property="og:site_name" content="Lemon-CS">
<meta property="og:description" content="第8章 微服务网关和Jwt令牌学习目标 掌握微服务网关的系统搭建  了解什么是微服务网关以及它的作用  掌握系统中心微服务的搭建  掌握用户密码加密存储bcrypt  了解JWT鉴权的介绍  &#x3D;&#x3D;掌握JWT的鉴权的使用&#x3D;&#x3D; 使用Jwt令牌来存储用户登录信息，在微服务网关中识别登录信息(用户的身份)  &#x3D;&#x3D;掌握网关使用JWT进行校验&#x3D;&#x3D;  掌握&#x3D;&#x3D;网关&#x3D;&#x3D;限流   1 微服务网关1.1 微服务网关的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lemon-cs.github.io/images/wolf.jpg">
<meta property="article:published_time" content="2020-03-16T15:30:01.000Z">
<meta property="article:modified_time" content="2021-12-21T15:49:26.663Z">
<meta property="article:author" content="空白格">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="项目实战">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lemon-cs.github.io/images/wolf.jpg"><link rel="shortcut icon" href="/./images/Blog.png"><link rel="canonical" href="https://lemon-cs.github.io/2020/03/16/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%85%AB%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 空白格","link":"链接: ","source":"来源: Lemon-CS","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '畅购商城（八）之微服务网关和Jwt令牌',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-21 23:49:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/constown/HexoCustomFile@0.0.4/dist/css/custom.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./images/wolf.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lemon-CS</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">畅购商城（八）之微服务网关和Jwt令牌</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-16T15:30:01.000Z" title="发表于 2020-03-16 23:30:01">2020-03-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-21T15:49:26.663Z" title="更新于 2021-12-21 23:49:26">2021-12-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="畅购商城（八）之微服务网关和Jwt令牌"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第8章-微服务网关和Jwt令牌"><a href="#第8章-微服务网关和Jwt令牌" class="headerlink" title="第8章 微服务网关和Jwt令牌"></a>第8章 微服务网关和Jwt令牌</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li><p>掌握微服务网关的系统搭建</p>
</li>
<li><p>了解什么是微服务网关以及它的作用</p>
</li>
<li><p>掌握系统中心微服务的搭建</p>
</li>
<li><p>掌握用户密码加密存储bcrypt</p>
</li>
<li><p>了解JWT鉴权的介绍</p>
</li>
<li><p>==掌握JWT的鉴权的使用==</p>
<p>使用Jwt令牌来存储用户登录信息，在微服务网关中识别登录信息(用户的身份)</p>
</li>
<li><p>==掌握网关使用JWT进行校验==</p>
</li>
<li><p>掌握==网关==限流</p>
</li>
</ul>
<h2 id="1-微服务网关"><a href="#1-微服务网关" class="headerlink" title="1 微服务网关"></a>1 微服务网关</h2><h3 id="1-1-微服务网关的概述"><a href="#1-1-微服务网关的概述" class="headerlink" title="1.1 微服务网关的概述"></a>1.1 微服务网关的概述</h3><p>不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p>
<ul>
<li>客户端会多次请求不同的微服务，增加了客户端的复杂性</li>
<li>存在跨域请求，在一定场景下处理相对复杂</li>
<li>认证复杂，每个服务都需要独立认证</li>
<li>难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施</li>
<li>某些微服务可能使用了防火墙 / 浏览器不友好的协议，直接访问会有一定的困难</li>
</ul>
<p>以上这些问题可以借助网关解决。</p>
<p>网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过 网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由 网关来做，这样既提高业务灵活性又不缺安全性，典型的架构图如图所示：</p>
<p><img src="1557824391432.png" alt="微服务网关"></p>
<p>优点如下：</p>
<ul>
<li>安全 ，只有网关系统对外进行暴露，微服务可以隐藏在内网，通过防火墙保护。</li>
<li>易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。</li>
<li>易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li>
<li>减少了客户端与各个微服务之间的交互次数</li>
<li>易于统一授权。</li>
</ul>
<p>总结：微服务网关就是一个系统，通过暴露该微服务网关系统，方便我们进行相关的鉴权，安全控制，日志统一处理，易于监控的相关功能。</p>
<h3 id="1-2-微服务网关技术"><a href="#1-2-微服务网关技术" class="headerlink" title="1.2 微服务网关技术"></a>1.2 微服务网关技术</h3><p>实现微服务网关的技术有很多，</p>
<ul>
<li>nginx  Nginx (tengine x) 是一个高性能的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/HTTP">HTTP</a>和<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488">反向代理</a>web服务器，同时也提供了IMAP/POP3/SMTP服务</li>
<li>zuul ,Zuul 是 Netflix 出品的一个基于 JVM 路由和服务端的负载均衡器。</li>
<li>spring-cloud-gateway, 是spring 出品的 基于spring 的网关项目，集成断路器，路径重写，性能比Zuul好。</li>
</ul>
<p>我们使用gateway这个网关技术，无缝衔接到基于spring cloud的微服务开发中来。</p>
<p>gateway官网：</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p>
<h2 id="2-网关系统使用"><a href="#2-网关系统使用" class="headerlink" title="2 网关系统使用"></a>2 网关系统使用</h2><h3 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a>2.1 需求分析</h3><p>​    由于我们开发的系统 有包括前台系统和后台系统，后台的系统 给管理员使用。那么也需要调用各种微服务，所以我们针对 系统管理搭建一个网关系统。分析如下：</p>
<p><img src="1561959723219.png" alt="需求分析"></p>
<h3 id="2-2-搭建后台网关系统"><a href="#2-2-搭建后台网关系统" class="headerlink" title="2.2 搭建后台网关系统"></a>2.2 搭建后台网关系统</h3><h4 id="2-2-1-搭建分析"><a href="#2-2-1-搭建分析" class="headerlink" title="2.2.1 搭建分析"></a>2.2.1 搭建分析</h4><p>由上可知道，由于 需要有多个网关，所以为了管理方便。我们新建一个项目，打包方式为pom,在里面建立各种网关系统模块即可。</p>
<h4 id="2-2-2-工程搭建"><a href="#2-2-2-工程搭建" class="headerlink" title="2.2.2 工程搭建"></a>2.2.2 工程搭建</h4><p>(1)引入依赖</p>
<p>修改changgou-gateway工程，打包方式为pom</p>
<p>pom.xml如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>changgou-gateway-web<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--网关依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>在changgou-gateway工程中，创建 changgou-gateway-web工程，该网关主要用于对后台微服务进行一个调用操作，将多个微服务串联到一起。</p>
<p>pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-gateway-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        普通web请求网关</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(2)引导类</p>
<p>在changgou-gateway-web中创建一个引导类com.changgou.GatewayWebApplication，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayWebApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayWebApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(3)application.yml配置</p>
<p>在changgou-gateway-web的resources下创建application.yml,代码如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-web</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3-跨域配置"><a href="#2-3-跨域配置" class="headerlink" title="2.3 跨域配置"></a>2.3 跨域配置</h3><p>有时候，我们需要对所有微服务跨域请求进行处理，则可以在gateway中进行跨域支持。修改application.yml,添加如下代码：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods:</span> <span class="comment"># 支持的方法</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">DELETE</span></span><br></pre></td></tr></table></figure>



<p>最终文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods:</span> <span class="comment"># 支持的方法</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-web</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>





<h3 id="2-4-网关过滤配置"><a href="#2-4-网关过滤配置" class="headerlink" title="2.4 网关过滤配置"></a>2.4 网关过滤配置</h3><p><img src="1562033084310.png" alt="网关过滤配置"></p>
<p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。 路径过滤器的范围限定为特定路径。 Spring Cloud Gateway包含许多内置的GatewayFilter工厂。如上图，根据请求路径路由到不同微服务去，这块可以使用Gateway的路由过滤功能实现。</p>
<p>过滤器 有 20 多个 实现 类， 包括 头部 过滤器、 路径 类 过滤器、 Hystrix 过滤器 和 变更 请求 URL 的 过滤器， 还有 参数 和 状态 码 等 其他 类型 的 过滤器。</p>
<p>内置的过滤器工厂有22个实现类，包括 头部过滤器、路径过滤器、Hystrix 过滤器 、请求URL 变更过滤器，还有参数和状态码等其他类型的过滤器。根据过滤器工厂的用途来划分，可以分为以下几种：Header、Parameter、Path、Body、Status、Session、Redirect、Retry、RateLimiter和Hystrix。</p>
<h4 id="2-4-1-Host-路由"><a href="#2-4-1-Host-路由" class="headerlink" title="2.4.1 Host 路由"></a>2.4.1 Host 路由</h4><p>比如用户请求cloud.itheima.com的时候，可以将请求路由给<code>http://localhost:18081</code>服务处理，如下配置：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">        <span class="attr">uri</span>: <span class="string">http://localhost:18081</span></span><br><span class="line">        <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">        <span class="meta">-</span> <span class="string">Host=cloud.itheima.com**</span></span><br></pre></td></tr></table></figure>



<p>测试请求<code>http://cloud.itheima.com:8001/brand</code>,效果如下：</p>
<p><img src="1562043847287.png" alt="测试请求"></p>
<p>注意：此时要想让cloud.itheima.com访问本地计算机，要配置<code>C:\Windows\System32\drivers\etc\hosts</code>文件,映射配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1 cloud.itheima.com</span><br></pre></td></tr></table></figure>



<h4 id="2-4-2-路径匹配过滤配置"><a href="#2-4-2-路径匹配过滤配置" class="headerlink" title="2.4.2 路径匹配过滤配置"></a>2.4.2 路径匹配过滤配置</h4><p>我们还可以根据请求路径实现对应的路由过滤操作，例如请求中以<code>/brand/</code>路径开始的请求，都直接交给<code>http://localhost:180801</code>服务处理，配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">        <span class="attr">uri</span>: <span class="string">http://localhost:18081</span></span><br><span class="line">        <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">        <span class="meta">-</span> <span class="string">Path=/brand**</span></span><br></pre></td></tr></table></figure>



<p>测试请求<code>http://localhost:8001/brand</code>,效果如下：</p>
<p><img src="1562043787417.png" alt="测试请求2"></p>
<h4 id="2-4-3-PrefixPath-过滤配置"><a href="#2-4-3-PrefixPath-过滤配置" class="headerlink" title="2.4.3 PrefixPath 过滤配置"></a>2.4.3 PrefixPath 过滤配置</h4><p>用户每次请求路径的时候，我们可以给真实请求加一个统一前缀，例如用户请求<code>http://localhost:8001</code>的时候我们让它请求真实地址<code>http://localhost:8001/brand</code>，配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">        <span class="attr">uri</span>: <span class="string">http://localhost:18081</span></span><br><span class="line">        <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #- Host=cloud.itheima.com**</span></span><br><span class="line">        <span class="meta">-</span> <span class="string">Path=/**</span></span><br><span class="line">        <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line">        <span class="meta">-</span> <span class="string">PrefixPath=/brand</span></span><br></pre></td></tr></table></figure>



<p>测试请求<code>http://localhost:8001/</code>效果如下：</p>
<p><img src="1562044174592.png" alt="测试请求3"></p>
<h4 id="2-4-4-StripPrefix-过滤配置"><a href="#2-4-4-StripPrefix-过滤配置" class="headerlink" title="2.4.4 StripPrefix 过滤配置"></a>2.4.4 StripPrefix 过滤配置</h4><p>很多时候也会有这么一种请求，用户请求路径是<code>/api/brand</code>,而真实路径是<code>/brand</code>，这时候我们需要去掉<code>/api</code>才是真实路径，此时可以使用SttripPrefix功能来实现路径的过滤操作，配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">        <span class="attr">uri</span>: <span class="string">http://localhost:18081</span></span><br><span class="line">        <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #- Host=cloud.itheima.com**</span></span><br><span class="line">        <span class="meta">-</span> <span class="string">Path=/**</span></span><br><span class="line">        <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #- PrefixPath=/brand</span></span><br><span class="line">        <span class="meta">-</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>



<p>测试请求<code>http://localhost:8001/api/brand</code>,效果如下：</p>
<p><img src="1562045175964.png" alt="测试请求"></p>
<h4 id="2-4-5-LoadBalancerClient-路由过滤器-客户端负载均衡"><a href="#2-4-5-LoadBalancerClient-路由过滤器-客户端负载均衡" class="headerlink" title="2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)"></a>2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)</h4><p>上面的路由配置每次都会将请求给指定的<code>URL</code>处理，但如果在以后生产环境，并发量较大的时候，我们需要根据服务的名称判断来做负载均衡操作，可以使用<code>LoadBalancerClientFilter</code>来实现负载均衡调用。<code>LoadBalancerClientFilter</code>会作用在url以lb开头的路由，然后利用<code>loadBalancer</code>来获取服务实例，构造目标<code>requestUrl</code>，设置到<code>GATEWAY_REQUEST_URL_ATTR</code>属性中，供<code>NettyRoutingFilter</code>使用。</p>
<p>修改application.yml配置文件，配置如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line"><span class="comment">        #uri: http://localhost:18081</span></span><br><span class="line">        <span class="attr">uri</span>: <span class="string">lb://goods</span></span><br><span class="line">        <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #- Host=cloud.itheima.com**</span></span><br><span class="line">        <span class="meta">-</span> <span class="string">Path=/**</span></span><br><span class="line">        <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #- PrefixPath=/brand</span></span><br><span class="line">        <span class="meta">-</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>



<p>测试请求路径<code>http://localhost:8001/api/brand</code></p>
<p><img src="1562045175965.png" alt="测试请求5"></p>
<h3 id="2-5-网关限流"><a href="#2-5-网关限流" class="headerlink" title="2.5 网关限流"></a>2.5 网关限流</h3><p>网关可以做很多的事情，比如，限流，当我们的系统 被频繁的请求的时候，就有可能 将系统压垮，所以 为了解决这个问题，需要在每一个微服务中做限流操作，但是如果有了网关，那么就可以在网关系统做限流，因为所有的请求都需要先通过网关系统才能路由到微服务中。</p>
<h4 id="2-5-1-思路分析"><a href="#2-5-1-思路分析" class="headerlink" title="2.5.1 思路分析"></a>2.5.1 思路分析</h4><p><img src="1557909861570.png" alt="网关限流"></p>
<h4 id="2-5-2-令牌桶算法"><a href="#2-5-2-令牌桶算法" class="headerlink" title="2.5.2 令牌桶算法"></a>2.5.2 令牌桶算法</h4><p>令牌桶算法是比较常见的限流算法之一，大概描述如下：<br>1）所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；<br>2）根据限流大小，设置按照一定的速率往桶里添加令牌；<br>3）桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；<br>4）请求达到后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他的业务逻辑，处理完业务逻辑之后，将令牌直接删除；<br>5）令牌桶有最低限额，当桶中的令牌达到最低限额的时候，请求处理完之后将不会删除令牌，以此保证足够的限流</p>
<p>如下图：</p>
<p><img src="1557910299016.png" alt="令牌桶算法"></p>
<p>这个算法的实现，有很多技术，Guaua是其中之一，redis客户端也有其实现。</p>
<h4 id="2-5-3-使用令牌桶进行请求次数限流"><a href="#2-5-3-使用令牌桶进行请求次数限流" class="headerlink" title="2.5.3 使用令牌桶进行请求次数限流"></a>2.5.3 使用令牌桶进行请求次数限流</h4><p>spring cloud gateway 默认使用redis的RateLimter限流算法来实现。所以我们要使用首先需要引入redis的依赖</p>
<p>(1)引入redis依赖</p>
<p>在changgou-gateway的pom.xml中引入redis的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis-reactive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(2)定义KeyResolver</p>
<p>在Applicatioin引导类中添加如下代码，KeyResolver用于计算某一个类型的限流的KEY也就是说，可以通过KeyResolver来指定限流的Key。</p>
<p>我们可以根据IP来限流，比如每个IP每秒钟只能请求一次，在GatewayWebApplication定义key的获取，获取客户端IP，将IP作为key，如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * IP限流</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(name=&quot;ipKeyResolver&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> KeyResolver <span class="title">userKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KeyResolver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//获取远程客户端IP</span></span><br><span class="line">            String hostName = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();</span><br><span class="line">            System.out.println(<span class="string">&quot;hostName:&quot;</span>+hostName);</span><br><span class="line">            <span class="keyword">return</span> Mono.just(hostName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(3)修改application.yml中配置项，指定限制流量的配置以及REDIS的配置，配置代码如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods:</span> <span class="comment"># 支持的方法</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">changgou_goods_route</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">lb://goods</span></span><br><span class="line">              <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/api/brand**</span></span><br><span class="line">              <span class="attr">filters:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span> <span class="comment">#请求数限流 名字不能随便写 ，使用默认的facatory</span></span><br><span class="line">                <span class="attr">args:</span></span><br><span class="line">                  <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@ipKeyResolver&#125;&quot;</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-web</span></span><br><span class="line">  <span class="comment">#Redis配置</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.211</span><span class="number">.132</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p><code>redis-rate-limiter.replenishRate</code>是您希望允许用户每秒执行多少请求，而不会丢弃任何请求。这是令牌桶填充的速率</p>
<p><code>redis-rate-limiter.burstCapacity</code>是指令牌桶的容量，允许在一秒钟内完成的最大请求数,将此值设置为零将阻止所有请求。</p>
<p> key-resolver: “#{@ipKeyResolver}” 用于通过SPEL表达式来指定使用哪一个KeyResolver.</p>
<p>如上配置：</p>
<p>表示 一秒内，允许 一个请求通过，令牌桶的填充速率也是一秒钟添加一个令牌。</p>
<p>最大突发状况 也只允许 一秒内有一次请求，可以根据业务来调整 。</p>
<p>多次请求会发生如下情况</p>
<p><img src="1562049920902.png" alt="多次请求"></p>
<h2 id="3-用户登录"><a href="#3-用户登录" class="headerlink" title="3 用户登录"></a>3 用户登录</h2><p>项目中有2个重要角色，分别为管理员和用户，下面几章我们将实现购物下单和支付，用户如果没登录是没法下单和支付的，所以我们这里需要实现一个登录功能。</p>
<h3 id="3-1-表结构介绍"><a href="#3-1-表结构介绍" class="headerlink" title="3.1 表结构介绍"></a>3.1 表结构介绍</h3><p>changgou_user表如下：</p>
<p><img src="1562050583653.png" alt="changgou_user表"></p>
<p>用户信息表tb_user</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_user` (</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码，加密存储&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册手机号&#x27;</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册邮箱&#x27;</span>,</span><br><span class="line">  `created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `updated` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `source_type` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;会员来源：1:PC，2：H5，3：Android，4：IOS&#x27;</span>,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;真实姓名&#x27;</span>,</span><br><span class="line">  `status` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;使用状态（1正常 0非正常）&#x27;</span>,</span><br><span class="line">  `head_pic` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像地址&#x27;</span>,</span><br><span class="line">  `qq` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;QQ号码&#x27;</span>,</span><br><span class="line">  `is_mobile_check` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;手机是否验证 （0否  1是）&#x27;</span>,</span><br><span class="line">  `is_email_check` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;邮箱是否检测（0否  1是）&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;性别，1男，0女&#x27;</span>,</span><br><span class="line">  `user_level` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;会员等级&#x27;</span>,</span><br><span class="line">  `points` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;积分&#x27;</span>,</span><br><span class="line">  `experience_value` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经验值&#x27;</span>,</span><br><span class="line">  `birthday` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;出生年月日&#x27;</span>,</span><br><span class="line">  `last_login_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;最后登录时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`username`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `username` (`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-用户微服务创建"><a href="#3-2-用户微服务创建" class="headerlink" title="3.2 用户微服务创建"></a>3.2 用户微服务创建</h3><p>创建工程之前，先使用代码生成器生成对应的业务代码。</p>
<p>(1)公共API创建</p>
<p>在changgou-service-api中创建changgou-service-user-api，并将pojo拷贝到工程中，如下图：</p>
<p><img src="1562051835630.png" alt="changgou-service-user-api"></p>
<p>在changgou-service中创建changgou-service-user微服务,并引入生成的业务逻辑代码，如下图：</p>
<p><img src="1562051932945.png" alt="changgou-service-user"></p>
<p>(2)依赖</p>
<p>在changgou-service-user的pom.xml引入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-user<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-user-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(3)启动类创建</p>
<p>在changgou-service-user微服务中创建启动类com.changgou.UserApplication，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.changgou.user.dao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(4)application.yml配置</p>
<p>在changgou-service-user的resources中创建application.yml配置，代码如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">18089</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">user</span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">driver-class-name</span>: <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://192.168.211.132:3306/changgou_user?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>





<h3 id="3-3-登录"><a href="#3-3-登录" class="headerlink" title="3.3 登录"></a>3.3 登录</h3><p>登录的时候，需要进行密码校验，这里采用了BCryptPasswordEncoder进行加密，需要将资料中的BCrypt导入到common工程中，其中BCrypt.checkpw(“明文”,”密文”)用于对比密码是否一致。</p>
<p>修改changgou-service-user的com.changgou.user.controller.UserController添加登录方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 用户登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(String username,String password)</span></span>&#123;</span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    User user = userService.findById(username);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user!=<span class="keyword">null</span> &amp;&amp; BCrypt.checkpw(password,user.getPassword()))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">&quot;登录成功！&quot;</span>,user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">&quot;账号或者密码错误！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：这里密码进行了加密。</p>
<p>使用Postman测试如下：</p>
<p><img src="1562054405004.png" alt="测试登录"></p>
<h3 id="3-4-网关关联"><a href="#3-4-网关关联" class="headerlink" title="3.4 网关关联"></a>3.4 网关关联</h3><p><img src="1562055045607.png" alt="网关关联服务"></p>
<p>在我们平时工作中，并不会直接将微服务暴露出去，一般都会使用网关对接，实现对微服务的一个保护作用，如上图，当用户访问<code>/api/user/</code>的时候我们再根据用户请求调用用户微服务的指定方法。当然，除了<code>/api/user/</code>还有<code>/api/address/</code>、<code>/api/areas/</code>、<code>/api/cities/</code>、<code>/api/provinces/</code>都需要由user微服务处理，修改网关工程<code>changgou-gateway-web</code>的application.yml配置文件，代码如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cloud</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">gateway</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">globalcors</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">corsConfigurations</span>:<span class="string"></span></span><br><span class="line">          <span class="meta">&#x27;[/**]&#x27;</span>: <span class="string"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins</span>: <span class="string">&quot;*&quot; #跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods</span>: <span class="string"># 支持的方法</span></span><br><span class="line">                <span class="meta">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="meta">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="meta">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="meta">-</span> <span class="string">DELETE</span></span><br><span class="line">      <span class="attr">routes</span>:<span class="string"></span></span><br><span class="line">            <span class="meta">-</span> <span class="string">id: changgou_goods_route</span></span><br><span class="line">              <span class="attr">uri</span>: <span class="string">lb://goods</span></span><br><span class="line">              <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">              <span class="meta">-</span> <span class="string">Path=/api/goods/**</span></span><br><span class="line">              <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line">              <span class="meta">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">              <span class="meta">-</span> <span class="string">name: RequestRateLimiter #请求数限流 名字不能随便写 ，使用默认的facatory</span></span><br><span class="line">                <span class="attr">args</span>:<span class="string"></span></span><br><span class="line">                  <span class="meta">key-resolver</span>: <span class="string">&quot;#&#123;@ipKeyResolver&#125;&quot;</span></span><br><span class="line">                  <span class="meta">redis-rate-limiter.replenishRate</span>: <span class="string">1</span></span><br><span class="line">                  <span class="meta">redis-rate-limiter.burstCapacity</span>: <span class="string">1</span></span><br><span class="line"><span class="comment">            #用户微服务</span></span><br><span class="line">            <span class="meta">-</span> <span class="string">id: changgou_user_route</span></span><br><span class="line">              <span class="attr">uri</span>: <span class="string">lb://user</span></span><br><span class="line">              <span class="attr">predicates</span>:<span class="string"></span></span><br><span class="line">              <span class="meta">-</span> <span class="string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span></span><br><span class="line">              <span class="attr">filters</span>:<span class="string"></span></span><br><span class="line">              <span class="meta">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">gateway-web</span></span><br><span class="line"><span class="comment">  #Redis配置</span></span><br><span class="line">  <span class="attr">redis</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">192.168.211.132</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">8001</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">management</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">endpoint</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">gateway</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line">    <span class="attr">web</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">exposure</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">include</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>



<p>使用Postman访问<code>http://localhost:8001/api/user/login?username=changgou&amp;password=changgou</code>，效果如下：</p>
<p><img src="1562055882671.png" alt="登录测试2"></p>
<h2 id="4-JWT讲解"><a href="#4-JWT讲解" class="headerlink" title="4 JWT讲解"></a>4 JWT讲解</h2><h3 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h3><p>我们之前已经搭建过了网关，使用网关在网关系统中比较适合进行权限校验。</p>
<p><img src="1562059385713.png" alt="JWT鉴权"></p>
<p>那么我们可以采用JWT的方式来实现鉴权校验。</p>
<h3 id="4-2-什么是JWT"><a href="#4-2-什么是JWT" class="headerlink" title="4.2 什么是JWT"></a>4.2 什么是JWT</h3><p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p>
<h3 id="4-3-JWT的构成"><a href="#4-3-JWT的构成" class="headerlink" title="4.3 JWT的构成"></a>4.3 JWT的构成</h3><p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p>
<p><strong>头部（Header）</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;typ&quot;</span>:<span class="string">&quot;JWT&quot;</span>,<span class="attr">&quot;alg&quot;</span>:<span class="string">&quot;HS256&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>在头部指明了签名算法是HS256算法。 我们进行BASE64编码<a target="_blank" rel="noopener" href="http://base64.xpcha.com/%EF%BC%8C%E7%BC%96%E7%A0%81%E5%90%8E%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A6%82%E4%B8%8B%EF%BC%9A">http://base64.xpcha.com/，编码后的字符串如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小知识：Base64是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 <strong>BASE64Encoder</strong> 和 <strong>BASE64Decoder</strong>，用它们可以非常方便的完成基于 BASE64 的编码和解码</p>
</blockquote>
<p><strong>载荷（playload）</strong></p>
<p>载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分</p>
<p>（1）标准中注册的声明（建议但不强制使用）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: jwt所面向的用户</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>

<p>（2）公共的声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.   </p>
<p>（3）私有的声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>这个指的就是自定义的claim。比如下面面结构举例中的admin和name都属于自定的claim。这些claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，都知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<p>定义一个payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;sub&quot;:&quot;1234567890&quot;,&quot;name&quot;:&quot;John Doe&quot;,&quot;admin&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>然后将其进行base64加密，得到Jwt的第二部分。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><br></pre></td></tr></table></figure>

<p><strong>签证（signature）</strong></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<blockquote>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret</p>
</blockquote>
<p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>

<p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p>
<h3 id="4-4-JJWT的介绍和使用"><a href="#4-4-JJWT的介绍和使用" class="headerlink" title="4.4 JJWT的介绍和使用"></a>4.4 JJWT的介绍和使用</h3><p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a></p>
<h4 id="4-4-1-创建TOKEN"><a href="#4-4-1-创建TOKEN" class="headerlink" title="4.4.1 创建TOKEN"></a>4.4.1 创建TOKEN</h4><p>(1)依赖引入</p>
<p>在changgou-parent项目中的pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--鉴权--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>(2)创建测试</p>
<p>在changgou-common的/test/java下创建测试类，并设置测试方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****</span></span><br><span class="line"><span class="comment">     * 创建Jwt令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateJwt</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JwtBuilder builder= Jwts.builder()</span><br><span class="line">                .setId(<span class="string">&quot;888&quot;</span>)             <span class="comment">//设置唯一编号</span></span><br><span class="line">                .setSubject(<span class="string">&quot;小白&quot;</span>)       <span class="comment">//设置主题  可以是JSON数据</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())  <span class="comment">//设置签发日期</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256,<span class="string">&quot;itcast&quot;</span>);<span class="comment">//设置签名 使用HS256算法，并设置SecretKey(字符串)</span></span><br><span class="line">        <span class="comment">//构建 并返回一个字符串</span></span><br><span class="line">        System.out.println( builder.compact() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行打印结果：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4</span></span><br></pre></td></tr></table></figure>

<p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p>
<h4 id="4-4-2-TOKEN解析"><a href="#4-4-2-TOKEN解析" class="headerlink" title="4.4.2 TOKEN解析"></a>4.4.2 TOKEN解析</h4><p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseJwt</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjIyODd9.RBLpZ79USMplQyfJCZFD2muHV_KLks7M1ZsjTu6Aez4&quot;</span>;</span><br><span class="line">    Claims claims = Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行打印效果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;jti=888, sub=小白, iat=1562062287&#125;</span><br></pre></td></tr></table></figure>

<p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p>
<h4 id="4-4-3-设置过期时间"><a href="#4-4-3-设置过期时间" class="headerlink" title="4.4.3 设置过期时间"></a>4.4.3 设置过期时间</h4><p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p>
<h5 id="4-4-3-1-token过期设置"><a href="#4-4-3-1-token过期设置" class="headerlink" title="4.4.3.1 token过期设置"></a>4.4.3.1 token过期设置</h5><p><img src="1562062896413.png" alt="token过期设置"></p>
<p>解释：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">.setExpiration(date)//用于设置过期时间</span> <span class="string">，参数为Date类型数据</span></span><br></pre></td></tr></table></figure>

<p>运行，打印效果如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q</span></span><br></pre></td></tr></table></figure>



<h5 id="4-4-3-2-解析TOKEN"><a href="#4-4-3-2-解析TOKEN" class="headerlink" title="4.4.3.2 解析TOKEN"></a>4.4.3.2 解析TOKEN</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseJwt</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjI5MjUsImV4cCI6MTU2MjA2MjkyNX0._vs4METaPkCza52LuN0-2NGGWIIO7v51xt40DHY1U1Q&quot;</span>;</span><br><span class="line">    Claims claims = Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印效果：</p>
<p><img src="1562063075099.png" alt="解析TOKEN"></p>
<p>当前时间超过过期时间，则会报错。</p>
<h4 id="4-4-4-自定义claims"><a href="#4-4-4-自定义claims" class="headerlink" title="4.4.4 自定义claims"></a>4.4.4 自定义claims</h4><p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims。</p>
<p>创建测试类，并设置测试方法：</p>
<p>创建token:</p>
<p><img src="1562063346685.png" alt="自定义claims"></p>
<p>运行打印效果：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjMyOTIsImFkZHJlc3MiOiLmt7HlnLPpu5Hpqazorq3nu4PokKXnqIvluo_lkZjkuK3lv4MiLCJuYW1lIjoi546L5LqUIiwiYWdlIjoyN30.ZSbHt5qrxz0F1Ma9rVHHAIy4jMCBGIHoNaaPQXxV_dk</span></span><br></pre></td></tr></table></figure>



<p>解析TOKEN:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 解析Jwt令牌数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseJwt</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String compactJwt=<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NjIwNjMyOTIsImFkZHJlc3MiOiLmt7HlnLPpu5Hpqazorq3nu4PokKXnqIvluo_lkZjkuK3lv4MiLCJuYW1lIjoi546L5LqUIiwiYWdlIjoyN30.ZSbHt5qrxz0F1Ma9rVHHAIy4jMCBGIHoNaaPQXxV_dk&quot;</span>;</span><br><span class="line">    Claims claims = Jwts.parser().</span><br><span class="line">            setSigningKey(<span class="string">&quot;itcast&quot;</span>).</span><br><span class="line">            parseClaimsJws(compactJwt).</span><br><span class="line">            getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果：</p>
<p><img src="1562063412350.png" alt="自定义claims效果"></p>
<h3 id="4-5-鉴权处理"><a href="#4-5-鉴权处理" class="headerlink" title="4.5 鉴权处理"></a>4.5 鉴权处理</h3><h4 id="4-5-1-思路分析"><a href="#4-5-1-思路分析" class="headerlink" title="4.5.1 思路分析"></a>4.5.1 思路分析</h4><p><img src="1562069596308.png" alt="鉴权处理"></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1.用户通过访问微服务网关调用微服务，同时携带头文件信息</span></span><br><span class="line"><span class="attr">2.在微服务网关这里进行拦截，拦截后获取用户要访问的路径</span></span><br><span class="line"><span class="attr">3.识别用户访问的路径是否需要登录，如果需要，识别用户的身份是否能访问该路径[这里可以基于数据库设计一套权限]</span></span><br><span class="line"><span class="attr">4.如果需要权限访问，用户已经登录，则放行</span></span><br><span class="line"><span class="attr">5.如果需要权限访问，且用户未登录，则提示用户需要登录</span></span><br><span class="line"><span class="attr">6.用户通过网关访问用户微服务，进行登录验证</span></span><br><span class="line"><span class="attr">7.验证通过后，用户微服务会颁发一个令牌给网关，网关会将用户信息封装到头文件中，并响应用户</span></span><br><span class="line"><span class="attr">8.用户下次访问，携带头文件中的令牌信息即可识别是否登录</span></span><br></pre></td></tr></table></figure>



<h4 id="4-5-2用户登录签发TOKEN"><a href="#4-5-2用户登录签发TOKEN" class="headerlink" title="4.5.2用户登录签发TOKEN"></a>4.5.2用户登录签发TOKEN</h4><p>(1)生成令牌工具类</p>
<p>在changgou-common中创建类entity.JwtUtil，主要辅助生成Jwt令牌信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有效期为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long JWT_TTL = <span class="number">3600000L</span>;<span class="comment">// 60 * 60 *1000  一个小时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Jwt令牌信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JWT_KEY = <span class="string">&quot;itcast&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createJWT</span><span class="params">(String id, String subject, Long ttlMillis)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//指定算法</span></span><br><span class="line">        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当前系统时间</span></span><br><span class="line">        <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//令牌签发时间</span></span><br><span class="line">        Date now = <span class="keyword">new</span> Date(nowMillis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果令牌有效期为null，则默认设置有效期1小时</span></span><br><span class="line">        <span class="keyword">if</span>(ttlMillis==<span class="keyword">null</span>)&#123;</span><br><span class="line">            ttlMillis=JwtUtil.JWT_TTL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//令牌过期时间设置</span></span><br><span class="line">        <span class="keyword">long</span> expMillis = nowMillis + ttlMillis;</span><br><span class="line">        Date expDate = <span class="keyword">new</span> Date(expMillis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成秘钥</span></span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装Jwt令牌信息</span></span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setId(id)                    <span class="comment">//唯一的ID</span></span><br><span class="line">                .setSubject(subject)          <span class="comment">// 主题  可以是JSON数据</span></span><br><span class="line">                .setIssuer(<span class="string">&quot;admin&quot;</span>)          <span class="comment">// 签发者</span></span><br><span class="line">                .setIssuedAt(now)             <span class="comment">// 签发时间</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey) <span class="comment">// 签名算法以及密匙</span></span><br><span class="line">                .setExpiration(expDate);      <span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成加密 secretKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title">generalKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] encodedKey = Base64.getEncoder().encode(JwtUtil.JWT_KEY.getBytes());</span><br><span class="line">        SecretKey key = <span class="keyword">new</span> SecretKeySpec(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析令牌数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>(2) 用户登录成功 则 签发TOKEN，修改登录的方法：</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 用户登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">login</span><span class="params">(String username,String password)</span></span>&#123;</span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    User user = userService.findById(username);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user!=<span class="keyword">null</span> &amp;&amp; BCrypt.checkpw(password,user.getPassword()))&#123;</span><br><span class="line">        <span class="comment">//设置令牌信息</span></span><br><span class="line">        Map&lt;String,Object&gt; info = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">        info.put(<span class="string">&quot;role&quot;</span>,<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">        info.put(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        info.put(<span class="string">&quot;username&quot;</span>,username);</span><br><span class="line">        <span class="comment">//生成令牌</span></span><br><span class="line">        String jwt = JwtUtil.createJWT(UUID.randomUUID().toString(), JSON.toJSONString(info),<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>,StatusCode.OK,<span class="string">&quot;登录成功！&quot;</span>,jwt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> Result(<span class="keyword">false</span>,StatusCode.LOGINERROR,<span class="string">&quot;账号或者密码错误！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-5-3-网关过滤器拦截请求处理"><a href="#4-5-3-网关过滤器拦截请求处理" class="headerlink" title="4.5.3 网关过滤器拦截请求处理"></a>4.5.3 网关过滤器拦截请求处理</h4><p>拷贝JwtUtil到changgou-gateway-web中</p>
<h4 id="4-5-4-自定义全局过滤器"><a href="#4-5-4-自定义全局过滤器" class="headerlink" title="4.5.4 自定义全局过滤器"></a>4.5.4 自定义全局过滤器</h4><p>创建 过滤器类，AuthorizeFilter代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizeFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌头名字</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORIZE_TOKEN = <span class="string">&quot;Authorization&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 全局过滤器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取Request、Response对象</span></span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取请求的URI</span></span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是登录、goods等开放的微服务[这里的goods部分开放],则直接放行,这里不做完整演示，完整演示需要设计一套权限系统</span></span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/api/user/login&quot;</span>) || path.startsWith(<span class="string">&quot;/api/brand/search/&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            Mono&lt;Void&gt; filter = chain.filter(exchange);</span><br><span class="line">            <span class="keyword">return</span> filter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取头文件中的令牌信息</span></span><br><span class="line">        String tokent = request.getHeaders().getFirst(AUTHORIZE_TOKEN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果头文件中没有，则从请求参数中获取</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(tokent)) &#123;</span><br><span class="line">            tokent = request.getQueryParams().getFirst(AUTHORIZE_TOKEN);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果为空，则输出错误代码</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(tokent)) &#123;</span><br><span class="line">            <span class="comment">//设置方法不允许被访问，405错误代码</span></span><br><span class="line">           response.setStatusCode(HttpStatus.METHOD_NOT_ALLOWED);</span><br><span class="line">           <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析令牌数据</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Claims claims = JwtUtil.parseJWT(tokent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//解析失败，响应401错误</span></span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 过滤器执行顺序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="4-5-5-配置过滤规则"><a href="#4-5-5-配置过滤规则" class="headerlink" title="4.5.5 配置过滤规则"></a>4.5.5 配置过滤规则</h4><p>修改网关系统的yml文件：</p>
<p>代码如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment"># 匹配所有请求</span></span><br><span class="line">              <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#跨域处理 允许所有的域</span></span><br><span class="line">              <span class="attr">allowedMethods:</span> <span class="comment"># 支持的方法</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">changgou_goods_route</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">lb://goods</span></span><br><span class="line">              <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span></span><br><span class="line">              <span class="attr">filters:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span> <span class="comment">#请求数限流 名字不能随便写 ，使用默认的facatory</span></span><br><span class="line">                <span class="attr">args:</span></span><br><span class="line">                  <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@ipKeyResolver&#125;&quot;</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span></span><br><span class="line">                  <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">1</span></span><br><span class="line">            <span class="comment">#用户微服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">changgou_user_route</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">lb://user</span></span><br><span class="line">              <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span></span><br><span class="line">              <span class="attr">filters:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-web</span></span><br><span class="line">  <span class="comment">#Redis配置</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.211</span><span class="number">.132</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>测试访问<code>http://localhost:8001/api/user/login?username=changgou&amp;password=changgou</code>，效果如下：</p>
<p><img src="1562117166529.png" alt="测试访问1"></p>
<p>测试访问<code>http://localhost:8001/api/user</code>，效果如下：</p>
<p><img src="1562117230885.png" alt="测试访问2"></p>
<p>参考官方手册：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory">https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory</a></p>
<h3 id="4-6-会话保持"><a href="#4-6-会话保持" class="headerlink" title="4.6 会话保持"></a>4.6 会话保持</h3><p>用户每次请求的时候，我们都需要获取令牌数据，方法有多重，可以在每次提交的时候，将数据提交到头文件中，也可以将数据存储到Cookie中，每次从Cookie中校验数据，还可以每次将令牌数据以参数的方式提交到网关，这里面采用Cookie的方式比较容易实现。</p>
<h4 id="4-6-1-登录封装Cookie"><a href="#4-6-1-登录封装Cookie" class="headerlink" title="4.6.1 登录封装Cookie"></a>4.6.1 登录封装Cookie</h4><p>修改user微服务，每次登录的时候，添加令牌信息到Cookie中，修改changgou-service-user的<code>com.changgou.user.controller.UserController</code>的<code>login</code>方法，代码如下：</p>
<p><img src="1562120506682.png" alt="登录封装Cookie"></p>
<h4 id="4-6-2-过滤器获取令牌数据"><a href="#4-6-2-过滤器获取令牌数据" class="headerlink" title="4.6.2 过滤器获取令牌数据"></a>4.6.2 过滤器获取令牌数据</h4><p>每次在网关中通过过滤器获取Cookie中的令牌，然后对令牌数据进行解析，修改微服务网关changgou-gateway-web中的AuthorizeFilter，代码如下：</p>
<p><img src="1562120763383.png" alt="获取令牌数据"></p>
<p>登录后测试，可以识别用户身份，不登录无法识别。如下访问<code>http://localhost:8001/api/user</code>会携带令牌数据：</p>
<p><img src="1562121093670.png" alt="登录后测试"></p>
<h4 id="4-6-3-添加Header信息"><a href="#4-6-3-添加Header信息" class="headerlink" title="4.6.3 添加Header信息"></a>4.6.3 添加Header信息</h4><p>我们还可以在Gateway的全局过滤器中添加请求头信息，例如可以讲令牌信息添加到请求头中，在微服务中获取头信息，如下代码：</p>
<p>修改微服务网关中的AuthorizeFilter过滤器，在令牌信息校验那块将令牌加入到请求头中，如下代码：</p>
<p><img src="1562243515236.png" alt="添加Header信息1"></p>
<p>在changgou-service-user微服务的UserController的findAll方法中获取请求头测试，代码如下：</p>
<p><img src="1562243608017.png" alt="添加Header信息2"></p>
<p>后台输出令牌数据如下：</p>
<p><img src="1562243685686.png" alt="输出令牌数据"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">空白格</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lemon-cs.github.io/2020/03/16/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%85%AB%EF%BC%89/">https://lemon-cs.github.io/2020/03/16/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%85%AB%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lemon-cs.github.io" target="_blank">Lemon-CS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></div><div class="post_share"><div class="social-share" data-image="/./images/wolf.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/17/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B9%9D%EF%BC%89/"><img class="prev-cover" src="/./images/clouds.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">畅购商城（九）之权限验证</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/15/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%83%EF%BC%89/"><img class="next-cover" src="/./images/scotland.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">畅购商城（七）之静态页面</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/03/04/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="畅购商城（一）之框架搭建"><img class="cover" src="/./images/village.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-04</div><div class="title">畅购商城（一）之框架搭建</div></div></a></div><div><a href="/2020/03/15/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%83%EF%BC%89/" title="畅购商城（七）之静态页面"><img class="cover" src="/./images/scotland.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-15</div><div class="title">畅购商城（七）之静态页面</div></div></a></div><div><a href="/2020/03/11/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%89%EF%BC%89/" title="畅购商城（三）之商品微服务"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-11</div><div class="title">畅购商城（三）之商品微服务</div></div></a></div><div><a href="/2020/03/17/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B9%9D%EF%BC%89/" title="畅购商城（九）之权限验证"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-17</div><div class="title">畅购商城（九）之权限验证</div></div></a></div><div><a href="/2020/03/07/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%8C%EF%BC%89/" title="畅购商城（二）之分布式文件存储"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-07</div><div class="title">畅购商城（二）之分布式文件存储</div></div></a></div><div><a href="/2020/03/13/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%94%EF%BC%89/" title="畅购商城（五）之商品搜索"><img class="cover" src="/./images/colorhub.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-13</div><div class="title">畅购商城（五）之商品搜索</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81NTAxNC8zMTQ4Mg=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">空白格</div><div class="author-info__description">杯中的水是亮闪闪的,海里的水是黑沉沉的!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lemon-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lemon-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:591930734@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到Lemon-CS</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC8%E7%AB%A0-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E5%92%8CJwt%E4%BB%A4%E7%89%8C"><span class="toc-number">1.</span> <span class="toc-text">第8章 微服务网关和Jwt令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">1 微服务网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 微服务网关的概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 微服务网关技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BD%91%E5%85%B3%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">2 网关系统使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%90%AD%E5%BB%BA%E5%90%8E%E5%8F%B0%E7%BD%91%E5%85%B3%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 搭建后台网关系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%90%AD%E5%BB%BA%E5%88%86%E6%9E%90"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 搭建分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 工程搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 跨域配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 网关过滤配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-Host-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">2.4.1 Host 路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E8%BF%87%E6%BB%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2.4.2 路径匹配过滤配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-PrefixPath-%E8%BF%87%E6%BB%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">2.4.3 PrefixPath 过滤配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-4-StripPrefix-%E8%BF%87%E6%BB%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">2.4.4 StripPrefix 过滤配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-5-LoadBalancerClient-%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">2.4.5 LoadBalancerClient 路由过滤器(客户端负载均衡)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 网关限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">2.5.1 思路分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">2.5.2 令牌桶算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3-%E4%BD%BF%E7%94%A8%E4%BB%A4%E7%89%8C%E6%A1%B6%E8%BF%9B%E8%A1%8C%E8%AF%B7%E6%B1%82%E6%AC%A1%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">2.5.3 使用令牌桶进行请求次数限流</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">1.4.</span> <span class="toc-text">3 用户登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%A1%A8%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 表结构介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%94%A8%E6%88%B7%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 用户微服务创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%99%BB%E5%BD%95"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%BD%91%E5%85%B3%E5%85%B3%E8%81%94"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 网关关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-JWT%E8%AE%B2%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">4 JWT讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BB%80%E4%B9%88%E6%98%AFJWT"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 什么是JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-JWT%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 JWT的构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-JJWT%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.4.</span> <span class="toc-text">4.4 JJWT的介绍和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-%E5%88%9B%E5%BB%BATOKEN"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">4.4.1 创建TOKEN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-TOKEN%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">4.4.2 TOKEN解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3-%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">4.4.3 设置过期时间</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-1-token%E8%BF%87%E6%9C%9F%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.5.4.3.1.</span> <span class="toc-text">4.4.3.1 token过期设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-2-%E8%A7%A3%E6%9E%90TOKEN"><span class="toc-number">1.5.4.3.2.</span> <span class="toc-text">4.4.3.2 解析TOKEN</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-4-%E8%87%AA%E5%AE%9A%E4%B9%89claims"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">4.4.4 自定义claims</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%89%B4%E6%9D%83%E5%A4%84%E7%90%86"><span class="toc-number">1.5.5.</span> <span class="toc-text">4.5 鉴权处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">4.5.1 思路分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-2%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%AD%BE%E5%8F%91TOKEN"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">4.5.2用户登录签发TOKEN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-3-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8B%A6%E6%88%AA%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">4.5.3 网关过滤器拦截请求处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.5.5.4.</span> <span class="toc-text">4.5.4 自定义全局过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-5-%E9%85%8D%E7%BD%AE%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="toc-number">1.5.5.5.</span> <span class="toc-text">4.5.5 配置过滤规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">1.5.6.</span> <span class="toc-text">4.6 会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-%E7%99%BB%E5%BD%95%E5%B0%81%E8%A3%85Cookie"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">4.6.1 登录封装Cookie</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-2-%E8%BF%87%E6%BB%A4%E5%99%A8%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">4.6.2 过滤器获取令牌数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-3-%E6%B7%BB%E5%8A%A0Header%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">4.6.3 添加Header信息</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/21/hello-world/" title="Hello World"><img src="/./images/backgroud.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/2021/12/21/hello-world/" title="Hello World">Hello World</a><time datetime="2021-12-21T02:50:12.155Z" title="发表于 2021-12-21 10:50:12">2021-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/05/test/" title="test"><img src="/./images/clouds.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="test"/></a><div class="content"><a class="title" href="/2021/01/05/test/" title="test">test</a><time datetime="2021-01-04T16:00:00.000Z" title="发表于 2021-01-05 00:00:00">2021-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计"><img src="/./images/village.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式接口和API设计"/></a><div class="content"><a class="title" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计">分布式接口和API设计</a><time datetime="2020-06-16T15:38:30.000Z" title="发表于 2020-06-16 23:38:30">2020-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列"><img src="/./images/colorhub.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis实战系列"/></a><div class="content"><a class="title" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列">Redis实战系列</a><time datetime="2020-06-14T08:55:40.000Z" title="发表于 2020-06-14 16:55:40">2020-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型"><img src="/./images/colorhub.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IO模型"/></a><div class="content"><a class="title" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型">IO模型</a><time datetime="2020-06-07T13:20:12.000Z" title="发表于 2020-06-07 21:20:12">2020-06-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 空白格</div><div class="footer_custom_text">欢迎来到Lemon-CS</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (true) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>