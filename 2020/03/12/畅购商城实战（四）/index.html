<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>畅购商城（四）之广告缓存 | Lemon-CS</title><meta name="keywords" content="SpringCloud,微服务,项目实战"><meta name="author" content="空白格"><meta name="copyright" content="空白格"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第4章 lua、Canal实现广告缓存学习目标 Lua介绍 Lua语法 输出、变量定义、数据类型、流程控制(if..)、循环操作、函数、表(数组)、模块 OpenResty介绍(理解配置) 封装了Nginx，并且提供了Lua扩展，大大提升了Nginx对并发处理的能，10K-1000KLua-&gt;广告缓存操作 广告缓存载入与读取  Nginx讲解 限流操作:漏斗限流原理	1.控制速率	2.并发量"><meta property="og:type" content="article"><meta property="og:title" content="畅购商城（四）之广告缓存"><meta property="og:url" content="https://lemon-cs.github.io/2020/03/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%9B%9B%EF%BC%89/index.html"><meta property="og:site_name" content="Lemon-CS"><meta property="og:description" content="第4章 lua、Canal实现广告缓存学习目标 Lua介绍 Lua语法 输出、变量定义、数据类型、流程控制(if..)、循环操作、函数、表(数组)、模块 OpenResty介绍(理解配置) 封装了Nginx，并且提供了Lua扩展，大大提升了Nginx对并发处理的能，10K-1000KLua-&gt;广告缓存操作 广告缓存载入与读取  Nginx讲解 限流操作:漏斗限流原理	1.控制速率	2.并发量"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lemon-cs.github.io/images/colorhub.jpg"><meta property="article:published_time" content="2020-03-12T12:39:28.000Z"><meta property="article:modified_time" content="2021-12-21T15:49:27.797Z"><meta property="article:author" content="空白格"><meta property="article:tag" content="SpringCloud"><meta property="article:tag" content="微服务"><meta property="article:tag" content="项目实战"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lemon-cs.github.io/images/colorhub.jpg"><link rel="shortcut icon" href="/./images/Blog.png"><link rel="canonical" href="https://lemon-cs.github.io/2020/03/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%9B%9B%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 空白格","link":"链接: ","source":"来源: Lemon-CS","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"畅购商城（四）之广告缓存",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-12-21 23:49:27"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/constown/HexoCustomFile@0.0.4/dist/css/custom.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./images/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/./images/colorhub.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lemon-CS</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">畅购商城（四）之广告缓存</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-12T12:39:28.000Z" title="发表于 2020-03-12 20:39:28">2020-03-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-21T15:49:27.797Z" title="更新于 2021-12-21 23:49:27">2021-12-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="畅购商城（四）之广告缓存"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第4章-lua、Canal实现广告缓存"><a href="#第4章-lua、Canal实现广告缓存" class="headerlink" title="第4章 lua、Canal实现广告缓存"></a>第4章 lua、Canal实现广告缓存</h1><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><ul><li><p>Lua介绍</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Lua语法 输出、变量定义、数据类型、流程控制(if..)、循环操作、函数、表(数组)、模块</span><br></pre></td></tr></table></figure></li><li><p>OpenResty介绍(理解配置)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">封装了Nginx，并且提供了Lua扩展，大大提升了Nginx对并发处理的能，10K-1000K</span><br><span class="line">Lua-&gt;广告缓存操作</span><br></pre></td></tr></table></figure></li><li><p>广告缓存载入与读取</p></li><li><p>Nginx讲解</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">限流操作:漏斗限流原理</span><br><span class="line">	1.控制速率</span><br><span class="line">	2.并发量控制</span><br></pre></td></tr></table></figure></li><li><p>Canal讲解</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">实现数据同步操作-&gt;MySQL</span><br></pre></td></tr></table></figure></li><li><p>Canal实现首页缓存同步</p></li></ul><h2 id="1-首页分析"><a href="#1-首页分析" class="headerlink" title="1 首页分析"></a>1 首页分析</h2><p>首页门户系统需要展示各种各样的广告数据。如图，以jd为例：</p><p><img src="%E9%A6%96%E9%A1%B5%E5%88%86%E6%9E%90.png" alt="首页分析"></p><p>变更频率低的数据，如何提升访问速度？</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.数据做成静态页[商品详情页]</span><br><span class="line">2.做缓存[Redis]</span><br></pre></td></tr></table></figure><p>基本的思路如下：</p><p><img src="%E9%A6%96%E9%A1%B5%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF.png" alt="首页基本思路"></p><p>如上图此种方式 简单，直接通过数据库查询数据展示给用户即可，但是通常情况下，首页（门户系统的流量一般非常的高）不适合直接通过mysql数据库直接访问的方式来获取展示。</p><p><strong>如下思路：</strong></p><ol><li><p>首先访问nginx ，我们可以采用缓存的方式，先从nginx本地缓存中获取，获取到直接响应</p></li><li><p>如果没有获取到，再次访问redis，我们可以从redis中获取数据，如果有 则返回，并缓存到nginx中</p></li><li><p>如果没有获取到,再次访问mysql,我们从mysql中获取数据，再将数据存储到redis中，返回。</p></li></ol><p>而这里面，我们都可以使用LUA脚本嵌入到程序中执行这些查询相关的业务。</p><p><img src="%E7%95%85%E8%B4%AD%E9%A6%96%E9%A1%B5%E5%B9%BF%E5%91%8A.png" alt="畅购首页广告"></p><h2 id="2-Lua-了解"><a href="#2-Lua-了解" class="headerlink" title="2 Lua(了解)"></a>2 Lua(了解)</h2><h3 id="2-1-lua是什么"><a href="#2-1-lua是什么" class="headerlink" title="2.1 lua是什么"></a>2.1 lua是什么</h3><p>Lua [1] 是一个小巧的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80">脚本语言</a>。它是巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个由Roberto Ierusalimschy、Waldemar Celes 和 Luiz Henrique de Figueiredo三人所组成的研究小组于1993年开发的。 其设计目的是为了通过灵活嵌入应用程序中从而为应用程序提供灵活的扩展和定制功能。Lua由标准C编写而成，几乎在所有操作系统和平台上都可以编译，运行。Lua并没有提供强大的库，这是由它的定位决定的。所以Lua不适合作为开发独立应用程序的语言。Lua 有一个同时进行的JIT项目，提供在特定平台上的即时编译功能。</p><p>简单来说：</p><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p><h3 id="2-2-特性"><a href="#2-2-特性" class="headerlink" title="2.2 特性"></a>2.2 特性</h3><ul><li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li><li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li><li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li><li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li></ul><h3 id="2-3-应用场景"><a href="#2-3-应用场景" class="headerlink" title="2.3 应用场景"></a>2.3 应用场景</h3><ul><li>游戏开发</li><li>独立应用脚本</li><li>Web 应用脚本</li><li>扩展和数据库插件如：MySQL Proxy 和 MySQL WorkBench</li><li>安全系统，如入侵检测系统</li><li>redis中嵌套调用实现类似事务的功能</li><li>web容器中应用处理一些过滤 缓存等等的逻辑，例如nginx。</li></ul><h3 id="2-4-lua的安装"><a href="#2-4-lua的安装" class="headerlink" title="2.4 lua的安装"></a>2.4 lua的安装</h3><p>有linux版本的安装也有mac版本的安装。。我们采用linux版本的安装，首先我们准备一个linux虚拟机。</p><p>安装步骤,在linux系统中执行下面的命令。</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">curl</span> <span class="string">-R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span></span><br><span class="line"><span class="attr">tar</span> <span class="string">zxf lua-5.3.5.tar.gz</span></span><br><span class="line"><span class="attr">cd</span> <span class="string">lua-5.3.5</span></span><br><span class="line"><span class="attr">make</span> <span class="string">linux test</span></span><br></pre></td></tr></table></figure><p>注意：此时安装，有可能会出现如下错误：</p><p><img src="/Users/fangpeng/Document/%E7%95%85%E8%B4%AD%E5%95%86%E5%9C%BA/%E7%95%85%E8%B4%AD%E6%BA%90%E7%A0%81%E8%AF%BE%E4%BB%B6/day04/%E8%AE%B2%E4%B9%89/images/1560739143890.png" alt="1560739143890"></p><p>此时需要安装lua相关依赖库的支持，执行如下命令即可：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">yum</span> <span class="string">install libtermcap-devel ncurses-devel libevent-devel readline-devel</span></span><br></pre></td></tr></table></figure><p>此时再执行lua测试看lua是否安装成功</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">[root@localhost</span> <span class="string">~]# lua</span></span><br><span class="line"><span class="attr">Lua</span> <span class="string">5.1.4  Copyright (C) 1994-2008 Lua.org, PUC-Rio</span></span><br></pre></td></tr></table></figure><h3 id="2-5-入门程序"><a href="#2-5-入门程序" class="headerlink" title="2.5 入门程序"></a>2.5 入门程序</h3><p>创建hello.lua文件，内容为</p><p>编辑文件hello.lua</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi hello.lua</span><br></pre></td></tr></table></figure><p>在文件中输入：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">print(&quot;hello&quot;);</span><br></pre></td></tr></table></figure><p>保存并退出。</p><p>执行命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua hello.lua</span><br></pre></td></tr></table></figure><p>输出为：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello</span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src="lua-hello.png" alt="lua-hello"></p><h3 id="2-6-LUA的基本语法-了解"><a href="#2-6-LUA的基本语法-了解" class="headerlink" title="2.6 LUA的基本语法(了解)"></a>2.6 LUA的基本语法(了解)</h3><p>lua有交互式编程和脚本式编程。</p><p>交互式编程就是直接输入语法，就能执行。</p><p>脚本式编程需要编写脚本，然后再执行命令 执行脚本才可以。</p><p>一般采用脚本式编程。（例如：编写一个hello.lua的文件，输入文件内容，并执行lua hell.lua即可）</p><p>(1)交互式编程</p><p>Lua 提供了交互式编程模式。我们可以在命令行中输入程序并立即查看效果。</p><p>Lua 交互式编程模式可以通过命令 lua -i 或 lua 来启用：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua -i</span><br></pre></td></tr></table></figure><p>如下图：</p><p><img src="%E4%BA%A4%E4%BA%92%E5%BC%8F%E7%BC%96%E7%A8%8B.png" alt="交互式编程"></p><p>(2)脚本式编程</p><p>我们可以将 Lua 程序代码保持到一个以 lua 结尾的文件，并执行，该模式称为脚本式编程，例如上面入门程序中将lua语法写到hello.lua文件中。</p><h4 id="2-6-1-注释"><a href="#2-6-1-注释" class="headerlink" title="2.6.1 注释"></a>2.6.1 注释</h4><p>一行注释：两个减号是单行注释:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--</span><br></pre></td></tr></table></figure><p>多行注释：</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure><h4 id="2-6-2-定义变量"><a href="#2-6-2-定义变量" class="headerlink" title="2.6.2 定义变量"></a>2.6.2 定义变量</h4><p>全局变量，默认的情况下，定义一个变量都是全局变量，</p><p>如果要用局部变量 需要声明为local.例如：</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 全局变量赋值</span></span><br><span class="line">a=<span class="number">1</span></span><br><span class="line"><span class="comment">-- 局部变量赋值</span></span><br><span class="line"><span class="keyword">local</span> b=<span class="number">2</span> </span><br></pre></td></tr></table></figure><p>如果变量没有初始化：则 它的值为nil 这和java中的null不同。</p><p>如下图案例：</p><p><img src="%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F.png" alt="定义变量"></p><h4 id="2-6-3-Lua中的数据类型"><a href="#2-6-3-Lua中的数据类型" class="headerlink" title="2.6.3 Lua中的数据类型"></a>2.6.3 Lua中的数据类型</h4><p>Lua 是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</p><p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table。</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>nil</td><td>这个最简单，只有值nil属于该类，表示一个无效值（在条件表达式中相当于false）。</td></tr><tr><td>boolean</td><td>包含两个值：false和true。</td></tr><tr><td>number</td><td>表示双精度类型的实浮点数</td></tr><tr><td>string</td><td>字符串由一对双引号或单引号来表示</td></tr><tr><td>function</td><td>由 C 或 Lua 编写的函数</td></tr><tr><td>userdata</td><td>表示任意存储在变量中的C数据结构</td></tr><tr><td>thread</td><td>表示执行的独立线路，用于执行协同程序</td></tr><tr><td>table</td><td>Lua 中的表（table）其实是一个”关联数组”（associative arrays），数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过”构造表达式”来完成，最简单构造表达式是{}，用来创建一个空表。</td></tr></tbody></table><p>实例：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">print(type(&quot;Hello</span> <span class="string">world&quot;))      --&gt; string</span></span><br><span class="line"><span class="meta">print(type(10.4*3))</span>             <span class="string">--&gt; number</span></span><br><span class="line"><span class="meta">print(type(print))</span>              <span class="string">--&gt; function</span></span><br><span class="line"><span class="meta">print(type(type))</span>               <span class="string">--&gt; function</span></span><br><span class="line"><span class="meta">print(type(true))</span>               <span class="string">--&gt; boolean</span></span><br><span class="line"><span class="meta">print(type(nil))</span>                <span class="string">--&gt; nil</span></span><br></pre></td></tr></table></figure><h4 id="2-6-4-流程控制"><a href="#2-6-4-流程控制" class="headerlink" title="2.6.4 流程控制"></a>2.6.4 流程控制</h4><p>(1)if语句</p><p>Lua <strong>if 语句</strong> 由一个布尔表达式作为条件判断，其后紧跟其他语句组成。</p><p>语法：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">if(布尔表达式)</span></span><br><span class="line"><span class="attr">then</span></span><br><span class="line">   <span class="meta">--[</span> <span class="string">在布尔表达式为 true 时执行的语句 --]</span></span><br><span class="line"><span class="attr">end</span></span><br></pre></td></tr></table></figure><p>实例：</p><p><img src="%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6.png" alt="流程控制"></p><p>(2)if..else语句</p><p>Lua if 语句可以与 else 语句搭配使用, 在 if 条件表达式为 false 时执行 else 语句代码块。</p><p>语法：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">if(布尔表达式)</span></span><br><span class="line"><span class="attr">then</span></span><br><span class="line">   <span class="meta">--[</span> <span class="string">布尔表达式为 true 时执行该语句块 --]</span></span><br><span class="line"><span class="attr">else</span></span><br><span class="line">   <span class="meta">--[</span> <span class="string">布尔表达式为 false 时执行该语句块 --]</span></span><br><span class="line"><span class="attr">end</span></span><br></pre></td></tr></table></figure><p>实例：</p><p><img src="%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B62.png" alt="流程控制2"></p><h4 id="2-6-5-循环"><a href="#2-6-5-循环" class="headerlink" title="2.6.5 循环"></a>2.6.5 循环</h4><p>学员完成</p><p>(1)while循环[==满足条件就循环==]</p><p>Lua 编程语言中 while 循环语句在判断条件为 true 时会重复执行循环体语句。<br>语法：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">while(condition)</span></span><br><span class="line"><span class="attr">do</span></span><br><span class="line">   <span class="attr">statements</span></span><br><span class="line"><span class="attr">end</span></span><br></pre></td></tr></table></figure><p>实例：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">a</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">while(</span> <span class="string">a &lt; 20 )</span></span><br><span class="line"><span class="attr">do</span></span><br><span class="line">   <span class="meta">print(&quot;a</span> <span class="string">的值为:&quot;, a)</span></span><br><span class="line">   <span class="attr">a</span> = <span class="string">a+1</span></span><br><span class="line"><span class="attr">end</span></span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src="%E5%BE%AA%E7%8E%AF.png" alt="循环"></p><p>(2)for循环</p><p>Lua 编程语言中 for 循环语句可以重复执行指定语句，重复次数可在 for 语句中控制。</p><p>语法： 1-&gt;10 1:exp1 10:exp2 2:exp3:递增的数量</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">for</span> <span class="string">var=exp1,exp2,exp3 </span></span><br><span class="line"><span class="attr">do</span>  <span class="string"></span></span><br><span class="line">    <span class="meta">&lt;执行体&gt;</span>  <span class="string"></span></span><br><span class="line"><span class="attr">end</span>  <span class="string"></span></span><br></pre></td></tr></table></figure><p>var 从 exp1 变化到 exp2，每次变化以 exp3 为步长递增 var，并执行一次 **”执行体”**。exp3 是可选的，如果不指定，默认为1。</p><p>例子：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">for</span> <span class="string">i=1,9,2</span></span><br><span class="line"><span class="attr">do</span></span><br><span class="line">   <span class="attr">print(i)</span></span><br><span class="line"><span class="attr">end</span></span><br></pre></td></tr></table></figure><p><code>for i=1,9,2</code>:i=1从1开始循环，9循环数据到9结束，2每次递增2</p><p><img src="for%E5%BE%AA%E7%8E%AF.png" alt="for循环"></p><p>(3)repeat…until语句[==满足条件结束==]</p><p>Lua 编程语言中 repeat…until 循环语句不同于 for 和 while循环，for 和 while 循环的条件语句在当前循环执行开始时判断，而 repeat…until 循环的条件语句在当前循环结束后判断。</p><p>语法：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">repeat</span></span><br><span class="line">   <span class="attr">statements</span></span><br><span class="line"><span class="meta">until(</span> <span class="string">condition )</span></span><br></pre></td></tr></table></figure><p>案例：</p><p><img src="repeat-until.png" alt="repeat-until"></p><h4 id="2-6-6-函数"><a href="#2-6-6-函数" class="headerlink" title="2.6.6 函数"></a>2.6.6 函数</h4><p>lua中也可以定义函数，类似于java中的方法。例如：</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">--[[ 函数返回两个值的最大值 --]]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">max</span><span class="params">(num1, num2)</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (num1 &gt; num2) <span class="keyword">then</span></span><br><span class="line">      result = num1;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      result = num2;</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> result; </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 调用函数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;两值比较最大值为 &quot;</span>,<span class="built_in">max</span>(<span class="number">10</span>,<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;两值比较最大值为 &quot;</span>,<span class="built_in">max</span>(<span class="number">5</span>,<span class="number">6</span>))</span><br></pre></td></tr></table></figure><p>执行之后的结果：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">两值比较最大值为     10</span><br><span class="line">两值比较最大值为     6</span><br></pre></td></tr></table></figure><p>..:表示拼接</p><h4 id="2-6-7-表"><a href="#2-6-7-表" class="headerlink" title="2.6.7 表"></a>2.6.7 表</h4><p>table 是 Lua 的一种数据结构用来帮助我们创建不同的数据类型，如：数组、字典等。</p><p>Lua也是通过table来解决模块（module）、包（package）和对象（Object）的。</p><p>案例：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">--</span> <span class="string">初始化表</span></span><br><span class="line"><span class="attr">mytable</span> = <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">--</span> <span class="string">指定值</span></span><br><span class="line"><span class="meta">mytable[1]</span>= <span class="string">&quot;Lua&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">--</span> <span class="string">移除引用</span></span><br><span class="line"><span class="attr">mytable</span> = <span class="string">nil</span></span><br></pre></td></tr></table></figure><h4 id="2-6-7-模块"><a href="#2-6-7-模块" class="headerlink" title="2.6.7 模块"></a>2.6.7 模块</h4><p>(1)模块定义</p><p>模块类似于一个封装库，从 Lua 5.1 开始，Lua 加入了标准的模块管理机制，可以把一些公用的代码放在一个文件里，以 API 接口的形式在其他地方调用，有利于代码的重用和降低代码耦合度。</p><p>创建一个文件叫module.lua，在module.lua中创建一个独立的模块，代码如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">--</span> <span class="string">文件名为 module.lua</span></span><br><span class="line"><span class="meta">--</span> <span class="string">定义一个名为 module 的模块</span></span><br><span class="line"><span class="attr">module</span> = <span class="string">&#123;&#125;</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">--</span> <span class="string">定义一个常量</span></span><br><span class="line"><span class="meta">module.constant</span> = <span class="string">&quot;这是一个常量&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">--</span> <span class="string">定义一个函数</span></span><br><span class="line"><span class="attr">function</span> <span class="string">module.func1()</span></span><br><span class="line">    <span class="attr">print(&quot;这是一个公有函数&quot;)</span></span><br><span class="line"><span class="attr">end</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">local</span> <span class="string">function func2()</span></span><br><span class="line">    <span class="attr">print(&quot;这是一个私有函数！&quot;)</span></span><br><span class="line"><span class="attr">end</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">function</span> <span class="string">module.func3()</span></span><br><span class="line">    <span class="attr">func2()</span></span><br><span class="line"><span class="attr">end</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">return</span> <span class="string">module</span></span><br></pre></td></tr></table></figure><p>由上可知，模块的结构就是一个 table 的结构，因此可以像操作调用 table 里的元素那样来操作调用模块里的常量或函数。</p><p>上面的 func2 声明为程序块的局部变量，即表示一个私有函数，因此是不能从外部访问模块里的这个私有函数，必须通过模块里的公有函数来调用.</p><p>(2)require 函数</p><p>require 用于 引入其他的模块，类似于java中的类要引用别的类的效果。</p><p>用法：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">require(&quot;&lt;模块名&gt;&quot;)</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">require</span> <span class="string">&quot;&lt;模块名&gt;&quot;</span></span><br></pre></td></tr></table></figure><p>两种都可以。</p><p>我们可以将上面定义的module模块引入使用,创建一个test_module.lua文件，代码如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">--</span> <span class="string">test_module.lua 文件</span></span><br><span class="line"><span class="meta">--</span> <span class="string">module 模块为上文提到到 module.lua</span></span><br><span class="line"><span class="attr">require(&quot;module&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">print(module.constant)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">module.func3()</span></span><br></pre></td></tr></table></figure><h2 id="3-OpenResty介绍"><a href="#3-OpenResty介绍" class="headerlink" title="3 OpenResty介绍"></a>3 OpenResty介绍</h2><p>OpenResty(又称：ngx_openresty) 是一个基于 nginx的可伸缩的 Web 平台，由中国人章亦春发起，提供了很多高质量的第三方模块。</p><p>OpenResty 是一个强大的 Web 应用服务器，Web 开发人员可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块,更主要的是在性能方面，OpenResty可以 快速构造出足以胜任 10K 以上并发连接响应的超高性能 Web 应用系统。</p><p>360，UPYUN，阿里云，新浪，腾讯网，去哪儿网，酷狗音乐等都是 OpenResty 的深度用户。</p><p>OpenResty 简单理解成 就相当于封装了nginx,并且集成了LUA脚本，开发人员只需要简单的其提供了模块就可以实现相关的逻辑，而不再像之前，还需要在nginx中自己编写lua的脚本，再进行调用了。</p><h3 id="3-1-安装openresty"><a href="#3-1-安装openresty" class="headerlink" title="3.1 安装openresty"></a>3.1 安装openresty</h3><p>linux安装openresty:</p><p>1.添加仓库执行命令</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span><br></pre></td></tr></table></figure><p>2.执行安装</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install openresty</span><br></pre></td></tr></table></figure><p>3.安装成功后 会在默认的目录如下：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/openresty</span><br></pre></td></tr></table></figure><h3 id="3-2-安装nginx"><a href="#3-2-安装nginx" class="headerlink" title="3.2 安装nginx"></a>3.2 安装nginx</h3><p>默认已经安装好了nginx,在目录：/usr/local/openresty/nginx 下。</p><p>修改/usr/local/openresty/nginx/conf/nginx.conf,将配置文件使用的根设置为root,目的就是将来要使用lua脚本的时候 ，直接可以加载在root下的lua脚本。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/openresty/nginx/conf</span><br><span class="line">vi nginx.conf</span><br></pre></td></tr></table></figure><p>修改代码如下：</p><p><img src="Nginx%E9%85%8D%E7%BD%AE.png" alt="Nginx配置"></p><h3 id="3-3-测试访问"><a href="#3-3-测试访问" class="headerlink" title="3.3 测试访问"></a>3.3 测试访问</h3><p>重启下centos虚拟机，然后访问测试Nginx</p><p>访问地址：<code>http://192.168.211.132/</code></p><p><img src="OpenResty.png" alt="OpenResty"></p><h2 id="4-广告缓存的载入与读取"><a href="#4-广告缓存的载入与读取" class="headerlink" title="4.广告缓存的载入与读取"></a>4.广告缓存的载入与读取</h2><h3 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h3><p>需要在页面上显示广告的信息。</p><h3 id="4-2-Lua-Nginx配置"><a href="#4-2-Lua-Nginx配置" class="headerlink" title="4.2 Lua+Nginx配置"></a>4.2 Lua+Nginx配置</h3><p>(1)实现思路-查询数据放入redis中</p><p>实现思路：</p><p>定义请求：用于查询数据库中的数据更新到redis中。</p><p>a.连接mysql ，按照广告分类ID读取广告列表，转换为json字符串。</p><p>b.连接redis，将广告列表json字符串存入redis 。</p><p>定义请求：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请求：</span><br><span class="line">	/update_content</span><br><span class="line">参数：</span><br><span class="line">	id  --指定广告分类的id</span><br><span class="line">返回值：</span><br><span class="line">	json</span><br></pre></td></tr></table></figure><p>请求地址：<code>&lt;http://192.168.211.132/update_content?id=1&gt;</code></p><p>创建/root/lua目录，在该目录下创建update_content.lua： 目的就是连接mysql 查询数据 并存储到redis中。</p><p><img src="update_content.png" alt="update_content"></p><p>上图代码如下：</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.header.content_type=<span class="string">&quot;application/json;charset=utf8&quot;</span></span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span>(<span class="string">&quot;resty.mysql&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">local</span> id = uri_args[<span class="string">&quot;id&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> db = mysql:new()</span><br><span class="line">db:set_timeout(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">local</span> props = &#123;</span><br><span class="line">    host = <span class="string">&quot;192.168.211.132&quot;</span>,</span><br><span class="line">    port = <span class="number">3306</span>,</span><br><span class="line">    database = <span class="string">&quot;changgou_content&quot;</span>,</span><br><span class="line">    user = <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    password = <span class="string">&quot;123456&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res = db:connect(props)</span><br><span class="line"><span class="keyword">local</span> select_sql = <span class="string">&quot;select url,pic from tb_content where status =&#x27;1&#x27; and category_id=&quot;</span>..id..<span class="string">&quot; order by sort_order&quot;</span></span><br><span class="line">res = db:query(select_sql)</span><br><span class="line">db:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> red = redis:new()</span><br><span class="line">red:set_timeout(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ip =<span class="string">&quot;192.168.211.132&quot;</span></span><br><span class="line"><span class="keyword">local</span> port = <span class="number">6379</span></span><br><span class="line">red:connect(ip,port)</span><br><span class="line">red:set(<span class="string">&quot;content_&quot;</span>..id,cjson.encode(res))</span><br><span class="line">red:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;&#123;flag:true&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>修改/usr/local/openresty/nginx/conf/nginx.conf文件： 添加头信息，和 location信息</p><p><img src="%E6%B7%BB%E5%8A%A0update_content.png" alt="添加update_content"></p><p>代码如下：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义lua缓存命名空间，修改nginx.conf，添加如下代码即可：</p><p><img src="Nginx%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE.png" alt="Nginx缓存配置"></p><p>代码如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">lua_shared_dict</span> <span class="string">dis_cache 128m;</span></span><br></pre></td></tr></table></figure><p>请求<code>&lt;http://192.168.211.132/update_content?id=1&gt;</code>可以实现缓存的添加</p><p><img src="Nginx%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C.png" alt="Nginx缓存实现效果"></p><p>(2)实现思路-从redis中获取数据</p><p>实现思路：</p><p>定义请求，用户根据广告分类的ID 获取广告的列表。通过lua脚本直接从redis中获取数据即可。</p><p>定义请求：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请求:/read_content</span><br><span class="line">参数：id</span><br><span class="line">返回值：json</span><br></pre></td></tr></table></figure><p>在/root/lua目录下创建read_content.lua:</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">--设置响应头类型</span></span><br><span class="line">ngx.header.content_type=<span class="string">&quot;application/json;charset=utf8&quot;</span></span><br><span class="line"><span class="comment">--获取请求中的参数ID</span></span><br><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args();</span><br><span class="line"><span class="keyword">local</span> id = uri_args[<span class="string">&quot;id&quot;</span>];</span><br><span class="line"><span class="comment">--引入redis库</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>);</span><br><span class="line"><span class="comment">--创建redis对象</span></span><br><span class="line"><span class="keyword">local</span> red = redis:new()</span><br><span class="line"><span class="comment">--设置超时时间</span></span><br><span class="line">red:set_timeout(<span class="number">2000</span>)</span><br><span class="line"><span class="comment">--连接</span></span><br><span class="line"><span class="keyword">local</span> ok, err = red:connect(<span class="string">&quot;192.168.211.132&quot;</span>, <span class="number">6379</span>)</span><br><span class="line"><span class="comment">--获取key的值</span></span><br><span class="line"><span class="keyword">local</span> rescontent=red:get(<span class="string">&quot;content_&quot;</span>..id)</span><br><span class="line"><span class="comment">--输出到返回响应中</span></span><br><span class="line">ngx.say(rescontent)</span><br><span class="line"><span class="comment">--关闭连接</span></span><br><span class="line">red:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure><p>在/usr/local/openresty/nginx/conf/nginx.conf中配置如下：</p><p>如图：</p><p><img src="read_content.png" alt="read_content"></p><p>代码：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> /read_content &#123;</span><br><span class="line">     <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(3)加入openresty本地缓存</p><p>如上的方式没有问题，但是如果请求都到redis，redis压力也很大，所以我们一般采用多级缓存的方式来减少下游系统的服务压力。参考基本思路图的实现。</p><p>先查询openresty本地缓存 如果 没有</p><p>再查询redis中的数据，如果没有</p><p>再查询mysql中的数据，但凡有数据 则返回即可。</p><p>修改read_content.lua文件，代码如下：</p><p><img src="%E4%BF%AE%E6%94%B9read_content.png" alt="修改read_content"></p><p>上图代码如下：</p><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.header.content_type=<span class="string">&quot;application/json;charset=utf8&quot;</span></span><br><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args();</span><br><span class="line"><span class="keyword">local</span> id = uri_args[<span class="string">&quot;id&quot;</span>];</span><br><span class="line"><span class="comment">--获取本地缓存</span></span><br><span class="line"><span class="keyword">local</span> cache_ngx = ngx.shared.dis_cache;</span><br><span class="line"><span class="comment">--根据ID 获取本地缓存数据</span></span><br><span class="line"><span class="keyword">local</span> contentCache = cache_ngx:get(<span class="string">&#x27;content_cache_&#x27;</span>..id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> contentCache == <span class="string">&quot;&quot;</span> <span class="keyword">or</span> contentCache == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>);</span><br><span class="line">    <span class="keyword">local</span> red = redis:new()</span><br><span class="line">    red:set_timeout(<span class="number">2000</span>)</span><br><span class="line">    red:connect(<span class="string">&quot;192.168.211.132&quot;</span>, <span class="number">6379</span>)</span><br><span class="line">    <span class="keyword">local</span> rescontent=red:get(<span class="string">&quot;content_&quot;</span>..id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ngx.null == rescontent <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>);</span><br><span class="line">        <span class="keyword">local</span> mysql = <span class="built_in">require</span>(<span class="string">&quot;resty.mysql&quot;</span>);</span><br><span class="line">        <span class="keyword">local</span> db = mysql:new();</span><br><span class="line">        db:set_timeout(<span class="number">2000</span>)</span><br><span class="line">        <span class="keyword">local</span> props = &#123;</span><br><span class="line">            host = <span class="string">&quot;192.168.211.132&quot;</span>,</span><br><span class="line">            port = <span class="number">3306</span>,</span><br><span class="line">            database = <span class="string">&quot;changgou_content&quot;</span>,</span><br><span class="line">            user = <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            password = <span class="string">&quot;123456&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">local</span> res = db:connect(props);</span><br><span class="line">        <span class="keyword">local</span> select_sql = <span class="string">&quot;select url,pic from tb_content where status =&#x27;1&#x27; and category_id=&quot;</span>..id..<span class="string">&quot; order by sort_order&quot;</span>;</span><br><span class="line">        res = db:query(select_sql);</span><br><span class="line">        <span class="keyword">local</span> responsejson = cjson.encode(res);</span><br><span class="line">        red:set(<span class="string">&quot;content_&quot;</span>..id,responsejson);</span><br><span class="line">        ngx.say(responsejson);</span><br><span class="line">        db:<span class="built_in">close</span>()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        cache_ngx:set(<span class="string">&#x27;content_cache_&#x27;</span>..id, rescontent, <span class="number">10</span>*<span class="number">60</span>);</span><br><span class="line">        ngx.say(rescontent)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    red:<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    ngx.say(contentCache)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>测试地址：<code>http://192.168.211.132/update_content?id=1</code></p><p>此时会将分类ID=1的所有广告查询出来，并存入到Redis缓存。</p><p><img src="%E6%9F%A5%E5%87%BA%E6%95%B0%E6%8D%AE%E5%B9%B6%E5%86%99%E5%85%A5Redis.png" alt="查出数据并写入Redis"></p><p>测试地址：<code>http://192.168.211.132/read_content?id=1</code></p><p>此时会获取分类ID=1的所有广告信息。</p><p><img src="%E7%BC%93%E5%AD%98%E6%B5%8B%E8%AF%95.png" alt="缓存测试"></p><h2 id="5-nginx限流"><a href="#5-nginx限流" class="headerlink" title="5 nginx限流"></a>5 nginx限流</h2><p>一般情况下，首页的并发量是比较大的，即使 有了多级缓存，当用户不停的刷新页面的时候，也是没有必要的，另外如果有恶意的请求 大量达到，也会对系统造成影响。</p><p>而限流就是保护措施之一。</p><h3 id="5-1-生活中限流对比"><a href="#5-1-生活中限流对比" class="headerlink" title="5.1 生活中限流对比"></a>5.1 生活中限流对比</h3><ul><li><p>水坝泄洪，通过闸口限制洪水流量（控制流量速度）。</p></li><li><p>办理银行业务：所有人先领号，各窗口叫号处理。每个窗口处理速度根据客户具体业务而定，所有人排队等待叫号即可。若快下班时，告知客户明日再来(拒绝流量)</p></li><li><p>火车站排队买票安检，通过排队 的方式依次放入。（缓存带处理任务）</p></li></ul><h3 id="5-2-nginx的限流"><a href="#5-2-nginx的限流" class="headerlink" title="5.2 nginx的限流"></a>5.2 nginx的限流</h3><p>nginx提供两种限流的方式：</p><ul><li><p>一是控制速率</p></li><li><p>二是控制并发连接数</p></li></ul><h4 id="5-2-1-控制速率"><a href="#5-2-1-控制速率" class="headerlink" title="5.2.1 控制速率"></a>5.2.1 控制速率</h4><p>控制速率的方式之一就是采用漏桶算法。</p><ol><li>漏桶算法实现控制速率限流</li></ol><p>漏桶(Leaky Bucket)算法思路很简单,水(请求)先进入到漏桶里,漏桶以一定的速度出水(接口有响应速率),当水流入速度过大会直接溢出(访问频率超过接口响应速率),然后就拒绝请求,可以看出漏桶算法能强行限制数据的传输速率.示意图如下:</p><p><img src="%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.png" alt="漏桶算法"></p><ol start="2"><li>nginx的配置</li></ol><p>配置示意图如下：</p><p><img src="Nginx%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%A1%B6.png" alt="Nginx配置漏桶"></p><p>修改/usr/local/openresty/nginx/conf/nginx.conf:</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span>  root root;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#cache</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dis_cache <span class="number">128m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#限流设置</span></span><br><span class="line">    <span class="attribute">limit_req_zone</span> $binary_remote_addr zone=contentRateLimit:<span class="number">10m</span> rate=2r/s;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /read_content &#123;</span><br><span class="line">            <span class="comment">#使用限流配置</span></span><br><span class="line">            <span class="attribute">limit_req</span> zone=contentRateLimit;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置说明：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">binary_remote_addr 是一种key，表示基于 remote_addr(客户端IP) 来做限流，binary_ 的目的是压缩内存占用量。</span><br><span class="line">zone：定义共享内存区来存储访问信息， contentRateLimit:10m 表示一个大小为10M，名字为contentRateLimit的内存区域。1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息。</span><br><span class="line">rate 用于设置最大访问速率，rate=10r/s 表示每秒最多处理10个请求。Nginx 实际上以毫秒为粒度来跟踪请求信息，因此 10r/s 实际上是限制：每100毫秒处理一个请求。这意味着，自上一个请求处理完后，若后续100毫秒内又有请求到达，将拒绝处理该请求.我们这里设置成2 方便测试。</span><br></pre></td></tr></table></figure><p>测试：</p><p>重新加载配置文件</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">cd</span> <span class="string">/usr/local/openresty/nginx/sbin</span></span><br><span class="line"></span><br><span class="line"><span class="meta">./nginx</span> <span class="string">-s reload</span></span><br></pre></td></tr></table></figure><p>访问页面：<code>http://192.168.211.132/read_content?id=1</code> ,连续刷新会直接报错。</p><p><img src="%E8%BF%9E%E7%BB%AD%E5%88%B7%E6%96%B0%E6%8A%A5%E9%94%99.png" alt="连续刷新报错"></p><ol start="3"><li>处理突发流量</li></ol><p>上面例子限制 2r/s，如果有时正常流量突然增大，超出的请求将被拒绝，无法处理突发流量，可以结合 <strong>burst</strong> 参数使用来解决该问题。</p><p>例如，如下配置表示：</p><p><img src="Nginx%E9%85%8D%E7%BD%AE%E7%AA%81%E5%8F%91%E6%B5%81%E9%87%8F.png" alt="Nginx配置突发流量"></p><p>上图代码如下：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /read_content &#123;</span><br><span class="line">        <span class="attribute">limit_req</span> zone=contentRateLimit burst=<span class="number">4</span>;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>burst 译为突发、爆发，表示在超过设定的处理速率后能额外处理的请求数,当 rate=10r/s 时，将1s拆成10份，即每100ms可处理1个请求。</p><p>此处，**burst=4 **，若同时有4个请求到达，Nginx 会处理第一个请求，剩余3个请求将放入队列，然后每隔500ms从队列中获取一个请求进行处理。若请求数大于4，将拒绝处理多余的请求，直接返回503.</p><p>不过，单独使用 burst 参数并不实用。假设 burst=50 ，rate依然为10r/s，排队中的50个请求虽然每100ms会处理一个，但第50个请求却需要等待 50 * 100ms即 5s，这么长的处理时间自然难以接受。</p><p>因此，burst 往往结合 nodelay 一起使用。</p><p>例如：如下配置：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /read_content &#123;</span><br><span class="line">        <span class="attribute">limit_req</span> zone=contentRateLimit burst=<span class="number">4</span> nodelay;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上表示：</p><p>平均每秒允许不超过2个请求，突发不超过4个请求，并且处理突发4个请求的时候，没有延迟，等到完成之后，按照正常的速率处理。</p><p>如上两种配置结合就达到了速率稳定，但突然流量也能正常处理的效果。完整配置代码如下：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span>  root root;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#cache</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dis_cache <span class="number">128m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#限流设置</span></span><br><span class="line">    <span class="attribute">limit_req_zone</span> $binary_remote_addr zone=contentRateLimit:<span class="number">10m</span> rate=2r/s;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /read_content &#123;</span><br><span class="line">            <span class="attribute">limit_req</span> zone=contentRateLimit burst=<span class="number">4</span> nodelay;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：如下图 在1秒钟之内可以刷新4次，正常处理。</p><p><img src="Nginx%E9%99%90%E6%B5%81%E6%B5%8B%E8%AF%951.png" alt="Nginx限流测试1"></p><p>但是超过之后，连续刷新5次，抛出异常。</p><p><img src="Nginx%E9%99%90%E6%B5%81%E6%B5%8B%E8%AF%952.png" alt="Nginx限流测试2"></p><h4 id="5-2-2-控制并发量（连接数）"><a href="#5-2-2-控制并发量（连接数）" class="headerlink" title="5.2.2 控制并发量（连接数）"></a>5.2.2 控制并发量（连接数）</h4><p>ngx_http_limit_conn_module 提供了限制连接数的能力。主要是利用limit_conn_zone和limit_conn两个指令。</p><p>利用连接数限制 某一个用户的ip连接的数量来控制流量。</p><p>注意：并非所有连接都被计算在内 只有当服务器正在处理请求并且已经读取了整个请求头时，才会计算有效连接。此处忽略测试。</p><p>配置语法：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Syntax:	limit_conn zone number;</span><br><span class="line">Default: —;</span><br><span class="line">Context: http, server, location;</span><br></pre></td></tr></table></figure><ol><li>配置限制固定连接数</li></ol><p>如下，配置如下：</p><p><img src="%E9%85%8D%E7%BD%AE%E9%99%90%E5%88%B6%E5%9B%BA%E5%AE%9A%E8%BF%9E%E6%8E%A5%E6%95%B0.png" alt="配置限制固定连接数"></p><p>上图配置如下：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#cache</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dis_cache <span class="number">128m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#限流设置</span></span><br><span class="line">    <span class="attribute">limit_req_zone</span> $binary_remote_addr zone=contentRateLimit:<span class="number">10m</span> rate=2r/s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#根据IP地址来限制，存储内存大小10M</span></span><br><span class="line">    <span class="attribute">limit_conn_zone</span> $binary_remote_addr zone=addr:<span class="number">1m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="comment">#所有以brand开始的请求，访问本地changgou-service-goods微服务</span></span><br><span class="line">        <span class="attribute">location</span> /brand &#123;</span><br><span class="line">            <span class="attribute">limit_conn</span> addr <span class="number">2</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://192.168.211.1:18081;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /update_content &#123;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/update_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /read_content &#123;</span><br><span class="line">            <span class="attribute">limit_req</span> zone=contentRateLimit burst=<span class="number">4</span> nodelay;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/read_content.lua;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>表示：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone=addr:10m;  表示限制根据用户的IP地址来显示，设置存储地址为的内存大小10M</span><br><span class="line"></span><br><span class="line">limit_conn addr 2;   表示 同一个地址只允许连接2次。</span><br></pre></td></tr></table></figure><p>测试：</p><p>此时开3个线程，测试的时候会发生异常，开2个就不会有异常</p><p><img src="Jmeter%E6%B5%8B%E8%AF%95%E8%BF%9E%E6%8E%A5%E6%95%B0.png" alt="Jmeter测试连接数"></p><ol start="2"><li>限制每个客户端IP与服务器的连接数，同时限制与虚拟服务器的连接总数。(了解)</li></ol><p>如下配置：</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">limit_conn_zone</span> $binary_remote_addr zone=perip:<span class="number">10m</span>;</span><br><span class="line"><span class="attribute">limit_conn_zone</span> $server_name zone=perserver:<span class="number">10m</span>; </span><br><span class="line"><span class="section">server</span> &#123;  </span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">limit_conn</span> perip <span class="number">10</span>;<span class="comment">#单个客户端ip与服务器的连接数．</span></span><br><span class="line">        <span class="attribute">limit_conn</span> perserver <span class="number">100</span>; ＃限制与服务器的总连接数</span><br><span class="line">        <span class="attribute">root</span>   html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-canal同步广告"><a href="#6-canal同步广告" class="headerlink" title="6 canal同步广告"></a>6 canal同步广告</h2><p>canal可以用来监控数据库数据的变化，从而获得新增数据，或者修改的数据。</p><p>canal是应阿里巴巴存在杭州和美国的双机房部署，存在跨机房同步的业务需求而提出的。</p><p>阿里系公司开始逐步的尝试基于数据库的日志解析，获取增量变更进行同步，由此衍生出了增量订阅&amp;消费的业务。</p><h3 id="6-1-Canal工作原理"><a href="#6-1-Canal工作原理" class="headerlink" title="6.1 Canal工作原理"></a>6.1 Canal工作原理</h3><p><img src="Canal%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png" alt="Canal工作原理"></p><p>原理相对比较简单：</p><ol><li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li><li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li><li>canal解析binary log对象(原始为byte流)</li></ol><p>canal需要使用到mysql，我们需要先安装mysql,给大家发的虚拟机中已经安装了mysql容器，但canal是基于mysql的主从模式实现的，所以必须先开启binlog.</p><h3 id="6-2-开启binlog模式"><a href="#6-2-开启binlog模式" class="headerlink" title="6.2 开启binlog模式"></a>6.2 开启binlog模式</h3><p>先使用docker 创建mysql容器,此处不再演示.</p><ol><li>连接到mysql中,并修改/etc/mysql/mysql.conf.d/mysqld.cnf 需要开启主 从模式，开启binlog模式。</li></ol><p>执行如下命令，编辑mysql配置文件</p><p><img src="%E7%BC%96%E8%BE%91mysql%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="编辑mysql配置文件"></p><p>命令行如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">exec -it mysql /bin/bash</span></span><br><span class="line"><span class="attr">cd</span> <span class="string">/etc/mysql/mysql.conf.d</span></span><br><span class="line"><span class="attr">vi</span> <span class="string">mysqld.cnf</span></span><br></pre></td></tr></table></figure><p>修改mysqld.cnf配置文件，添加如下配置：</p><p><img src="%E4%BF%AE%E6%94%B9mysqld-cnf.png" alt="修改mysqld-cnf"></p><p>上图配置如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">log-bin/var/lib/mysql/mysql-bin</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">12345</span></span><br></pre></td></tr></table></figure><ol start="2"><li>创建账号 用于测试使用,</li></ol><p>使用root账号创建用户并授予权限</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">create</span> <span class="string">user canal@&#x27;%&#x27; IDENTIFIED by &#x27;canal&#x27;;</span></span><br><span class="line"><span class="attr">GRANT</span> <span class="string">SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27;;</span></span><br><span class="line"><span class="attr">FLUSH</span> <span class="string">PRIVILEGES;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>重启mysql容器</li></ol><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">restart mysql</span></span><br></pre></td></tr></table></figure><h3 id="6-3-canal容器安装"><a href="#6-3-canal容器安装" class="headerlink" title="6.3 canal容器安装"></a>6.3 canal容器安装</h3><p>下载镜像：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">pull docker.io/canal/canal-server</span></span><br></pre></td></tr></table></figure><p>容器安装</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">run -p 11111:11111 --name canal -d docker.io/canal/canal-server</span></span><br></pre></td></tr></table></figure><p>进入容器,修改核心配置canal.properties 和instance.properties，canal.properties 是canal自身的配置，instance.properties是需要同步数据的数据库连接配置。</p><p>执行代码如下:</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">exec -it canal /bin/bash</span></span><br><span class="line"><span class="attr">cd</span> <span class="string">canal-server/conf/</span></span><br><span class="line"><span class="attr">vi</span> <span class="string">canal.properties</span></span><br><span class="line"><span class="attr">cd</span> <span class="string">example/</span></span><br><span class="line"><span class="attr">vi</span> <span class="string">instance.properties</span></span><br></pre></td></tr></table></figure><p>修改canal.properties的id，不能和mysql的server-id重复，如下图：</p><p><img src="canal-properties.png" alt="canal-properties"></p><p>修改instance.properties,配置数据库连接地址:</p><p><img src="instance-properties.png" alt="instance-properties"></p><p>这里的<code>canal.instance.filter.regex</code>有多种配置，如下：</p><p>可以参考地址如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/alibaba/canal/wiki/AdminGuide</span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">mysql</span> <span class="string">数据解析关注的表，Perl正则表达式.</span></span><br><span class="line"><span class="meta">多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\)</span> <span class="string"></span></span><br><span class="line"><span class="attr">常见例子：</span></span><br><span class="line"><span class="meta">1.</span>  <span class="string">所有表：.*   or  .*\\..*</span></span><br><span class="line"><span class="meta">2.</span>  <span class="string">canal schema下所有表： canal\\..*</span></span><br><span class="line"><span class="meta">3.</span>  <span class="string">canal下的以canal打头的表：canal\\.canal.*</span></span><br><span class="line"><span class="meta">4.</span>  <span class="string">canal schema下的一张表：canal.test1</span></span><br><span class="line"><span class="meta">5.</span>  <span class="string">多个规则组合使用：canal\\..*,mysql.test1,mysql.test2 (逗号分隔)</span></span><br><span class="line"><span class="meta">注意：此过滤条件只针对row模式的数据有效(ps.</span> <span class="string">mixed/statement因为不解析sql，所以无法准确提取tableName进行过滤)</span></span><br></pre></td></tr></table></figure><p>配置完成后，设置开机启动，并记得重启canal。</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">update --restart=always canal</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">restart canal</span></span><br></pre></td></tr></table></figure><h3 id="6-4-canal微服务搭建"><a href="#6-4-canal微服务搭建" class="headerlink" title="6.4 canal微服务搭建"></a>6.4 canal微服务搭建</h3><p> 当用户执行 数据库的操作的时候，binlog 日志会被canal捕获到，并解析出数据。我们就可以将解析出来的数据进行同步到redis中即可。</p><p>思路：创建一个独立的程序，并监控canal服务器，获取binlog日志，解析数据，将数据更新到redis中。这样广告的数据就更新了。</p><ol><li>安装辅助jar包</li></ol><p>在<code>canal\spring-boot-starter-canal-master</code>中有一个工程<code>starter-canal</code>，它主要提供了SpringBoot环境下<code>canal</code>的支持，我们需要先安装该工程，在<code>starter-canal</code>目录下执行<code>mvn install</code>，如下图：</p><p>地址：<a target="_blank" rel="noopener" href="https://github.com/chenqian56131/spring-boot-starter-canal">https://github.com/chenqian56131/spring-boot-starter-canal</a></p><p><img src="%E5%AE%89%E8%A3%85%E8%BE%85%E5%8A%A9jar%E5%8C%85.png" alt="安装辅助jar包"></p><ol start="2"><li>canal微服务工程搭建</li></ol><p>在changgou-service下创建changgou-service-canal工程，并引入相关配置。</p><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-canal<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--canal依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xpand<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>starter-canal<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml配置</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">18082</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">canal</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="comment">#hystrix 配置</span></span><br><span class="line"><span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">command</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">default</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">execution</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">timeout</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #如果enabled设置为false，则请求超时交给ribbon控制</span></span><br><span class="line">          <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line">        <span class="attr">isolation</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">strategy</span>: <span class="string">SEMAPHORE</span></span><br><span class="line"><span class="comment">#canal配置</span></span><br><span class="line"><span class="attr">canal</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">instances</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">example</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">host</span>: <span class="string">192.168.211.132</span></span><br><span class="line">        <span class="attr">port</span>: <span class="string">11111</span></span><br></pre></td></tr></table></figure><p>(3)监听创建</p><p>创建一个CanalDataEventListener类，实现对表增删改操作的监听，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.changgou.canal.listener;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry;</span><br><span class="line"><span class="keyword">import</span> com.xpand.starter.canal.annotation.*;</span><br><span class="line"><span class="meta">@CanalEventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalDataEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 增加数据监听</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@InsertListenPoint</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventInsert</span><span class="params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span> </span>&#123;</span><br><span class="line">        rowData.getAfterColumnsList().forEach((c) -&gt; System.out.println(<span class="string">&quot;By--Annotation: &quot;</span> + c.getName() + <span class="string">&quot; ::   &quot;</span> + c.getValue()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 修改数据监听</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@UpdateListenPoint</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventUpdate</span><span class="params">(CanalEntry.RowData rowData)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UpdateListenPoint&quot;</span>);</span><br><span class="line">        rowData.getAfterColumnsList().forEach((c) -&gt; System.out.println(<span class="string">&quot;By--Annotation: &quot;</span> + c.getName() + <span class="string">&quot; ::   &quot;</span> + c.getValue()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 删除数据监听</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteListenPoint</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventDelete</span><span class="params">(CanalEntry.EventType eventType)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DeleteListenPoint&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 自定义数据修改监听</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ListenPoint(destination = &quot;example&quot;, schema = &quot;changgou_content&quot;, table = &#123;&quot;tb_content_category&quot;, &quot;tb_content&quot;&#125;, eventType = CanalEntry.EventType.UPDATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventCustomUpdate</span><span class="params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;DeleteListenPoint&quot;</span>);</span><br><span class="line">        rowData.getAfterColumnsList().forEach((c) -&gt; System.out.println(<span class="string">&quot;By--Annotation: &quot;</span> + c.getName() + <span class="string">&quot; ::   &quot;</span> + c.getValue()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>启动类创建</li></ol><p>在com.changgou中创建启动类，代码如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude</span>=<span class="string">&#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="attr">@EnableEurekaClient</span></span><br><span class="line"><span class="attr">@EnableCanalClient</span></span><br><span class="line"><span class="attr">public</span> <span class="string">class CanalApplication &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">public</span> <span class="string">static void main(String[] args) &#123;</span></span><br><span class="line">        <span class="attr">SpringApplication.run(CanalApplication.class,args);</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ol start="5"><li>测试</li></ol><p>启动canal微服务，然后修改任意数据库的表数据，canal微服务后台输出如下：</p><p><img src="canal%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95.png" alt="canal微服务测试"></p><h3 id="6-5-广告同步"><a href="#6-5-广告同步" class="headerlink" title="6.5 广告同步"></a>6.5 广告同步</h3><p><img src="%E5%B9%BF%E5%91%8A%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B.png" alt="广告同步流程"></p><p>如上图，每次执行广告操作的时候，会记录操作日志到，然后将操作日志发送给canal，canal将操作记录发送给canal微服务，canal微服务根据修改的分类ID调用content微服务查询分类对应的所有广告，canal微服务再将所有广告存入到Redis缓存。</p><h4 id="6-5-1-content微服务搭建"><a href="#6-5-1-content微服务搭建" class="headerlink" title="6.5.1 content微服务搭建"></a>6.5.1 content微服务搭建</h4><p>在changgou-service中搭建changgou-service-content微服务，对应的dao、service、controller、pojo由代码生成器生成。</p><p>首先在changgou-service-api中创建changgou-service-content-api,将pojo拷贝到API工程中。</p><ol><li>pom.xml配置</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-content<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.changgou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>changgou-service-content-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>application.yml配置</li></ol><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">18084</span></span><br><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">content</span></span><br><span class="line">  <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">jdbc:mysql://192.168.211.132:3306/changgou_content?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line"><span class="attr">eureka</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">service-url</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">defaultZone</span>: <span class="string">http://127.0.0.1:7001/eureka</span></span><br><span class="line">  <span class="attr">instance</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">prefer-ip-address</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">feign</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="attr">mybatis</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">configuration</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">map-underscore-to-camel-case</span>: <span class="string">true  #开启驼峰功能</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#hystrix 配置</span></span><br><span class="line"><span class="attr">hystrix</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">command</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">default</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">execution</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">timeout</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        #如果enabled设置为false，则请求超时交给ribbon控制</span></span><br><span class="line">          <span class="attr">enabled</span>: <span class="string">true</span></span><br><span class="line">        <span class="attr">isolation</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">strategy</span>: <span class="string">SEMAPHORE</span></span><br></pre></td></tr></table></figure><ol start="3"><li>启动类创建</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &#123;&quot;com.changgou.content.dao&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ContentApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-5-2-广告查询"><a href="#6-5-2-广告查询" class="headerlink" title="6.5.2 广告查询"></a>6.5.2 广告查询</h4><p>在content微服务中，添加根据分类查询广告。</p><ol><li>业务层</li></ol><p>修改changgou-service-content的com.changgou.content.service.ContentService接口，添加根据分类ID查询广告数据，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据categoryId查询广告集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">List&lt;Content&gt; <span class="title">findByCategory</span><span class="params">(Long id)</span></span>;</span><br></pre></td></tr></table></figure><p>修改changgou-service-content的com.changgou.content.service.impl.ContentServiceImpl接口实现类，添加根据分类ID查询广告数据，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据分类ID查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Content&gt; <span class="title">findByCategory</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    Content content = <span class="keyword">new</span> Content();</span><br><span class="line">    content.setCategoryId(id);</span><br><span class="line">    content.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> contentMapper.select(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>控制层</li></ol><p>修改changgou-service-content的com.changgou.content.controller.ContentController,添加根据分类ID查询广告数据，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据categoryId查询广告集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/list/category/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;Content&gt;&gt; findByCategory(<span class="meta">@PathVariable</span> Long id)&#123;</span><br><span class="line">    <span class="comment">//根据分类ID查询广告集合</span></span><br><span class="line">    List&lt;Content&gt; contents = contentService.findByCategory(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;List&lt;Content&gt;&gt;(<span class="keyword">true</span>,StatusCode.OK,<span class="string">&quot;查询成功！&quot;</span>,contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>feign配置</li></ol><p>在changgou-service-content-api工程中添加feign，代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name=&quot;content&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/content&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ContentFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 根据分类ID查询所有广告</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/list/category/&#123;id&#125;&quot;)</span></span><br><span class="line">    Result&lt;List&lt;Content&gt;&gt; findByCategory(<span class="meta">@PathVariable</span> Long id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-5-3-同步实现"><a href="#6-5-3-同步实现" class="headerlink" title="6.5.3 同步实现"></a>6.5.3 同步实现</h4><p>在canal微服务中修改如下:</p><ol><li>配置redis</li></ol><p>修改application.yml配置文件，添加redis配置，如下代码：</p><p><img src="%E9%85%8D%E7%BD%AEredis.png" alt="配置redis"></p><ol start="2"><li>启动类中开启feign</li></ol><p>修改CanalApplication，添加<code>@EnableFeignClients</code>注解，代码如下：</p><p><img src="%E5%BC%80%E5%90%AFFeign.png" alt="开启Feign"></p><ol start="3"><li>同步实现</li></ol><p>修改监听类CanalDataEventListener，实现监听广告的增删改，并根据增删改的数据使用feign查询对应分类的所有广告，将广告存入到Redis中，代码如下：</p><p>上图代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CanalEventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalDataEventListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ContentFeign contentFeign;</span><br><span class="line">    <span class="comment">//字符串</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义数据库的 操作来监听</span></span><br><span class="line">    <span class="comment">//destination = &quot;example&quot;</span></span><br><span class="line">    <span class="meta">@ListenPoint(destination = &quot;example&quot;,</span></span><br><span class="line"><span class="meta">            schema = &quot;changgou_content&quot;,</span></span><br><span class="line"><span class="meta">            table = &#123;&quot;tb_content&quot;, &quot;tb_content_category&quot;&#125;,</span></span><br><span class="line"><span class="meta">            eventType = &#123;</span></span><br><span class="line"><span class="meta">                    CanalEntry.EventType.UPDATE,</span></span><br><span class="line"><span class="meta">                    CanalEntry.EventType.DELETE,</span></span><br><span class="line"><span class="meta">                    CanalEntry.EventType.INSERT&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventCustomUpdate</span><span class="params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.获取列名 为category_id的值</span></span><br><span class="line">        String categoryId = getColumnValue(eventType, rowData);</span><br><span class="line">        <span class="comment">//2.调用feign 获取该分类下的所有的广告集合</span></span><br><span class="line">        Result&lt;List&lt;Content&gt;&gt; categoryresut = contentFeign.findByCategory(Long.valueOf(categoryId));</span><br><span class="line">        List&lt;Content&gt; data = categoryresut.getData();</span><br><span class="line">        <span class="comment">//3.使用redisTemplate存储到redis中</span></span><br><span class="line">        stringRedisTemplate.boundValueOps(<span class="string">&quot;content_&quot;</span> + categoryId).set(JSON.toJSONString(data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getColumnValue</span><span class="params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span> </span>&#123;</span><br><span class="line">        String categoryId = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//判断 如果是删除  则获取beforlist</span></span><br><span class="line">        <span class="keyword">if</span> (eventType == CanalEntry.EventType.DELETE) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CanalEntry.Column column : rowData.getBeforeColumnsList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (column.getName().equalsIgnoreCase(<span class="string">&quot;category_id&quot;</span>)) &#123;</span><br><span class="line">                    categoryId = column.getValue();</span><br><span class="line">                    <span class="keyword">return</span> categoryId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//判断 如果是添加 或者是更新 获取afterlist</span></span><br><span class="line">            <span class="keyword">for</span> (CanalEntry.Column column : rowData.getAfterColumnsList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (column.getName().equalsIgnoreCase(<span class="string">&quot;category_id&quot;</span>)) &#123;</span><br><span class="line">                    categoryId = column.getValue();</span><br><span class="line">                    <span class="keyword">return</span> categoryId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> categoryId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试：</p><p>修改数据库数据，可以看到Redis中的缓存跟着一起变化</p><p><img src="%E5%B9%BF%E5%91%8A%E5%90%8C%E6%AD%A5%E6%B5%8B%E8%AF%95.png" alt="广告同步测试"></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">空白格</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://lemon-cs.github.io/2020/03/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%9B%9B%EF%BC%89/">https://lemon-cs.github.io/2020/03/12/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E5%9B%9B%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lemon-cs.github.io" target="_blank">Lemon-CS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></div><div class="post_share"><div class="social-share" data-image="/./images/colorhub.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/13/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%94%EF%BC%89/"><img class="prev-cover" src="/./images/colorhub.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">畅购商城（五）之商品搜索</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/11/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%89%EF%BC%89/"><img class="next-cover" src="/./images/clouds.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">畅购商城（三）之商品微服务</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/03/04/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="畅购商城（一）之框架搭建"><img class="cover" src="/./images/village.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-04</div><div class="title">畅购商城（一）之框架搭建</div></div></a></div><div><a href="/2020/03/15/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%83%EF%BC%89/" title="畅购商城（七）之静态页面"><img class="cover" src="/./images/scotland.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-15</div><div class="title">畅购商城（七）之静态页面</div></div></a></div><div><a href="/2020/03/11/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%89%EF%BC%89/" title="畅购商城（三）之商品微服务"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-11</div><div class="title">畅购商城（三）之商品微服务</div></div></a></div><div><a href="/2020/03/17/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%B9%9D%EF%BC%89/" title="畅购商城（九）之权限验证"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-17</div><div class="title">畅购商城（九）之权限验证</div></div></a></div><div><a href="/2020/03/07/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%8C%EF%BC%89/" title="畅购商城（二）之分布式文件存储"><img class="cover" src="/./images/clouds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-07</div><div class="title">畅购商城（二）之分布式文件存储</div></div></a></div><div><a href="/2020/03/13/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%94%EF%BC%89/" title="畅购商城（五）之商品搜索"><img class="cover" src="/./images/colorhub.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-13</div><div class="title">畅购商城（五）之商品搜索</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81NTAxNC8zMTQ4Mg=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./images/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">空白格</div><div class="author-info__description">杯中的水是亮闪闪的,海里的水是黑沉沉的!</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lemon-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lemon-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:591930734@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到Lemon-CS</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-lua%E3%80%81Canal%E5%AE%9E%E7%8E%B0%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">第4章 lua、Canal实现广告缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">学习目标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%A6%96%E9%A1%B5%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">1 首页分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Lua-%E4%BA%86%E8%A7%A3"><span class="toc-number">2.2.</span> <span class="toc-text">2 Lua(了解)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-lua%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 lua是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%89%B9%E6%80%A7"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3 应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-lua%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4 lua的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%85%A5%E9%97%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5 入门程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-LUA%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-%E4%BA%86%E8%A7%A3"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.6 LUA的基本语法(了解)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-%E6%B3%A8%E9%87%8A"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">2.6.1 注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">2.6.2 定义变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-3-Lua%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.6.3.</span> <span class="toc-text">2.6.3 Lua中的数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-4-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">2.2.6.4.</span> <span class="toc-text">2.6.4 流程控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-5-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.2.6.5.</span> <span class="toc-text">2.6.5 循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-6-%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.6.6.</span> <span class="toc-text">2.6.6 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-7-%E8%A1%A8"><span class="toc-number">2.2.6.7.</span> <span class="toc-text">2.6.7 表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-7-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.2.6.8.</span> <span class="toc-text">2.6.7 模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-OpenResty%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.</span> <span class="toc-text">3 OpenResty介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%89%E8%A3%85openresty"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 安装openresty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AE%89%E8%A3%85nginx"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 安装nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 测试访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98%E7%9A%84%E8%BD%BD%E5%85%A5%E4%B8%8E%E8%AF%BB%E5%8F%96"><span class="toc-number">2.4.</span> <span class="toc-text">4.广告缓存的载入与读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Lua-Nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 Lua+Nginx配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-nginx%E9%99%90%E6%B5%81"><span class="toc-number">2.5.</span> <span class="toc-text">5 nginx限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E7%94%9F%E6%B4%BB%E4%B8%AD%E9%99%90%E6%B5%81%E5%AF%B9%E6%AF%94"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1 生活中限流对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-nginx%E7%9A%84%E9%99%90%E6%B5%81"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 nginx的限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E6%8E%A7%E5%88%B6%E9%80%9F%E7%8E%87"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">5.2.1 控制速率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E6%8E%A7%E5%88%B6%E5%B9%B6%E5%8F%91%E9%87%8F%EF%BC%88%E8%BF%9E%E6%8E%A5%E6%95%B0%EF%BC%89"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">5.2.2 控制并发量（连接数）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-canal%E5%90%8C%E6%AD%A5%E5%B9%BF%E5%91%8A"><span class="toc-number">2.6.</span> <span class="toc-text">6 canal同步广告</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Canal%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.6.1.</span> <span class="toc-text">6.1 Canal工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%BC%80%E5%90%AFbinlog%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.6.2.</span> <span class="toc-text">6.2 开启binlog模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-canal%E5%AE%B9%E5%99%A8%E5%AE%89%E8%A3%85"><span class="toc-number">2.6.3.</span> <span class="toc-text">6.3 canal容器安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-canal%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA"><span class="toc-number">2.6.4.</span> <span class="toc-text">6.4 canal微服务搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E5%B9%BF%E5%91%8A%E5%90%8C%E6%AD%A5"><span class="toc-number">2.6.5.</span> <span class="toc-text">6.5 广告同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-content%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA"><span class="toc-number">2.6.5.1.</span> <span class="toc-text">6.5.1 content微服务搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E5%B9%BF%E5%91%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.6.5.2.</span> <span class="toc-text">6.5.2 广告查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-3-%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.6.5.3.</span> <span class="toc-text">6.5.3 同步实现</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/21/hello-world/" title="Hello World"><img src="/./images/backgroud.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Hello World"></a><div class="content"><a class="title" href="/2021/12/21/hello-world/" title="Hello World">Hello World</a><time datetime="2021-12-21T02:50:12.155Z" title="发表于 2021-12-21 10:50:12">2021-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/05/test/" title="test"><img src="/./images/clouds.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="test"></a><div class="content"><a class="title" href="/2021/01/05/test/" title="test">test</a><time datetime="2021-01-04T16:00:00.000Z" title="发表于 2021-01-05 00:00:00">2021-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计"><img src="/./images/village.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="分布式接口和API设计"></a><div class="content"><a class="title" href="/2020/06/16/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%92%8CAPI%E8%AE%BE%E8%AE%A1/" title="分布式接口和API设计">分布式接口和API设计</a><time datetime="2020-06-16T15:38:30.000Z" title="发表于 2020-06-16 23:38:30">2020-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列"><img src="/./images/colorhub.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis实战系列"></a><div class="content"><a class="title" href="/2020/06/14/Redis%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97/" title="Redis实战系列">Redis实战系列</a><time datetime="2020-06-14T08:55:40.000Z" title="发表于 2020-06-14 16:55:40">2020-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型"><img src="/./images/colorhub.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="IO模型"></a><div class="content"><a class="title" href="/2020/06/07/IO%E6%A8%A1%E5%9E%8B/" title="IO模型">IO模型</a><time datetime="2020-06-07T13:20:12.000Z" title="发表于 2020-06-07 21:20:12">2020-06-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 空白格</div><div class="footer_custom_text">欢迎来到Lemon-CS</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadLivere(){var e,t,o,r;"object"==typeof LivereTower?window.LivereTower.init():(e=document,t="script",r=e.getElementsByTagName(t)[0],"function"!=typeof LivereTower&&((o=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",o.async=!0,r.parentNode.insertBefore(o,r)))}function loadOtherComment(){loadLivere()}loadLivere()</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (true) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>